<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Espa√±a 2026">
<meta name="theme-color" content="#1B3C8C">
<title>Espa√±a 2026</title>
<link rel="apple-touch-icon" href="icon-180.png">
<link rel="icon" type="image/png" href="icon-180.png">
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
  *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  :root{
    --safe-top:env(safe-area-inset-top,20px);--safe-bottom:env(safe-area-inset-bottom,0px);
    --red:#D71920;--red-soft:rgba(215,25,32,0.08);
    --blue:#1B3C8C;
    --white:#fff;--bg:#f5f5f7;--card:#fff;--card-hover:#f8f8fa;
    --text:#1d1d1f;--dim:#86868b;--border:rgba(0,0,0,0.06);
    --r:20px;--accent-gradient:linear-gradient(135deg,#D71920,#E8364F);
    --f1-gradient:linear-gradient(135deg,#E8364F,#ff6b35);
  }
  body{font-family:'Inter',-apple-system,system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100dvh;overflow-x:hidden;-webkit-font-smoothing:antialiased}

  /* SYNC */
  .sync{position:fixed;top:calc(var(--safe-top)+6px);left:50%;transform:translateX(-50%);z-index:200;padding:5px 14px;border-radius:20px;font-size:11px;font-weight:600;letter-spacing:.3px;backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);animation:fadeDown .5s cubic-bezier(.16,1,.3,1)}
  @keyframes fadeDown{from{opacity:0;transform:translateX(-50%) translateY(-12px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
  .sync.on{background:rgba(52,199,89,.1);color:#34c759;border:1px solid rgba(52,199,89,.15)}
  .sync.off{background:rgba(134,134,139,.08);color:var(--dim);border:1px solid rgba(134,134,139,.1)}

  /* HERO ‚Äî card style */
  .hero-safe{padding-top:calc(var(--safe-top)+56px);background:var(--bg)}
  .hero{margin:0 16px;padding:20px;background:linear-gradient(160deg,#0f1b3d 0%,#1B3C8C 40%,#2952b0 100%);border-radius:var(--r);position:relative;overflow:hidden;box-shadow:0 4px 24px rgba(27,60,140,.25)}
  .hero::before{content:'';position:absolute;top:-30%;right:-20%;width:70%;height:80%;background:radial-gradient(circle,rgba(215,25,32,.08),transparent 70%);pointer-events:none}
  .hero-row{display:flex;align-items:center;justify-content:space-between}
  .hero h1{font-size:24px;font-weight:900;letter-spacing:-.6px;color:#fff;line-height:1.1}
  .hero h1 .yr{background:var(--accent-gradient);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
  .hero .sub{font-size:11px;color:rgba(255,255,255,.45);font-weight:500;margin-top:4px;letter-spacing:.3px}
  .share-btn{width:36px;height:36px;border-radius:12px;border:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.06);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);color:#fff;font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s}
  .share-btn:active{transform:scale(.9);background:rgba(255,255,255,.15)}

  /* COUNTDOWN */
  .cd-row{display:flex;align-items:center;gap:12px;margin-top:14px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:12px 14px}
  .cd-num{font-size:32px;font-weight:900;color:#fff;line-height:1;min-width:44px;text-align:center;background:var(--accent-gradient);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
  .cd-label{font-size:12px;font-weight:700;color:rgba(255,255,255,.85)}
  .cd-sub{font-size:10px;color:rgba(255,255,255,.4);margin-top:2px}
  .cd-live{display:inline-flex;align-items:center;gap:5px;font-size:9px;font-weight:800;color:#4ade80;letter-spacing:.5px;text-transform:uppercase}
  .cd-live::before{content:'';width:5px;height:5px;border-radius:50%;background:#4ade80;animation:pulse 1.5s ease infinite}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

  /* ROUTE */
  .route-wrap{margin-top:12px}
  .route-lbl{font-size:9px;font-weight:700;color:rgba(255,255,255,.3);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:5px}
  .route-bar{display:flex;gap:2px;border-radius:10px;overflow:hidden;height:24px;background:rgba(0,0,0,.15)}
  .route-seg{height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:7px;font-weight:800;color:rgba(255,255,255,.9);letter-spacing:.1px;overflow:hidden;line-height:1.2;min-width:0;padding:0 3px;transition:all .2s}
  .route-seg .seg-dates{font-size:6px;font-weight:600;color:rgba(255,255,255,.5)}

  /* FILTERS */
  .filters{display:flex;gap:5px;flex-wrap:wrap;margin-top:12px}
  .fil{display:flex;align-items:center;gap:4px;font-size:10px;font-weight:600;color:rgba(255,255,255,.4);cursor:pointer;padding:5px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.06);transition:all .15s;background:rgba(255,255,255,.03)}
  .fil:active{transform:scale(.95)}
  .fil.on{color:#fff;background:rgba(255,255,255,.1);border-color:rgba(255,255,255,.15)}
  .fil .fdot{width:6px;height:6px;border-radius:50%}

  /* SECTION CARD */
  .section{margin:16px 16px 0;background:var(--card);border-radius:var(--r);box-shadow:0 1px 8px rgba(0,0,0,.04)}
  .section:last-child{margin-bottom:120px}

  /* CALENDAR (city-visual style) */
  .cal-title{padding:18px 20px 14px;display:flex;align-items:center;justify-content:space-between}
  .cal-month{font-size:17px;font-weight:800;color:var(--text)}
  .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);text-align:center;padding:0 6px;gap:2px}
  .cal-hdr{font-size:10px;font-weight:700;color:var(--dim);padding-bottom:6px;text-transform:uppercase;letter-spacing:.5px}
  .cal-cell{position:relative;padding:6px 2px 5px;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:2px;border-radius:10px;transition:all .12s;min-height:54px}
  .cal-cell:active{transform:scale(.95)}
  .cal-cell.sel{box-shadow:0 0 0 2px var(--red)}
  .cal-cell.today .cal-num{background:var(--blue);color:#fff}
  .cal-cell.sel:not(.today) .cal-num{background:var(--red);color:#fff}
  .cal-num{width:26px;height:26px;display:flex;align-items:center;justify-content:center;border-radius:50%;font-size:12px;font-weight:600;color:var(--dim);transition:all .12s;z-index:2}
  .cal-cell.trip .cal-num{color:var(--text);font-weight:700}
  .cal-cell.empty .cal-num{color:#d2d2d7}
  .cal-city-bar{font-size:8px;font-weight:800;letter-spacing:.2px;color:#fff;padding:2px 4px;border-radius:4px;white-space:nowrap;overflow:hidden;max-width:100%;text-overflow:ellipsis;line-height:1.3}
  .cal-split{display:flex;border-radius:4px;overflow:hidden;max-width:100%;gap:1px}
  .cal-split-half{font-size:6px;font-weight:800;color:#fff;padding:2px 1px;flex:1;text-align:center;white-space:nowrap;line-height:1.4}
  .cal-icon{font-size:10px;line-height:1}
  .cal-divider{height:1px;background:var(--border);margin:0 20px 8px}
  .cal-legend{display:flex;gap:10px;padding:2px 20px 12px;flex-wrap:wrap}
  .cal-leg-item{display:flex;align-items:center;gap:4px;font-size:10px;font-weight:700;color:var(--dim)}
  .cal-leg-dot{width:8px;height:8px;border-radius:3px}

  /* WEATHER (inline under calendar) */
  .wx-row{display:flex;gap:4px;padding:4px 12px 16px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none}
  .wx-row::-webkit-scrollbar{display:none}
  .wx{display:flex;flex-direction:column;align-items:center;gap:1px;min-width:44px;padding:6px 4px;border-radius:10px;background:var(--bg)}
  .wx-d{font-size:9px;font-weight:700;color:var(--dim)}
  .wx-i{font-size:14px}
  .wx-t{font-size:10px;font-weight:800;color:var(--text)}

  /* F1 SECTION INSIDE HERO */
  .f1-section{margin-top:14px;background:rgba(0,0,0,.35);border-radius:14px;position:relative;overflow:hidden}
  .f1-carbon{position:absolute;inset:0;background:repeating-linear-gradient(45deg,transparent,transparent 2px,rgba(255,255,255,.015) 2px,rgba(255,255,255,.015) 4px);pointer-events:none}
  .f1-glow-rb{position:absolute;top:-40%;left:-10%;width:50%;height:180%;background:radial-gradient(ellipse,rgba(30,65,175,.2),transparent 70%);pointer-events:none}
  .f1-glow-fer{position:absolute;top:-40%;right:-10%;width:50%;height:180%;background:radial-gradient(ellipse,rgba(220,0,0,.2),transparent 70%);pointer-events:none}
  .f1-top{position:relative;z-index:2;padding:14px 14px 0;display:flex;align-items:center;justify-content:space-between}
  .f1-gp{font-size:9px;font-weight:900;letter-spacing:2px;text-transform:uppercase;color:rgba(255,255,255,.45)}
  .f1-title{font-size:16px;font-weight:900;letter-spacing:-.3px;margin-top:1px}
  .f1-title .vs{color:#ff3333;font-style:italic}
  .f1-badge{display:inline-flex;align-items:center;gap:4px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.1);padding:4px 10px;border-radius:8px;font-size:9px;font-weight:800;letter-spacing:.3px;white-space:nowrap}

  /* RACE TRACK ANIMATION */
  .f1-track{position:relative;z-index:2;height:56px;margin:10px 14px 0;overflow:hidden}
  .f1-road{position:absolute;bottom:0;left:0;right:0;height:30px;background:linear-gradient(180deg,#2a2a2a,#1a1a1a);border-radius:8px}
  .f1-road::before{content:'';position:absolute;top:50%;left:0;right:0;height:2px;background:repeating-linear-gradient(90deg,rgba(255,255,255,.5) 0px,rgba(255,255,255,.5) 20px,transparent 20px,transparent 40px);transform:translateY(-1px);animation:roadMove 1s linear infinite}
  @keyframes roadMove{0%{transform:translateX(0) translateY(-1px)}100%{transform:translateX(-40px) translateY(-1px)}}
  .f1-road::after{content:'';position:absolute;bottom:0;left:0;right:0;height:3px;background:repeating-linear-gradient(90deg,#dc0000 0px,#dc0000 12px,#fff 12px,#fff 24px)}
  .f1-car-rb,.f1-car-fer{position:absolute;bottom:2px;font-size:24px;z-index:3;filter:drop-shadow(0 2px 8px rgba(0,0,0,.5))}
  .f1-car-rb{left:48%;animation:carRB 3s ease-in-out infinite}
  .f1-car-fer{left:42%;animation:carFER 3s ease-in-out infinite}
  @keyframes carRB{0%,100%{transform:translateX(0)}25%{transform:translateX(12px)}50%{transform:translateX(-6px)}75%{transform:translateX(8px)}}
  @keyframes carFER{0%,100%{transform:translateX(0)}25%{transform:translateX(-8px)}50%{transform:translateX(14px)}75%{transform:translateX(-4px)}}
  .f1-sparks{position:absolute;bottom:4px;width:3px;height:3px;border-radius:50%;background:#ffd700;animation:spark .4s ease-out infinite;z-index:4}
  @keyframes spark{0%{opacity:1;transform:scale(1)}100%{opacity:0;transform:scale(0) translateY(-6px)}}
  .f1-trail-rb,.f1-trail-fer{position:absolute;bottom:10px;height:4px;border-radius:2px;z-index:2;animation:trailPulse 1.5s ease-in-out infinite alternate}
  .f1-trail-rb{right:52%;width:60px;background:linear-gradient(90deg,transparent,rgba(30,65,175,.6))}
  .f1-trail-fer{right:56%;width:50px;background:linear-gradient(90deg,transparent,rgba(220,0,0,.5));animation-delay:.3s}
  @keyframes trailPulse{0%{opacity:.4;width:40px}100%{opacity:.8;width:65px}}

  /* STARTING LIGHTS ‚Äî real F1: lights on one by one, then ALL out at once */
  .f1-lights{position:absolute;top:4px;right:10px;display:flex;gap:4px;z-index:5}
  .f1-light{width:8px;height:8px;border-radius:50%;background:#333;border:1px solid #555}
  .f1-light:nth-child(1){animation:f1L1 6s ease infinite}
  .f1-light:nth-child(2){animation:f1L2 6s ease infinite}
  .f1-light:nth-child(3){animation:f1L3 6s ease infinite}
  .f1-light:nth-child(4){animation:f1L4 6s ease infinite}
  .f1-light:nth-child(5){animation:f1L5 6s ease infinite}
  @keyframes f1L1{0%,9%{background:#333;box-shadow:none}10%,59%{background:#dc0000;box-shadow:0 0 8px #dc0000}60%,100%{background:#333;box-shadow:none}}
  @keyframes f1L2{0%,19%{background:#333;box-shadow:none}20%,59%{background:#dc0000;box-shadow:0 0 8px #dc0000}60%,100%{background:#333;box-shadow:none}}
  @keyframes f1L3{0%,29%{background:#333;box-shadow:none}30%,59%{background:#dc0000;box-shadow:0 0 8px #dc0000}60%,100%{background:#333;box-shadow:none}}
  @keyframes f1L4{0%,39%{background:#333;box-shadow:none}40%,59%{background:#dc0000;box-shadow:0 0 8px #dc0000}60%,100%{background:#333;box-shadow:none}}
  @keyframes f1L5{0%,49%{background:#333;box-shadow:none}50%,59%{background:#dc0000;box-shadow:0 0 8px #dc0000}60%,100%{background:#333;box-shadow:none}}

  /* SCHEDULE ROW */
  .f1-sched{position:relative;z-index:2;display:flex;gap:4px;padding:10px 14px 14px}
  .f1-sess{flex:1;text-align:center;padding:8px 4px;border-radius:10px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06)}
  .f1-sess.active{background:rgba(220,0,0,.12);border-color:rgba(220,0,0,.3)}
  .f1-sess-day{font-size:8px;font-weight:700;color:rgba(255,255,255,.35);text-transform:uppercase;letter-spacing:.4px}
  .f1-sess-name{font-size:11px;font-weight:800;color:#fff;margin-top:2px}
  .f1-sess-time{font-size:9px;font-weight:600;color:rgba(255,255,255,.5);margin-top:1px}
  .f1-sess .f1-sess-ic{font-size:14px;margin-bottom:1px}

  /* SECTION HEADER (collapsible) */
  .sec-hdr{padding:18px 20px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;-webkit-user-select:none;user-select:none}
  .sec-hdr:active{background:var(--card-hover)}
  .sec-hdr-left{display:flex;align-items:center;gap:10px}
  .sec-hdr-ic{font-size:20px}
  .sec-hdr h2{font-size:17px;font-weight:800;color:var(--text)}
  .sec-hdr .badge{font-size:11px;font-weight:700;color:var(--dim);background:var(--bg);padding:3px 10px;border-radius:8px}
  .sec-hdr .chev{font-size:14px;color:var(--dim);transition:transform .2s}
  .sec-hdr.open .chev{transform:rotate(180deg)}
  .sec-body{overflow:hidden;transition:max-height .35s cubic-bezier(.16,1,.3,1)}
  .sec-body.closed{max-height:0!important}

  /* TIMELINE */
  .tl{padding:0 12px 8px;position:relative}
  .tl-city-hdr{display:flex;align-items:center;gap:10px;padding:16px 8px 8px;position:relative}
  .tl-city-hdr:first-child{padding-top:8px}
  .tl-city-line{height:3px;flex:1;border-radius:2px;opacity:.7}
  .tl-city-label{display:flex;align-items:center;gap:6px;font-size:13px;font-weight:800;letter-spacing:-.2px;white-space:nowrap}
  .tl-city-icon{font-size:18px}
  .tl-city-dates{font-size:10px;font-weight:600;color:var(--dim)}
  .tl-city-acts{display:flex;align-items:center;gap:4px}
  .tl-city-act{background:none;border:none;font-size:13px;cursor:pointer;padding:4px;border-radius:6px;opacity:.35;transition:all .12s}
  .tl-city-act:active{opacity:1;transform:scale(.9)}
  .tl-transit{display:flex;align-items:center;gap:8px;padding:10px 8px;margin:4px 0}
  .tl-transit-line{flex:1;height:2px;border-radius:1px;background:repeating-linear-gradient(90deg,var(--dim) 0px,var(--dim) 4px,transparent 4px,transparent 8px);opacity:.2}
  .tl-transit-label{font-size:11px;font-weight:700;color:var(--dim);display:flex;align-items:center;gap:4px}
  .tl-item{position:relative;margin-bottom:2px;border-radius:14px}
  .tl-item:last-child{margin-bottom:0}
  .tl-bar{padding:12px 14px;display:flex;align-items:center;gap:12px;cursor:pointer;border-radius:14px;transition:background .12s}
  .tl-bar:active{background:var(--card-hover)}
  .tl-item.open .tl-bar{background:var(--bg);border-radius:14px 14px 0 0}
  .tl-em{font-size:20px}
  .tl-info{flex:1;min-width:0}
  .tl-name{font-size:14px;font-weight:700;color:var(--text);letter-spacing:-.2px}
  .tl-day-sub{font-size:11px;color:var(--dim);font-weight:600;margin-top:1px}
  .tl-tag{display:inline-flex;align-items:center;gap:4px;font-size:10px;font-weight:700;padding:2px 8px;border-radius:6px;color:#fff;margin-top:3px}
  .tl-cnt{font-size:11px;font-weight:700;color:var(--dim)}
  .tl-expand{overflow:hidden;max-height:0;transition:max-height .35s cubic-bezier(.16,1,.3,1)}
  .tl-item.open .tl-expand{max-height:1200px}
  .tl-expand-in{padding:8px 0 14px;background:var(--bg);border-radius:0 0 14px 14px;margin-top:-2px}
  .tl-item.f1 .tl-bar{background:rgba(232,54,79,.04);border:1px solid rgba(232,54,79,.08)}
  .tl-item.f1.open .tl-bar{background:rgba(232,54,79,.06);border-color:rgba(232,54,79,.12)}

  /* EVENTS */
  .ev{display:flex;align-items:flex-start;padding:10px 14px;gap:12px;border-radius:12px;margin:0 6px 2px;transition:background .12s}
  .ev:active{background:rgba(0,0,0,.03)}
  .ev-ic{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0}
  .ev-ic.flight{background:rgba(99,102,241,.08)}.ev-ic.transport{background:rgba(134,134,139,.06)}.ev-ic.tourism{background:rgba(215,25,32,.06)}.ev-ic.food{background:rgba(234,179,8,.08)}.ev-ic.f1{background:rgba(232,54,79,.06)}
  .ev-nfo{flex:1;min-width:0}
  .ev-t{font-size:10px;font-weight:700;color:var(--red);letter-spacing:.4px;text-transform:uppercase}
  .ev-n{font-size:14px;font-weight:700;color:var(--text);margin-top:1px}
  .ev-d{font-size:12px;color:var(--dim);margin-top:2px}
  .ev-map{display:inline-flex;align-items:center;gap:3px;font-size:11px;font-weight:600;color:var(--blue);margin-top:4px;text-decoration:none;padding:3px 10px;border-radius:8px;background:rgba(27,60,140,.05)}
  .ev-map:active{background:rgba(27,60,140,.1)}
  .ev-x{background:none;border:none;color:var(--dim);font-size:16px;cursor:pointer;padding:4px;border-radius:8px;opacity:.15;flex-shrink:0}
  .ev-x:active{opacity:1;color:var(--red)}

  /* NOTES */
  .note-wrap{padding:6px 14px 4px}
  .note-in{width:100%;background:var(--card);border:1.5px solid var(--border);border-radius:10px;padding:10px 12px;font-size:13px;font-family:inherit;color:var(--text);outline:none;resize:none;min-height:36px;max-height:100px;transition:border-color .15s}
  .note-in:focus{border-color:var(--blue)}
  .note-in::placeholder{color:var(--dim)}

  /* ADD */
  .add-b{display:flex;align-items:center;justify-content:center;gap:4px;padding:12px;color:var(--red);font-size:13px;font-weight:700;cursor:pointer;border:none;background:none;width:100%;font-family:inherit}
  .add-b:active{opacity:.7}
  .add-f{padding:12px 14px 14px;animation:slideUp .2s ease}
  .fr{display:flex;gap:6px;margin-bottom:6px}
  .fi{background:var(--card);border:1.5px solid var(--border);border-radius:10px;padding:10px 12px;font-size:14px;font-family:inherit;color:var(--text);outline:none;width:100%;transition:border-color .15s}
  .fi:focus{border-color:var(--blue)}
  .fi::placeholder{color:var(--dim)}.fi.tm{width:72px;flex-shrink:0}
  .fs{background:var(--card);border:1.5px solid var(--border);border-radius:10px;padding:10px 12px;font-size:14px;font-family:inherit;color:var(--text);outline:none}
  .fa{display:flex;gap:6px;margin-top:4px}
  .btn-go{background:var(--accent-gradient);color:#fff;border:none;padding:11px 18px;border-radius:10px;font-size:14px;font-weight:700;cursor:pointer;flex:1;font-family:inherit;transition:transform .1s}
  .btn-go:active{transform:scale(.97)}
  .btn-no{background:var(--bg);color:var(--dim);border:none;padding:11px 18px;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;font-family:inherit}

  /* CHECKLIST */
  .ck-bar{height:4px;background:var(--bg);margin:0 20px 14px;border-radius:2px;overflow:hidden}
  .ck-fill{height:100%;background:var(--accent-gradient);border-radius:2px;transition:width .3s}
  .ck-item{display:flex;align-items:center;gap:12px;padding:13px 20px;border-top:1px solid var(--border);cursor:pointer;transition:background .12s;-webkit-user-select:none;user-select:none}
  .ck-item:active{background:var(--card-hover)}
  .ck-box{width:22px;height:22px;border-radius:7px;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:12px;color:transparent;transition:all .15s}
  .ck-item.done .ck-box{background:var(--accent-gradient);border-color:var(--red);color:#fff}
  .ck-item.done .ck-txt{text-decoration:line-through;color:var(--dim)}
  .ck-txt{font-size:14px;font-weight:600;color:var(--text);flex:1}
  .ck-cat{font-size:9px;font-weight:700;color:var(--dim);padding:2px 7px;border-radius:5px;background:var(--bg);text-transform:uppercase;letter-spacing:.4px}
  .ck-add{padding:12px 20px;border-top:1px solid var(--border);display:flex;gap:6px}
  .ck-inp{flex:1;background:var(--bg);border:1.5px solid var(--border);border-radius:10px;padding:9px 12px;font-size:13px;font-family:inherit;color:var(--text);outline:none}
  .ck-inp:focus{border-color:var(--blue)}
  .ck-btn{background:var(--accent-gradient);color:#fff;border:none;padding:9px 14px;border-radius:10px;font-size:14px;font-weight:700;cursor:pointer;font-family:inherit}

  /* EXPENSES */
  .exp-top{padding:0 20px 14px;display:flex;align-items:baseline;justify-content:space-between}
  .exp-total{font-size:24px;font-weight:900;color:var(--red)}
  .exp-cities{display:flex;gap:6px;padding:0 20px 14px;overflow-x:auto;scrollbar-width:none}
  .exp-cities::-webkit-scrollbar{display:none}
  .exp-city{padding:8px 14px;border-radius:10px;background:var(--bg);text-align:center;min-width:70px}
  .exp-city-n{font-size:10px;font-weight:600;color:var(--dim)}
  .exp-city-a{font-size:15px;font-weight:800;color:var(--text);margin-top:2px}
  .exp-list{max-height:200px;overflow-y:auto}
  .exp-row{display:flex;align-items:center;gap:12px;padding:11px 20px;border-top:1px solid var(--border)}
  .exp-row-ic{font-size:16px}
  .exp-row-nfo{flex:1}
  .exp-row-n{font-size:13px;font-weight:700;color:var(--text)}
  .exp-row-d{font-size:11px;color:var(--dim)}
  .exp-row-a{font-size:14px;font-weight:800;color:var(--text)}
  .exp-row-x{background:none;border:none;color:var(--dim);font-size:14px;cursor:pointer;opacity:.25;padding:4px}
  .exp-row-x:active{opacity:1;color:var(--red)}
  .exp-form{padding:12px 20px;border-top:1px solid var(--border)}
  .exp-fr{display:flex;gap:6px;margin-bottom:6px}
  .exp-cur{font-size:13px;font-weight:700;color:var(--dim);padding:10px 0}

  /* MODAL */
  .mbg{position:fixed;inset:0;background:rgba(0,0,0,.35);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);z-index:300;display:flex;align-items:flex-end;justify-content:center;animation:fin .2s}
  @keyframes fin{from{opacity:0}to{opacity:1}}
  .msh{background:var(--card);border-radius:24px 24px 0 0;padding:24px 20px calc(var(--safe-bottom)+24px);width:100%;max-width:420px;animation:sup .3s cubic-bezier(.16,1,.3,1);max-height:85dvh;overflow-y:auto}
  @keyframes sup{from{transform:translateY(100%)}to{transform:translateY(0)}}
  .msh h2{font-size:20px;font-weight:800;margin-bottom:4px}
  .msh p{color:var(--dim);font-size:13px;margin-bottom:14px;line-height:1.5}
  .sbox{background:var(--bg);border-radius:12px;padding:12px;display:flex;align-items:center;gap:8px;margin-bottom:14px}
  .sbox span{flex:1;color:var(--red);font-size:11px;font-family:ui-monospace,monospace;word-break:break-all}
  .cpb{background:var(--accent-gradient);color:#fff;border:none;padding:7px 14px;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer}
  .clb{background:var(--bg);color:var(--dim);border:none;padding:12px;border-radius:12px;width:100%;font-size:15px;font-weight:600;cursor:pointer;font-family:inherit}
  @keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}

  /* DAY MODAL */
  .dm-lbl{font-size:11px;font-weight:700;color:var(--dim);text-transform:uppercase;letter-spacing:.5px;margin:14px 0 6px}
  .dm-lbl:first-of-type{margin-top:8px}
  .dm-cities{display:flex;gap:6px;flex-wrap:wrap}
  .dm-city{padding:8px 12px;border-radius:12px;border:2px solid var(--border);cursor:pointer;text-align:center;min-width:64px;transition:all .15s}
  .dm-city:active{transform:scale(.95)}
  .dm-city.sel{border-color:var(--red);background:var(--red-soft)}
  .dm-city-ic{font-size:16px}
  .dm-city-n{font-size:10px;font-weight:700;margin-top:1px}
  .dm-icons{display:flex;gap:6px;flex-wrap:wrap}
  .dm-icon{width:40px;height:40px;border-radius:10px;border:2px solid var(--border);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px;transition:all .15s}
  .dm-icon:active{transform:scale(.9)}
  .dm-icon.sel{border-color:var(--red);background:var(--red-soft)}
  .dm-actions{display:flex;gap:8px;margin-top:18px}
  .dm-btn{flex:1;padding:13px;border-radius:12px;font-size:15px;font-weight:700;cursor:pointer;border:none;font-family:inherit;transition:transform .1s}
  .dm-btn:active{transform:scale(.97)}
  .dm-btn.primary{background:var(--accent-gradient);color:#fff}
  .dm-btn.secondary{background:var(--bg);color:var(--dim)}
  .dm-btn.danger{background:rgba(215,25,32,.08);color:var(--red)}
  .dm-custom{display:flex;gap:6px;margin-top:8px}
  .dm-color-row{display:flex;gap:6px;flex-wrap:wrap;margin-top:4px}
  .dm-color{width:28px;height:28px;border-radius:50%;border:2px solid transparent;cursor:pointer;transition:all .12s}
  .dm-color:active{transform:scale(.9)}
  .dm-color.sel{border-color:var(--text);box-shadow:0 0 0 2px var(--bg),0 0 0 4px var(--text)}

  /* ADD DAY BTN */
  .add-day-btn{margin:4px 0 8px;display:flex;align-items:center;justify-content:center;gap:6px;padding:14px;color:var(--blue);font-size:14px;font-weight:700;cursor:pointer;border:2px dashed var(--border);border-radius:14px;background:none;width:100%;font-family:inherit;transition:all .15s}
  .add-day-btn:active{background:var(--card-hover);border-color:var(--blue);transform:scale(.98)}

  /* DELETE DAY / EDIT BTN */
  .tl-actions{display:flex;gap:4px;align-items:center}
  .tl-act{background:none;border:none;font-size:14px;cursor:pointer;padding:6px;border-radius:8px;opacity:.3;transition:all .12s}
  .tl-act:active{opacity:1;transform:scale(.9)}
  .tl-act.edit:active{color:var(--blue)}
  .tl-act.del:active{color:var(--red)}

  /* SPLASH ‚Äî GP BARCELONA */
  .splash{position:fixed;inset:0;z-index:9999;background:#0a0a0a;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:opacity .5s ease,transform .5s ease;overflow:hidden}
  .splash.hide{opacity:0;transform:scale(1.05);pointer-events:none}
  .splash-carbon{position:absolute;inset:0;background:repeating-linear-gradient(45deg,transparent,transparent 2px,rgba(255,255,255,.012) 2px,rgba(255,255,255,.012) 4px)}
  .splash-glow{position:absolute;top:30%;left:50%;transform:translate(-50%,-50%);width:80%;height:60%;background:radial-gradient(ellipse,rgba(220,0,0,.2),transparent 70%);animation:spGlow 2s ease-in-out infinite alternate}
  @keyframes spGlow{0%{opacity:.4;transform:translate(-50%,-50%) scale(.9)}100%{opacity:.8;transform:translate(-50%,-50%) scale(1.1)}}

  .speed-lines{position:absolute;inset:0;overflow:hidden}
  .speed-line{position:absolute;height:1px;background:linear-gradient(90deg,transparent,rgba(220,0,0,.35),transparent);animation:speedLine .8s linear infinite}
  @keyframes speedLine{0%{transform:translateX(-100%)}100%{transform:translateX(200vw)}}

  /* F1 FLAG */
  .sp-flag{position:relative;z-index:2;font-size:48px;animation:flagWave 1s ease-in-out infinite alternate;opacity:0;animation-delay:.3s;animation-fill-mode:forwards}
  @keyframes flagWave{0%{transform:rotate(-5deg) scale(1);opacity:1}100%{transform:rotate(5deg) scale(1.05);opacity:1}}

  /* CAR CROSSING */
  .sp-car-wrap{position:relative;z-index:2;margin-top:20px;width:100%;height:50px;overflow:hidden}
  .sp-car{position:absolute;top:8px;font-size:44px;animation:carCross 1.8s cubic-bezier(.2,.8,.3,1) forwards;opacity:0;filter:drop-shadow(0 4px 16px rgba(220,0,0,.4))}
  @keyframes carCross{0%{left:-15%;opacity:0}15%{opacity:1}50%{left:42%}65%{left:44%}100%{left:42%;opacity:1}}
  .sp-car-trail{position:absolute;top:24px;height:3px;border-radius:2px;background:linear-gradient(90deg,transparent,rgba(220,0,0,.5));animation:trailGrow 1.8s cubic-bezier(.2,.8,.3,1) forwards;width:0;left:0}
  @keyframes trailGrow{0%{width:0;opacity:0}15%{opacity:.6}50%{width:42%}100%{width:42%;opacity:.3}}

  /* CIRCUIT NAME */
  .sp-circuit{position:relative;z-index:2;margin-top:8px;font-size:10px;font-weight:800;letter-spacing:3px;text-transform:uppercase;color:rgba(255,255,255,.25);animation:titleReveal .5s ease forwards;animation-delay:.6s;opacity:0}

  .splash-title{position:relative;z-index:2;margin-top:20px;text-align:center;animation:titleReveal .6s cubic-bezier(.16,1,.3,1) forwards;animation-delay:.9s;opacity:0;transform:translateY(20px)}
  @keyframes titleReveal{to{opacity:1;transform:translateY(0)}}
  .splash-title h2{font-size:26px;font-weight:900;color:#fff;letter-spacing:-.5px;text-shadow:0 2px 20px rgba(0,0,0,.3)}
  .splash-title .gp{color:#dc0000}
  .splash-title .year{font-size:11px;font-weight:700;color:rgba(255,255,255,.35);letter-spacing:5px;margin-top:6px;text-transform:uppercase}

  .splash-lights{position:relative;z-index:2;display:flex;gap:8px;margin-top:20px;animation:titleReveal .5s ease forwards;animation-delay:1.2s;opacity:0}
  .splash-light{width:12px;height:12px;border-radius:50%;background:#222;border:2px solid #444}
  .splash-light:nth-child(1){animation:sL1 4s ease infinite;animation-delay:1.3s}
  .splash-light:nth-child(2){animation:sL2 4s ease infinite;animation-delay:1.3s}
  .splash-light:nth-child(3){animation:sL3 4s ease infinite;animation-delay:1.3s}
  .splash-light:nth-child(4){animation:sL4 4s ease infinite;animation-delay:1.3s}
  .splash-light:nth-child(5){animation:sL5 4s ease infinite;animation-delay:1.3s}
  @keyframes sL1{0%,9%{background:#222;box-shadow:none}10%,64%{background:#dc0000;box-shadow:0 0 12px #dc0000}65%,100%{background:#222;box-shadow:none}}
  @keyframes sL2{0%,19%{background:#222;box-shadow:none}20%,64%{background:#dc0000;box-shadow:0 0 12px #dc0000}65%,100%{background:#222;box-shadow:none}}
  @keyframes sL3{0%,29%{background:#222;box-shadow:none}30%,64%{background:#dc0000;box-shadow:0 0 12px #dc0000}65%,100%{background:#222;box-shadow:none}}
  @keyframes sL4{0%,39%{background:#222;box-shadow:none}40%,64%{background:#dc0000;box-shadow:0 0 12px #dc0000}65%,100%{background:#222;box-shadow:none}}
  @keyframes sL5{0%,49%{background:#222;box-shadow:none}50%,64%{background:#dc0000;box-shadow:0 0 12px #dc0000}65%,100%{background:#222;box-shadow:none}}

  .checkered{position:absolute;bottom:0;left:0;right:0;height:16px;display:flex;flex-wrap:wrap;animation:checkReveal .4s ease forwards;animation-delay:1.4s;opacity:0}
  @keyframes checkReveal{to{opacity:1}}
  .checkered span{width:8px;height:8px;display:inline-block}
</style>
</head>
<body>
<div id="splash" class="splash">
  <div class="splash-carbon"></div>
  <div class="splash-glow"></div>
  <div class="speed-lines">
    <div class="speed-line" style="top:20%;width:45%;animation-delay:.1s;animation-duration:.7s"></div>
    <div class="speed-line" style="top:35%;width:55%;animation-delay:.3s;animation-duration:.6s"></div>
    <div class="speed-line" style="top:65%;width:40%;animation-delay:0s;animation-duration:.75s"></div>
    <div class="speed-line" style="top:80%;width:50%;animation-delay:.2s;animation-duration:.65s"></div>
  </div>
  <div class="sp-flag">üèÅ</div>
  <div class="sp-car-wrap">
    <div class="sp-car-trail"></div>
    <div class="sp-car">üèéÔ∏è</div>
  </div>
  <div class="sp-circuit">Circuit de Barcelona-Catalunya</div>
  <div class="splash-title">
    <h2>GP de <span class="gp">Espa√±a</span></h2>
    <div class="year">Junio 12 ‚Äì 14 ¬∑ 2026</div>
  </div>
  <div class="splash-lights"><span class="splash-light"></span><span class="splash-light"></span><span class="splash-light"></span><span class="splash-light"></span><span class="splash-light"></span></div>
  <div class="checkered" id="checkered"></div>
</div>
<div id="app"></div>
<script>
const TRIP=[
  {date:"2026-06-05",label:"Viernes 5",city:"Vuelo",color:"#6366f1",icon:"‚úàÔ∏è",events:[{time:"21:45",title:"Vuelo a Madrid",detail:"IB 170 ‚Äî Salida 9:45pm",type:"flight"}]},
  {date:"2026-06-06",label:"S√°bado 6",city:"Madrid",color:"#D71920",icon:"üè∞",events:[{time:"",title:"Madrid",detail:"Llegada y check-in",type:"tourism"}]},
  {date:"2026-06-07",label:"Domingo 7",city:"Madrid",color:"#D71920",icon:"üè∞",events:[{time:"",title:"Madrid",detail:"",type:"tourism"}]},
  {date:"2026-06-08",label:"Lunes 8",city:"Madrid",color:"#D71920",icon:"üè∞",events:[{time:"",title:"Madrid",detail:"",type:"tourism"}]},
  {date:"2026-06-09",label:"Martes 9",city:"Madrid",color:"#D71920",icon:"‚öîÔ∏è",events:[{time:"",title:"Toledo ‚Äî Excursi√≥n",detail:"Day trip desde Madrid",type:"tourism"}]},
  {date:"2026-06-10",label:"Mi√©rcoles 10",city:"Madrid",color:"#D71920",icon:"üè∞",events:[{time:"",title:"Madrid",detail:"",type:"tourism"}]},
  {date:"2026-06-11",label:"Jueves 11",city:"Barcelona",color:"#3b5998",icon:"üöÇ",from:"Madrid",fromColor:"#D71920",events:[{time:"",title:"Traslado Madrid ‚Üí Barcelona",detail:"Tren/avi√≥n",type:"transport"},{time:"",title:"Airbnb ‚Äî Barcelona",detail:"Check-in Airbnb",type:"tourism"}]},
  {date:"2026-06-12",label:"Viernes 12",city:"Barcelona",color:"#3b5998",icon:"üèéÔ∏è",events:[{time:"",title:"Airbnb ‚Äî Barcelona",detail:"",type:"tourism"},{time:"üèÅ",title:"F1 ‚Äî Pr√°ctica Libre",detail:"Circuit de Barcelona-Catalunya",type:"f1"}]},
  {date:"2026-06-13",label:"S√°bado 13",city:"Barcelona",color:"#3b5998",icon:"üèéÔ∏è",events:[{time:"",title:"Airbnb ‚Äî Barcelona",detail:"",type:"tourism"},{time:"üèÅ",title:"F1 ‚Äî Clasificaci√≥n",detail:"Circuit de Barcelona-Catalunya",type:"f1"}]},
  {date:"2026-06-14",label:"Domingo 14",city:"Barcelona",color:"#3b5998",icon:"üèéÔ∏è",events:[{time:"",title:"Airbnb ‚Äî Barcelona",detail:"",type:"tourism"},{time:"üèÅ",title:"F1 ‚Äî Carrera",detail:"Circuit de Barcelona-Catalunya",type:"f1"}]},
  {date:"2026-06-15",label:"Lunes 15",city:"Barcelona",color:"#3b5998",icon:"üåä",events:[{time:"",title:"Airbnb ‚Äî Barcelona",detail:"",type:"tourism"}]},
  {date:"2026-06-16",label:"Martes 16",city:"Barcelona",color:"#3b5998",icon:"üåä",events:[{time:"",title:"Airbnb ‚Äî Barcelona",detail:"",type:"tourism"}]},
  {date:"2026-06-17",label:"Mi√©rcoles 17",city:"Valencia",color:"#2a9d8f",icon:"üöÇ",from:"Barcelona",fromColor:"#3b5998",events:[{time:"",title:"Traslado Barcelona ‚Üí Valencia",detail:"Tren/bus",type:"transport"},{time:"",title:"Valencia",detail:"Llegada y paseo",type:"tourism"}]},
  {date:"2026-06-18",label:"Jueves 18",city:"Valencia",color:"#2a9d8f",icon:"üçä",events:[{time:"",title:"Valencia",detail:"",type:"tourism"}]},
  {date:"2026-06-19",label:"Viernes 19",city:"Madrid",color:"#D71920",icon:"üöÇ",from:"Valencia",fromColor:"#2a9d8f",events:[{time:"",title:"Traslado Valencia ‚Üí Madrid",detail:"Tren/avi√≥n",type:"transport"},{time:"",title:"Madrid",detail:"√öltima noche",type:"tourism"}]},
  {date:"2026-06-20",label:"S√°bado 20",city:"Vuelo",color:"#6366f1",icon:"‚úàÔ∏è",events:[{time:"06:50",title:"Vuelo a Montevideo",detail:"IB 169 ‚Äî Salida 6:50am",type:"flight"}]}
];
const MAPS={"Vuelo a Madrid":"https://maps.google.com/?q=Aeropuerto+Barajas+Madrid","Madrid":"https://maps.google.com/?q=Madrid+centro","Toledo ‚Äî Excursi√≥n":"https://maps.google.com/?q=Toledo+Espa√±a","Traslado Madrid ‚Üí Barcelona":"https://maps.google.com/?q=Madrid+a+Barcelona","Airbnb ‚Äî Barcelona":"https://maps.google.com/?q=Barcelona+centro","F1 ‚Äî Pr√°ctica Libre":"https://maps.google.com/?q=Circuit+de+Barcelona-Catalunya","F1 ‚Äî Clasificaci√≥n":"https://maps.google.com/?q=Circuit+de+Barcelona-Catalunya","F1 ‚Äî Carrera":"https://maps.google.com/?q=Circuit+de+Barcelona-Catalunya","Traslado Barcelona ‚Üí Valencia":"https://maps.google.com/?q=Barcelona+a+Valencia","Valencia":"https://maps.google.com/?q=Valencia+centro","Traslado Valencia ‚Üí Madrid":"https://maps.google.com/?q=Valencia+a+Madrid","Vuelo a Montevideo":"https://maps.google.com/?q=Aeropuerto+Barajas+Madrid"};
const DEFAULT_CC={Madrid:"#D71920",Barcelona:"#3b5998",Valencia:"#2a9d8f",Vuelo:"#6366f1",Sevilla:"#e67e22",M√°laga:"#9b59b6",Granada:"#16a085",Bilbao:"#2c3e50"};
const PRESET_COLORS=["#D71920","#3b5998","#2a9d8f","#6366f1","#e67e22","#9b59b6","#16a085","#2c3e50","#c0392b","#f59e0b","#ec4899","#06b6d4"];
const ICONS=["üè∞","üåä","üçä","‚úàÔ∏è","‚öîÔ∏è","üèéÔ∏è","üé≠","üåÖ","üèîÔ∏è","üç∑","‚õ™","üèñÔ∏è","üé®","üå∫","üöÇ","üõ≥Ô∏è"];
const EI={flight:"‚úàÔ∏è",transport:"üöå",tourism:"üìç",food:"üçΩÔ∏è",f1:"üèéÔ∏è"};
const F1_DATES=["2026-06-12","2026-06-13","2026-06-14"];
const DAYS_ES=["Domingo","Lunes","Martes","Mi√©rcoles","Jueves","Viernes","S√°bado"];

function getCC(){const cc={...DEFAULT_CC};S.data.forEach(d=>{if(d.city&&d.color)cc[d.city]=d.color});return cc}
function getCTS(){const cities=[];S.data.forEach(d=>{if(d.city&&d.city!=='Vuelo'&&!cities.includes(d.city))cities.push(d.city)});return["Todos",...cities]}
function getROUTE(){const r=[];S.data.forEach(d=>{if(d.from){r.push({city:d.from+'‚Üí'+d.city,days:.5,startDate:d.date,endDate:d.date,isTransit:true,fromColor:d.fromColor,toColor:d.color})}else{const last=r[r.length-1];if(last&&!last.isTransit&&last.city===d.city){last.days++;last.endDate=d.date}else{r.push({city:d.city,days:1,startDate:d.date,endDate:d.date})}}});return r.map(s=>{const sd=parseInt(s.startDate.slice(8)),ed=parseInt(s.endDate.slice(8));const dates=sd===ed?`${sd} Jun`:`${sd}‚Äì${ed}`;return{...s,dates}})}
const DEFAULT_CK=[{text:"Pasaportes",done:false,cat:"docs"},{text:"Seguro de viaje",done:false,cat:"docs"},{text:"Reserva vuelos impresas",done:false,cat:"docs"},{text:"Entradas F1",done:false,cat:"f1"},{text:"Reserva Airbnb Barcelona",done:false,cat:"aloj"},{text:"Hotel Madrid",done:false,cat:"aloj"},{text:"Adaptador enchufe",done:false,cat:"equip"},{text:"Protector solar",done:false,cat:"equip"},{text:"Cargador port√°til",done:false,cat:"equip"},{text:"Tarjeta de cr√©dito internacional",done:false,cat:"docs"}];
const WX={"2026-06-05":{i:"‚úàÔ∏è",t:"-"},"2026-06-06":{i:"‚òÄÔ∏è",t:"31¬∞"},"2026-06-07":{i:"‚òÄÔ∏è",t:"32¬∞"},"2026-06-08":{i:"üå§Ô∏è",t:"30¬∞"},"2026-06-09":{i:"‚òÄÔ∏è",t:"33¬∞"},"2026-06-10":{i:"‚òÄÔ∏è",t:"31¬∞"},"2026-06-11":{i:"üå§Ô∏è",t:"27¬∞"},"2026-06-12":{i:"‚òÄÔ∏è",t:"28¬∞"},"2026-06-13":{i:"‚òÄÔ∏è",t:"29¬∞"},"2026-06-14":{i:"üå§Ô∏è",t:"28¬∞"},"2026-06-15":{i:"‚òÄÔ∏è",t:"29¬∞"},"2026-06-16":{i:"‚òÄÔ∏è",t:"28¬∞"},"2026-06-17":{i:"‚òÄÔ∏è",t:"30¬∞"},"2026-06-18":{i:"‚òÄÔ∏è",t:"31¬∞"},"2026-06-19":{i:"‚òÄÔ∏è",t:"32¬∞"},"2026-06-20":{i:"‚úàÔ∏è",t:"-"}};

let S={data:JSON.parse(JSON.stringify(TRIP)),sel:null,add:false,modal:false,on:false,filt:"Todos",notes:{},ck:null,exp:[],showCk:false,showExp:false,dayModal:null,dmCity:'',dmIcon:'',dmDate:'',dmColor:'',dmCustomCity:'',dmDays:1};
let db=null,ref=null,notesRef=null,ckRef=null,expRef=null;
const FC={apiKey:"AIzaSyDPZPk2nsOQ3oRMG7ADhS56zEFyORTE4QQ",authDomain:"flor-y-pato-trip.firebaseapp.com",databaseURL:"https://flor-y-pato-trip-default-rtdb.firebaseio.com",projectId:"flor-y-pato-trip",storageBucket:"flor-y-pato-trip.firebasestorage.app",messagingSenderId:"862498607498",appId:"1:862498607498:web:7e2ccf24cd913e6cb7c5c3"};

const DATA_VERSION=4;
function migrateData(d){if(!d||!Array.isArray(d))return null;let changed=false;d.forEach(day=>{if(day.city==='Toledo'){day.city='Madrid';day.color='#D71920';changed=true}});return changed?d:null}
function initFB(){try{firebase.initializeApp(FC);db=firebase.database();ref=db.ref('trip-espana-2026');notesRef=db.ref('trip-notes-2026');ckRef=db.ref('trip-checklist-2026');expRef=db.ref('trip-expenses-2026');const verRef=db.ref('trip-data-version');
verRef.once('value',sv=>{const ver=sv.val()||0;if(ver<DATA_VERSION){ref.set(TRIP);verRef.set(DATA_VERSION)}});
ref.on('value',s=>{const d=s.val();if(d&&Array.isArray(d)){const fix=migrateData(d);if(fix){S.data=fix;ref.set(fix)}else{S.data=d}S.on=true;R()}});db.ref('.info/connected').on('value',s=>{S.on=s.val()===true;R()});ref.once('value',s=>{if(!s.val())ref.set(TRIP)});notesRef.on('value',s=>{S.notes=s.val()||{};R()});ckRef.on('value',s=>{S.ck=s.val()||DEFAULT_CK;R()});ckRef.once('value',s=>{if(!s.val())ckRef.set(DEFAULT_CK)});expRef.on('value',s=>{S.exp=s.val()||[];R()});return true}catch(e){return false}}
function save(){if(ref)ref.set(S.data)}
function saveNotes(){if(notesRef)notesRef.set(S.notes)}
function saveCK(){if(ckRef)ckRef.set(S.ck)}
function saveExp(){if(expRef)expRef.set(S.exp)}
function tm(){const m={};S.data.forEach(d=>{m[d.date]=d});return m}
function today(){const n=new Date(),y=n.getFullYear(),m=String(n.getMonth()+1).padStart(2,'0'),d=String(n.getDate()).padStart(2,'0');return`${y}-${m}-${d}`}
function countdown(){const s=new Date('2026-06-05T00:00:00'),e=new Date('2026-06-20T23:59:59'),n=new Date();if(n<s){const d=Math.ceil((s-n)/864e5);return{n:d,t:`Faltan ${d} d√≠a${d===1?'':'s'}`,s:'para el viaje'}}else if(n<=e){const d=Math.floor((n-s)/864e5)+1;return{n:d,t:`D√≠a ${d}`,s:'del viaje',live:true}}return{n:'‚úì',t:'Viaje completado',s:'Espa√±a 2026'}}
function cityIconFor(c){const m={Madrid:'üè∞',Barcelona:'üåä',Valencia:'üçä',Vuelo:'‚úàÔ∏è',Sevilla:'üå∫',M√°laga:'üèñÔ∏è',Granada:'‚õ™',Bilbao:'üèîÔ∏è',Toledo:'‚öîÔ∏è'};return m[c]||'üèôÔ∏è'}

function cityAbbr(c){const m={Madrid:'MAD',Barcelona:'BCN',Valencia:'VLC',Vuelo:'‚úàÔ∏è',Sevilla:'SEV',M√°laga:'MLG',Granada:'GRA',Bilbao:'BIO',Toledo:'TOL'};return m[c]||c.slice(0,3).toUpperCase()}
function calHTML(){
  const t=tm(),td=today(),CC=getCC();
  const weeks=[[1,2,3,4,5,6,7],[8,9,10,11,12,13,14],[15,16,17,18,19,20,21],[22,23,24,25,26,27,28],[29,30,null,null,null,null,null]];
  let h=`<div class="cal-title"><div class="cal-month">Junio 2026</div></div>`;
  h+=`<div class="cal-grid">${['L','M','X','J','V','S','D'].map(d=>`<div class="cal-hdr">${d}</div>`).join('')}`;
  weeks.forEach(wk=>{
    wk.forEach(d=>{
      if(!d){h+=`<div class="cal-cell empty"><div class="cal-num"></div></div>`;return}
      const ds=`2026-06-${String(d).padStart(2,'0')}`,day=t[ds],sl=S.sel===ds,it=ds===td;
      const vis=day&&(S.filt==="Todos"||day.city===S.filt||day.from===S.filt);
      const cls=['cal-cell'];
      if(day)cls.push('trip');if(it)cls.push('today');if(sl)cls.push('sel');
      const bgTint=day&&vis?`background:${day.color}0D`:'';
      h+=`<div class="${cls.join(' ')}" style="${bgTint}" onclick="${day?`sel('${ds}')`:''}">`;
      h+=`<div class="cal-num">${d}</div>`;
      if(day&&vis){
        const isF1=F1_DATES.includes(ds);
        if(day.from){
          const fromAbbr=cityAbbr(day.from);
          const toAbbr=cityAbbr(day.city);
          h+=`<div class="cal-split"><div class="cal-split-half" style="background:${day.fromColor||'#888'}">${fromAbbr}</div><div class="cal-split-half" style="background:${day.color}">‚Üí${toAbbr}</div></div>`;
        } else {
          const abbr=cityAbbr(day.city);
          const barColor=isF1?'linear-gradient(135deg,#E8364F,#ff6b35)':day.color;
          h+=`<div class="cal-city-bar" style="background:${barColor}">${isF1?'üèéÔ∏è F1':abbr}</div>`;
        }
      }
      h+=`</div>`;
    });
  });
  h+=`</div>`;
  // Legend
  const cities={};S.data.forEach(d=>{if(d.city&&!cities[d.city])cities[d.city]={color:d.color,icon:d.icon}});
  h+=`<div class="cal-legend">${Object.entries(cities).map(([c,v])=>`<div class="cal-leg-item"><div class="cal-leg-dot" style="background:${v.color}"></div>${v.icon} ${c}</div>`).join('')}</div>`;
  // Weather row
  const fd=S.filt==="Todos"?S.data:S.data.filter(d=>d.city===S.filt||d.from===S.filt);
  h+=`<div class="cal-divider"></div><div class="wx-row">`;
  fd.forEach(day=>{const w=WX[day.date];if(w)h+=`<div class="wx"><div class="wx-d">${day.date.slice(8)}</div><div class="wx-i">${w.i}</div><div class="wx-t">${w.t}</div></div>`});
  h+=`</div>`;
  return h;
}

function evHTML(day){
  let h='';
  day.events.forEach((e,j)=>{
    const map=MAPS[e.title]||null;
    h+=`<div class="ev">
      <div class="ev-ic ${e.type}">${EI[e.type]||'üìç'}</div>
      <div class="ev-nfo">${e.time?`<div class="ev-t">${e.time}</div>`:''}
        <div class="ev-n">${e.title}</div>${e.detail?`<div class="ev-d">${e.detail}</div>`:''}
        ${map?`<a class="ev-map" href="${map}" target="_blank" onclick="event.stopPropagation()">üìç Maps</a>`:''}
      </div>
      <button class="ev-x" onclick="event.stopPropagation();del('${day.date}',${j})">√ó</button>
    </div>`;
  });
  return h;
}

function R(){
  const t=tm(),td=today(),cd=countdown(),CC=getCC(),CTS=getCTS(),ROUTE=getROUTE();
  const firstDate=S.data.length?S.data[0].date:'',lastDate=S.data.length?S.data[S.data.length-1].date:'';
  const fd1=firstDate?parseInt(firstDate.slice(8)):5,fd2=lastDate?parseInt(lastDate.slice(8)):20;
  let h='';
  if(db)h+=`<div class="sync ${S.on?'on':'off'}">${S.on?'‚óè Sync':'‚óã Offline'}</div>`;

  // HERO
  h+=`<div class="hero-safe"></div><div class="hero">
    <div class="hero-row">
      <div><h1>Espa√±a <span class="yr">2026</span></h1><div class="sub">${fd1} ‚Äî ${fd2} de Junio ¬∑ ${S.data.length} d√≠as</div></div>
      ${db?'<button class="share-btn" onclick="sM()">üîó</button>':''}
    </div>
    <div class="cd-row">
      <div class="cd-num">${cd.n}</div>
      <div><div class="cd-label">${cd.t}</div><div class="cd-sub">${cd.live?'<span class="cd-live">En viaje</span>':cd.s}</div></div>
    </div>
    <div class="route-wrap">
      <div class="route-lbl">Ruta</div>
      <div class="route-bar">${ROUTE.map(r=>{if(r.isTransit){return`<div class="route-seg" style="flex:${r.days};background:linear-gradient(90deg,${r.fromColor},${r.toColor});font-size:8px">‚Üí</div>`}return`<div class="route-seg" style="flex:${r.days};background:${CC[r.city]||'#888'}">${r.city==='Vuelo'?'‚úàÔ∏è':r.city}<span class="seg-dates">${r.dates}</span></div>`}).join('')}</div>
    </div>
    <div class="filters">${CTS.map(c=>{const on=S.filt===c;return c==="Todos"?`<div class="fil ${on?'on':''}" onclick="flt('${c}')">Todos</div>`:`<div class="fil ${on?'on':''}" onclick="flt('${c}')"><span class="fdot" style="background:${CC[c]||'#888'}"></span>${c}</div>`}).join('')}</div>`;

  // F1 INSIDE HERO
  if(S.filt==='Todos'||S.filt==='Barcelona'){
    const f1d=Math.ceil((new Date('2026-06-12')-new Date())/864e5);
    let f1s=f1d>0?`üèÅ ${f1d}d`:f1d===0?'üü¢ LIGHTS OUT':'üèÅ Done';
    const td2=today();
    const sessActive=(d)=>td2===d?'active':'';
    h+=`<div class="f1-section">
      <div class="f1-carbon"></div>
      <div class="f1-glow-rb"></div>
      <div class="f1-glow-fer"></div>
      <div class="f1-top">
        <div><div class="f1-gp">Formula 1</div><div class="f1-title">GP de <span class="vs">Espa√±a</span> 2026</div></div>
        <div class="f1-badge">${f1s}</div>
      </div>
      <div class="f1-track">
        <div class="f1-lights"><span class="f1-light"></span><span class="f1-light"></span><span class="f1-light"></span><span class="f1-light"></span><span class="f1-light"></span></div>
        <div class="f1-trail-rb"></div>
        <div class="f1-trail-fer"></div>
        <div class="f1-car-rb">üèéÔ∏è</div>
        <div class="f1-car-fer">üèéÔ∏è</div>
        <div class="f1-road"></div>
        <div class="f1-sparks" style="left:52%;animation-delay:0s"></div>
        <div class="f1-sparks" style="left:46%;animation-delay:.2s"></div>
      </div>
      <div class="f1-sched">
        <div class="f1-sess ${sessActive('2026-06-12')}"><div class="f1-sess-ic">üèóÔ∏è</div><div class="f1-sess-day">Vie 12</div><div class="f1-sess-name">Pr√°ctica</div><div class="f1-sess-time">14:30</div></div>
        <div class="f1-sess ${sessActive('2026-06-13')}"><div class="f1-sess-ic">‚è±Ô∏è</div><div class="f1-sess-day">S√°b 13</div><div class="f1-sess-name">Qualy</div><div class="f1-sess-time">16:00</div></div>
        <div class="f1-sess ${sessActive('2026-06-14')}"><div class="f1-sess-ic">üèÜ</div><div class="f1-sess-day">Dom 14</div><div class="f1-sess-name">Carrera</div><div class="f1-sess-time">15:00</div></div>
      </div>
    </div>`;
  }
  h+=`</div>`;

  // CALENDAR
  h+=`<div class="section">${calHTML()}</div>`;

  // TIMELINE ‚Äî grouped by city with headers
  h+=`<div class="section"><div class="sec-hdr open"><div class="sec-hdr-left"><span class="sec-hdr-ic">üìÖ</span><h2>Timeline</h2></div><span class="badge">${S.data.length} d√≠as</span></div><div class="tl">`;
  const fd=S.filt==="Todos"?S.data:S.data.filter(d=>d.city===S.filt||d.from===S.filt);
  // Group by city blocks
  let lastCity=null;
  fd.forEach((day,idx)=>{
    const mainCity=day.city;
    // Transit header between cities
    if(day.from && S.filt==='Todos'){
      h+=`<div class="tl-transit">
        <div class="tl-transit-line"></div>
        <div class="tl-transit-label">üöÇ ${day.from} ‚Üí ${day.city}</div>
        <div class="tl-transit-line"></div>
      </div>`;
      lastCity=null;
    }
    // City header when city changes
    if(mainCity!==lastCity && !day.from){
      const cityDays=fd.filter(d=>d.city===mainCity&&!d.from);
      const d1=cityDays[0],d2=cityDays[cityDays.length-1];
      const dateRange=d1&&d2?(d1===d2?`${parseInt(d1.date.slice(8))} Jun`:`${parseInt(d1.date.slice(8))}‚Äì${parseInt(d2.date.slice(8))} Jun`):'';
      const totalEvts=cityDays.reduce((s,d)=>s+d.events.length,0);
      const cityIcon=day.icon;
      h+=`<div class="tl-city-hdr">
        <div class="tl-city-line" style="background:${day.color}"></div>
        <div class="tl-city-label" style="color:${day.color}"><span class="tl-city-icon">${cityIcon}</span>${mainCity}</div>
        <div class="tl-city-dates">${dateRange} ¬∑ ${cityDays.length}d ¬∑ ${totalEvts} act</div>
        <div class="tl-city-acts">
          <button class="tl-city-act" onclick="openAddDay('${mainCity}')" title="Agregar d√≠a">‚ûï</button>
        </div>
      </div>`;
      lastCity=mainCity;
    }
    if(day.from)lastCity=mainCity;

    const isOpen=S.sel===day.date,isF1=F1_DATES.includes(day.date),isToday=day.date===td;
    const cls=['tl-item'];if(isOpen)cls.push('open');if(isF1)cls.push('f1');if(isToday)cls.push('is-today');
    const evCount=day.events.length;
    const dayNum=parseInt(day.date.slice(8));
    const dayName=DAYS_ES[new Date(day.date+'T12:00:00').getDay()];
    h+=`<div class="${cls.join(' ')}" id="day-${day.date}">
      <div class="tl-bar" onclick="sel('${day.date}')">
        <span class="tl-em">${day.icon}</span>
        <div class="tl-info">
          <div class="tl-name">${dayName} ${dayNum}${isToday?' ¬∑ <span style="color:var(--blue);font-size:11px">HOY</span>':''}</div>
          <div class="tl-day-sub">${evCount} actividad${evCount!==1?'es':''} ${day.from?'¬∑ '+day.from+' ‚Üí '+day.city:''} ${isF1?'¬∑ üèéÔ∏è F1':''}</div>
        </div>
        <div class="tl-actions">
          <button class="tl-act edit" onclick="event.stopPropagation();openEditDay('${day.date}')" title="Editar">‚úèÔ∏è</button>
          <button class="tl-act del" onclick="event.stopPropagation();delDay('${day.date}')" title="Eliminar">üóëÔ∏è</button>
        </div>
      </div>
      <div class="tl-expand"><div class="tl-expand-in">`;
    h+=evHTML(day);
    if(isOpen){
      const nv=S.notes[day.date]||'';
      h+=`<div class="note-wrap"><textarea class="note-in" placeholder="Notas del d√≠a..." oninput="sN('${day.date}',this.value)" onfocus="this.style.minHeight='60px'" onblur="this.style.minHeight='36px'">${nv}</textarea></div>`;
      h+=S.add?`<div class="add-f"><div class="fr"><input class="fi tm" id="nt" placeholder="Hora"><input class="fi" id="nn" placeholder="T√≠tulo"></div><div class="fr"><input class="fi" id="nd" placeholder="Detalle"></div><div class="fr"><select class="fs" id="ny"><option value="tourism">Turismo</option><option value="transport">Transporte</option><option value="food">Comida</option><option value="f1">F1</option><option value="flight">Vuelo</option></select></div><div class="fa"><button class="btn-go" onclick="addE('${day.date}')">Agregar</button><button class="btn-no" onclick="S.add=false;R()">√ó</button></div></div>`:`<button class="add-b" onclick="event.stopPropagation();S.add=true;R()">+ Agregar actividad</button>`;
    }
    h+=`</div></div></div>`;
  });
  h+=`<div style="display:flex;gap:8px;margin:8px 0">
    <button class="add-day-btn" onclick="openAddDay()" style="flex:1">+ D√≠a</button>
    <button class="add-day-btn" onclick="openAddCity()" style="flex:1;color:var(--red)">+ Ciudad</button>
  </div>`;
  h+=`</div></div>`;

  // CHECKLIST
  if(S.ck){
    const dn=S.ck.filter(i=>i.done).length,tt=S.ck.length,pct=tt?Math.round(dn/tt*100):0;
    const catN={docs:"Docs",f1:"F1",aloj:"Aloj",equip:"Equip",otro:"Otro"};
    h+=`<div class="section">
      <div class="sec-hdr ${S.showCk?'open':''}" onclick="S.showCk=!S.showCk;R()">
        <div class="sec-hdr-left"><span class="sec-hdr-ic">üß≥</span><h2>Checklist</h2></div>
        <div style="display:flex;align-items:center;gap:8px"><span class="badge">${dn}/${tt}</span><span class="chev">‚ñº</span></div>
      </div>
      <div class="sec-body ${S.showCk?'':'closed'}" style="max-height:${S.showCk?2000:0}px">
        <div class="ck-bar"><div class="ck-fill" style="width:${pct}%"></div></div>`;
    S.ck.forEach((item,i)=>{h+=`<div class="ck-item ${item.done?'done':''}" onclick="tCK(${i})"><div class="ck-box">${item.done?'‚úì':''}</div><div class="ck-txt">${item.text}</div><div class="ck-cat">${catN[item.cat]||'Otro'}</div></div>`});
    h+=`<div class="ck-add"><input class="ck-inp" id="ckI" placeholder="Agregar..." onkeydown="if(event.key==='Enter')aCK()"><button class="ck-btn" onclick="aCK()">+</button></div></div></div>`;
  }

  // EXPENSES
  const exps=S.exp||[],total=exps.reduce((s,e)=>s+Number(e.amount||0),0);
  const byC={};exps.forEach(e=>{byC[e.city]=(byC[e.city]||0)+Number(e.amount||0)});
  const cI={comida:"üçΩÔ∏è",transporte:"üöå",alojamiento:"üè®",entradas:"üéüÔ∏è",compras:"üõçÔ∏è",otro:"üí∞"};
  h+=`<div class="section" style="margin-bottom:120px">
    <div class="sec-hdr ${S.showExp?'open':''}" onclick="S.showExp=!S.showExp;R()">
      <div class="sec-hdr-left"><span class="sec-hdr-ic">üí∞</span><h2>Gastos</h2></div>
      <div style="display:flex;align-items:center;gap:8px"><span class="badge">‚Ç¨${total.toFixed(0)}</span><span class="chev">‚ñº</span></div>
    </div>
    <div class="sec-body ${S.showExp?'':'closed'}" style="max-height:${S.showExp?3000:0}px">`;
  if(Object.keys(byC).length){h+=`<div class="exp-cities">${Object.entries(byC).map(([c,a])=>`<div class="exp-city"><div class="exp-city-n">${c}</div><div class="exp-city-a">‚Ç¨${a.toFixed(0)}</div></div>`).join('')}</div>`}
  if(exps.length){h+=`<div class="exp-list">${exps.slice().reverse().map((e,ri)=>{const i=exps.length-1-ri;return`<div class="exp-row"><div class="exp-row-ic">${cI[e.cat]||'üí∞'}</div><div class="exp-row-nfo"><div class="exp-row-n">${e.desc}</div><div class="exp-row-d">${e.city} ¬∑ ${e.date||''}</div></div><div class="exp-row-a">‚Ç¨${Number(e.amount).toFixed(0)}</div><button class="exp-row-x" onclick="dExp(${i})">√ó</button></div>`}).join('')}</div>`}
  h+=`<div class="exp-form">
    <div class="exp-fr"><input class="fi" id="eD" placeholder="Descripci√≥n" style="flex:2"><div style="display:flex;align-items:center;gap:2px;flex:1"><span class="exp-cur">‚Ç¨</span><input class="fi" id="eA" placeholder="0" type="number" style="flex:1"></div></div>
    <div class="exp-fr"><select class="fs" id="eC" style="flex:1">${getCTS().filter(c=>c!=='Todos').map(c=>`<option>${c}</option>`).join('')}</select><select class="fs" id="eCat" style="flex:1"><option value="comida">Comida</option><option value="transporte">Transporte</option><option value="alojamiento">Alojamiento</option><option value="entradas">Entradas</option><option value="compras">Compras</option><option value="otro">Otro</option></select><button class="btn-go" onclick="aExp()" style="flex:0;padding:9px 16px">+</button></div>
  </div></div></div>`;

  // Modal Share
  if(S.modal){const u=location.href;h+=`<div class="mbg" onclick="cM()"><div class="msh" onclick="event.stopPropagation()"><h2>üîó Compartir</h2><p>Mand√°le este link a tu compa√±ero de viaje. Los cambios se sincronizan al instante.</p><div class="sbox"><span>${u}</span><button class="cpb" onclick="cpL()">Copiar</button></div><button class="clb" onclick="cM()">Cerrar</button></div></div>`}

  // Day Modal (simplified)
  if(S.dayModal){
    const isEdit=S.dayModal==='edit';
    const isQuick=S.dayModal==='quick';
    const isCity=S.dayModal==='addCity';
    const tripCities=[...new Set(S.data.map(d=>d.city).filter(c=>c!=='Vuelo'))];
    const presetCities=Object.keys(DEFAULT_CC).filter(c=>c!=='Vuelo'&&!tripCities.includes(c));
    const allCities=[...tripCities,...presetCities];
    h+=`<div class="mbg" onclick="closeDM()"><div class="msh" onclick="event.stopPropagation()">`;

    if(isQuick){
      h+=`<h2>‚ûï D√≠a en ${S.dmCity}</h2>
        <div class="dm-lbl">Fecha</div>
        <input class="fi" type="date" id="dmDate" value="${S.dmDate}" min="2026-05-01" max="2026-07-31" onchange="S.dmDate=this.value" style="width:100%">
        <div class="dm-actions">
          <button class="dm-btn secondary" onclick="closeDM()">Cancelar</button>
          <button class="dm-btn primary" onclick="saveAddDay()">Agregar</button>
        </div>`;
    } else if(isCity){
      h+=`<h2>üèôÔ∏è Nueva ciudad</h2>
        <div class="dm-lbl">Ciudad</div>
        <div class="dm-cities">${allCities.map(c=>`<div class="dm-city ${S.dmCity===c?'sel':''}" onclick="S.dmCity='${c}';S.dmColor=DEFAULT_CC['${c}']||'#888';S.dmIcon=cityIconFor('${c}');S.dmCustomCity='';R()"><div class="dm-city-ic">${cityIconFor(c)}</div><div class="dm-city-n">${c}</div></div>`).join('')}</div>
        <div class="dm-custom"><input class="fi" id="dmCustom" placeholder="Otra ciudad..." value="${S.dmCustomCity}" oninput="S.dmCustomCity=this.value;S.dmCity='';R()" style="flex:1"></div>
        <div style="display:flex;gap:8px;margin-top:12px">
          <div style="flex:1"><div class="dm-lbl">Desde</div><input class="fi" type="date" id="dmDate" value="${S.dmDate}" min="2026-05-01" max="2026-07-31" onchange="S.dmDate=this.value" style="width:100%"></div>
          <div style="width:80px"><div class="dm-lbl">D√≠as</div><input class="fi" type="number" id="dmDays" value="${S.dmDays||2}" min="1" max="30" onchange="S.dmDays=Number(this.value)" style="width:100%"></div>
        </div>
        <div class="dm-actions">
          <button class="dm-btn secondary" onclick="closeDM()">Cancelar</button>
          <button class="dm-btn primary" onclick="saveAddCity()">Agregar</button>
        </div>`;
    } else if(isEdit){
      h+=`<h2>‚úèÔ∏è Editar d√≠a</h2>
        <div class="dm-lbl">Ciudad</div>
        <div class="dm-cities">${allCities.map(c=>`<div class="dm-city ${S.dmCity===c?'sel':''}" onclick="S.dmCity='${c}';S.dmColor=DEFAULT_CC['${c}']||'#888';S.dmIcon=cityIconFor('${c}');S.dmCustomCity='';R()"><div class="dm-city-ic">${cityIconFor(c)}</div><div class="dm-city-n">${c}</div></div>`).join('')}</div>
        <div class="dm-custom"><input class="fi" id="dmCustom" placeholder="Otra ciudad..." value="${S.dmCustomCity}" oninput="S.dmCustomCity=this.value;S.dmCity='';R()" style="flex:1"></div>
        <div class="dm-actions">
          <button class="dm-btn secondary" onclick="closeDM()">Cancelar</button>
          <button class="dm-btn primary" onclick="saveEditDay()">Guardar</button>
        </div>`;
    } else {
      h+=`<h2>üìÖ Agregar d√≠a</h2>
        <div class="dm-lbl">Ciudad</div>
        <div class="dm-cities">${allCities.map(c=>`<div class="dm-city ${S.dmCity===c?'sel':''}" onclick="S.dmCity='${c}';S.dmColor=DEFAULT_CC['${c}']||'#888';S.dmIcon=cityIconFor('${c}');S.dmCustomCity='';R()"><div class="dm-city-ic">${cityIconFor(c)}</div><div class="dm-city-n">${c}</div></div>`).join('')}</div>
        <div class="dm-custom"><input class="fi" id="dmCustom" placeholder="Otra ciudad..." value="${S.dmCustomCity}" oninput="S.dmCustomCity=this.value;S.dmCity='';R()" style="flex:1"></div>
        <div class="dm-lbl">Fecha</div>
        <input class="fi" type="date" id="dmDate" value="${S.dmDate}" min="2026-05-01" max="2026-07-31" onchange="S.dmDate=this.value" style="width:100%">
        <div class="dm-actions">
          <button class="dm-btn secondary" onclick="closeDM()">Cancelar</button>
          <button class="dm-btn primary" onclick="saveAddDay()">Agregar</button>
        </div>`;
    }
    h+=`</div></div>`;
  }

  document.getElementById('app').innerHTML=h;
}

function sel(d){S.sel=S.sel===d?null:d;S.add=false;R();if(S.sel)setTimeout(()=>{const e=document.getElementById('day-'+d);if(e)e.scrollIntoView({behavior:'smooth',block:'nearest'})},60)}
function flt(c){S.filt=c;S.sel=null;R()}
function del(d,i){const x=S.data.findIndex(t=>t.date===d);if(x>=0){S.data[x].events.splice(i,1);save();R()}}
function addE(d){const t=document.getElementById('nt').value||'',n=document.getElementById('nn').value,de=document.getElementById('nd').value||'',ty=document.getElementById('ny').value;if(!n)return;const x=S.data.findIndex(t=>t.date===d);if(x>=0){S.data[x].events.push({time:t,title:n,detail:de,type:ty});S.add=false;save();R()}}
function sM(){S.modal=true;R()}
function cM(){S.modal=false;R()}
function cpL(){navigator.clipboard.writeText(location.href).then(()=>{const b=document.querySelector('.cpb');if(b){b.textContent='‚úì';setTimeout(()=>b.textContent='Copiar',1500)}})}
let nT=null;function sN(d,v){S.notes[d]=v;clearTimeout(nT);nT=setTimeout(saveNotes,800)}
function tCK(i){if(S.ck){S.ck[i].done=!S.ck[i].done;saveCK();R()}}
function aCK(){const inp=document.getElementById('ckI');if(!inp||!inp.value.trim())return;S.ck=S.ck||[];S.ck.push({text:inp.value.trim(),done:false,cat:"otro"});saveCK();R()}
function aExp(){const d=document.getElementById('eD'),a=document.getElementById('eA'),c=document.getElementById('eC'),cat=document.getElementById('eCat');if(!d||!d.value.trim()||!a||!a.value)return;S.exp=S.exp||[];S.exp.push({desc:d.value.trim(),amount:Number(a.value),city:c.value,cat:cat.value,date:today()});saveExp();R()}
function dExp(i){S.exp.splice(i,1);saveExp();R()}

// DAY MANAGEMENT
function openAddDay(presetCity){
  if(presetCity){
    // Quick mode: city already known, just pick date
    const cityDays=S.data.filter(d=>d.city===presetCity&&!d.from);
    const lastD=cityDays.length?cityDays[cityDays.length-1].date:'2026-06-05';
    const nd=new Date(lastD+'T12:00:00');nd.setDate(nd.getDate()+1);
    const nds=nd.toISOString().slice(0,10);
    const color=DEFAULT_CC[presetCity]||getCC()[presetCity]||'#888';
    S.dayModal='quick';S.dmDate=nds;S.dmCity=presetCity;S.dmIcon=cityIconFor(presetCity);S.dmColor=color;S.dmCustomCity='';R();
  } else {
    // Full mode
    const lastD=S.data.length?S.data[S.data.length-1].date:'2026-06-05';
    const nd=new Date(lastD+'T12:00:00');nd.setDate(nd.getDate()+1);
    const nds=nd.toISOString().slice(0,10);
    S.dayModal='add';S.dmDate=nds;S.dmCity='';S.dmIcon='üè∞';S.dmColor='#888';S.dmCustomCity='';R();
  }
}
function openAddCity(){
  const lastD=S.data.length?S.data[S.data.length-1].date:'2026-06-05';
  const nd=new Date(lastD+'T12:00:00');nd.setDate(nd.getDate()+1);
  const nds=nd.toISOString().slice(0,10);
  S.dayModal='addCity';S.dmDate=nds;S.dmCity='';S.dmIcon='üèôÔ∏è';S.dmColor='#888';S.dmCustomCity='';S.dmDays=2;R();
}
function openEditDay(date){
  const day=S.data.find(d=>d.date===date);if(!day)return;
  S.dayModal='edit';S.dmDate=date;S.dmCity=day.city;S.dmIcon=day.icon;S.dmColor=day.color;S.dmCustomCity='';R();
}
function closeDM(){S.dayModal=null;R()}
function saveAddDay(){
  const date=S.dmDate||document.getElementById('dmDate')?.value;
  if(!date)return;
  const city=S.dmCustomCity.trim()||S.dmCity;
  if(!city){alert('Eleg√≠ una ciudad');return}
  if(S.data.find(d=>d.date===date)){alert('Ya hay un d√≠a con esa fecha');return}
  const d=new Date(date+'T12:00:00');
  const dayName=DAYS_ES[d.getDay()];
  const dayNum=d.getDate();
  const color=S.dmColor||DEFAULT_CC[city]||'#888';
  const newDay={date,label:`${dayName} ${dayNum}`,city,color,icon:S.dmIcon||cityIconFor(city),events:[{time:'',title:city,detail:'',type:'tourism'}]};
  S.data.push(newDay);
  S.data.sort((a,b)=>a.date.localeCompare(b.date));
  S.dayModal=null;save();R();
}
function saveAddCity(){
  const startDate=S.dmDate||document.getElementById('dmDate')?.value;
  const numDays=S.dmDays||Number(document.getElementById('dmDays')?.value)||1;
  if(!startDate)return;
  const city=S.dmCustomCity.trim()||S.dmCity;
  if(!city){alert('Eleg√≠ una ciudad');return}
  const color=S.dmColor||DEFAULT_CC[city]||'#888';
  const icon=S.dmIcon||cityIconFor(city);
  for(let i=0;i<numDays;i++){
    const d=new Date(startDate+'T12:00:00');d.setDate(d.getDate()+i);
    const ds=d.toISOString().slice(0,10);
    if(S.data.find(x=>x.date===ds))continue;
    const dayName=DAYS_ES[d.getDay()];
    const dayNum=d.getDate();
    S.data.push({date:ds,label:`${dayName} ${dayNum}`,city,color,icon,events:[{time:'',title:city,detail:'',type:'tourism'}]});
  }
  S.data.sort((a,b)=>a.date.localeCompare(b.date));
  S.dayModal=null;save();R();
}
function saveEditDay(){
  const day=S.data.find(d=>d.date===S.dmDate);if(!day)return;
  const city=S.dmCustomCity.trim()||S.dmCity;
  if(!city){alert('Eleg√≠ una ciudad');return}
  day.city=city;
  day.icon=S.dmIcon||day.icon;
  day.color=S.dmColor||DEFAULT_CC[city]||day.color;
  S.dayModal=null;save();R();
}
function delDay(date){
  const day=S.data.find(d=>d.date===date);
  const hasEvents=day&&day.events.length>1;
  if(hasEvents&&!confirm('Este d√≠a tiene actividades. ¬øEliminar?'))return;
  if(!hasEvents&&!confirm('¬øEliminar este d√≠a?'))return;
  S.data=S.data.filter(d=>d.date!==date);
  if(S.sel===date)S.sel=null;
  save();R();
}

function autoScroll(){const td=today(),dates=S.data.map(d=>d.date);let tgt=dates.includes(td)?td:(dates.filter(d=>d>=td)[0]||null);if(tgt){S.sel=tgt;R();setTimeout(()=>{const el=document.getElementById('day-'+tgt);if(el)el.scrollIntoView({behavior:'smooth',block:'center'})},300)}}

(function(){
  const ch=document.getElementById('checkered');if(ch){const c=Math.ceil(window.innerWidth/12);for(let r=0;r<2;r++)for(let i=0;i<c;i++){const s=document.createElement('span');s.style.background=(r+i)%2===0?'#fff':'#222';ch.appendChild(s)}}
  initFB();R();
  setTimeout(()=>{const sp=document.getElementById('splash');if(sp){sp.classList.add('hide');setTimeout(()=>{sp.remove()},600)}},2600);
})();
</script>
</body>
</html>
