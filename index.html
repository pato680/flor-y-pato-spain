<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#000000">
<title>Flor & Pato â€” EspaÃ±a 2026</title>
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Titillium+Web:wght@400;600;700;900&display=swap');
:root{
  --bg:#000;--card:#1a1a1a;--text:#fff;--sub:#888;--r:6px;--accent:#e10600;--border:#2a2a2a;
  --madrid:#D71920;--barcelona:#004D98;--valencia:#FF6B2B;--vuelo:#6366f1;
  --safe-top:env(safe-area-inset-top,0px);--safe-bot:env(safe-area-inset-bottom,0px);
  --shadow-sm:none;--shadow-md:none;--shadow-lg:none;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Titillium Web',-apple-system,BlinkMacSystemFont,'SF Pro',sans-serif;background:var(--bg);color:var(--text);-webkit-tap-highlight-color:transparent;overflow-x:hidden;-webkit-font-smoothing:antialiased;letter-spacing:-.01em}

/* â”€â”€ SPLASH â”€â”€ */
#splash{position:fixed;inset:0;z-index:9999;background:#0a0e1a;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:all .8s cubic-bezier(.4,0,.2,1)}
#splash.hide{opacity:0;pointer-events:none;transform:scale(1.08);filter:blur(8px)}
#splash::before{content:'';position:absolute;inset:0;background:repeating-linear-gradient(45deg,transparent,transparent 2px,rgba(255,255,255,.015) 2px,rgba(255,255,255,.015) 4px);pointer-events:none}
#splash::after{content:'';position:absolute;width:300px;height:300px;border-radius:50%;background:radial-gradient(circle,rgba(239,0,0,.08),transparent 70%);animation:ambientGlow 4s ease-in-out infinite alternate;pointer-events:none}
@keyframes ambientGlow{0%{transform:translate(-60px,-40px) scale(.8);opacity:.5}100%{transform:translate(60px,40px) scale(1.2);opacity:1}}
.splash-flag{width:72px;height:45px;border-radius:3px;overflow:hidden;margin-bottom:28px;animation:flagWave 2.5s ease-in-out infinite,flagAppear .8s cubic-bezier(.16,1,.3,1) both;box-shadow:0 8px 32px rgba(0,0,0,.4);position:relative;z-index:1}
@keyframes flagAppear{from{opacity:0;transform:scale(.3) rotate(-20deg);filter:blur(8px)}to{opacity:1;transform:scale(1) rotate(-2deg);filter:blur(0)}}
.splash-flag div{height:25%}
.splash-flag div:nth-child(1),.splash-flag div:nth-child(4){background:#c60b1e}
.splash-flag div:nth-child(2),.splash-flag div:nth-child(3){background:#ffc400}
@keyframes flagWave{0%,100%{transform:rotate(-2deg) scale(1)}50%{transform:rotate(2deg) scale(1.04)}}
.splash-title{font-size:28px;font-weight:900;color:#fff;letter-spacing:-.5px;margin-bottom:4px;animation:textReveal .6s cubic-bezier(.16,1,.3,1) .3s both;position:relative;z-index:1}
.splash-sub{font-size:12px;color:rgba(255,255,255,.3);letter-spacing:5px;text-transform:uppercase;margin-bottom:40px;font-weight:500;animation:textReveal .6s cubic-bezier(.16,1,.3,1) .4s both;position:relative;z-index:1}
@keyframes textReveal{from{opacity:0;transform:translateY(20px);filter:blur(6px)}to{opacity:1;transform:translateY(0);filter:blur(0)}}
.splash-lights{display:flex;gap:10px;margin-bottom:24px;animation:lightsAppear .4s cubic-bezier(.16,1,.3,1) .5s both;position:relative;z-index:1;background:rgba(0,0,0,.4);padding:8px 16px;border-radius:6px;border:1px solid rgba(255,255,255,.06)}
@keyframes lightsAppear{from{opacity:0;transform:scaleX(.5)}to{opacity:1;transform:scaleX(1)}}
.splash-lights span{width:16px;height:16px;border-radius:4px;background:#1a1a1a;border:1px solid #2a2a2a;box-shadow:inset 0 2px 4px rgba(0,0,0,.8),0 1px 1px rgba(255,255,255,.03)}
.splash-lights span:nth-child(1){animation:f1L1 6s .8s infinite}
.splash-lights span:nth-child(2){animation:f1L2 6s .8s infinite}
.splash-lights span:nth-child(3){animation:f1L3 6s .8s infinite}
.splash-lights span:nth-child(4){animation:f1L4 6s .8s infinite}
.splash-lights span:nth-child(5){animation:f1L5 6s .8s infinite}
@keyframes f1L1{0%,9%{background:#1a1a1a;box-shadow:inset 0 2px 4px rgba(0,0,0,.8)}10%,59%{background:radial-gradient(circle at 40% 35%,#ff3030,#cc0000);box-shadow:0 0 8px #ef0000,0 0 20px rgba(239,0,0,.6),0 0 40px rgba(239,0,0,.2),inset 0 -2px 4px rgba(0,0,0,.3)}60%,100%{background:#1a1a1a;box-shadow:inset 0 2px 4px rgba(0,0,0,.8)}}
@keyframes f1L2{0%,19%{background:#1a1a1a;box-shadow:inset 0 2px 4px rgba(0,0,0,.8)}20%,59%{background:radial-gradient(circle at 40% 35%,#ff3030,#cc0000);box-shadow:0 0 8px #ef0000,0 0 20px rgba(239,0,0,.6),0 0 40px rgba(239,0,0,.2),inset 0 -2px 4px rgba(0,0,0,.3)}60%,100%{background:#1a1a1a;box-shadow:inset 0 2px 4px rgba(0,0,0,.8)}}
@keyframes f1L3{0%,29%{background:#1a1a1a;box-shadow:inset 0 2px 4px rgba(0,0,0,.8)}30%,59%{background:radial-gradient(circle at 40% 35%,#ff3030,#cc0000);box-shadow:0 0 8px #ef0000,0 0 20px rgba(239,0,0,.6),0 0 40px rgba(239,0,0,.2),inset 0 -2px 4px rgba(0,0,0,.3)}60%,100%{background:#1a1a1a;box-shadow:inset 0 2px 4px rgba(0,0,0,.8)}}
@keyframes f1L4{0%,39%{background:#1a1a1a;box-shadow:inset 0 2px 4px rgba(0,0,0,.8)}40%,59%{background:radial-gradient(circle at 40% 35%,#ff3030,#cc0000);box-shadow:0 0 8px #ef0000,0 0 20px rgba(239,0,0,.6),0 0 40px rgba(239,0,0,.2),inset 0 -2px 4px rgba(0,0,0,.3)}60%,100%{background:#1a1a1a;box-shadow:inset 0 2px 4px rgba(0,0,0,.8)}}
@keyframes f1L5{0%,49%{background:#1a1a1a;box-shadow:inset 0 2px 4px rgba(0,0,0,.8)}50%,59%{background:radial-gradient(circle at 40% 35%,#ff3030,#cc0000);box-shadow:0 0 8px #ef0000,0 0 20px rgba(239,0,0,.6),0 0 40px rgba(239,0,0,.2),inset 0 -2px 4px rgba(0,0,0,.3)}60%,100%{background:#1a1a1a;box-shadow:inset 0 2px 4px rgba(0,0,0,.8)}}
.splash-circuit{font-size:10px;color:rgba(255,255,255,.2);letter-spacing:3px;text-transform:uppercase;font-weight:500;animation:textReveal .6s cubic-bezier(.16,1,.3,1) .7s both;position:relative;z-index:1}
.splash-gp{font-size:14px;color:rgba(255,255,255,.6);font-weight:700;margin-bottom:6px;letter-spacing:.5px;animation:textReveal .6s cubic-bezier(.16,1,.3,1) .2s both;position:relative;z-index:1}
.splash-car{position:absolute;bottom:25%;left:-60px;font-size:28px;z-index:2;animation:splashCar 1.8s cubic-bezier(.2,.8,.3,1) 1s both;filter:drop-shadow(0 4px 12px rgba(0,0,0,.5))}
@keyframes splashCar{0%{transform:translateX(0) scale(.8);opacity:0}5%{opacity:1;transform:translateX(10vw) scale(.9)}40%{transform:translateX(50vw) scale(1)}100%{transform:translateX(calc(100vw + 60px)) scale(1);opacity:1}}
.splash-speed{position:absolute;width:100%;height:100%;pointer-events:none;overflow:hidden;z-index:1}
.splash-speed span{position:absolute;height:1px;background:linear-gradient(90deg,transparent,rgba(239,0,0,.4),rgba(255,200,0,.2),transparent);animation:speedLine 1.5s linear infinite}
.splash-speed span:nth-child(1){top:28%;width:80px;left:-80px;animation-delay:0s;animation-duration:1.8s}
.splash-speed span:nth-child(2){top:45%;width:120px;left:-120px;animation-delay:.3s;animation-duration:1.2s}
.splash-speed span:nth-child(3){top:62%;width:60px;left:-60px;animation-delay:.7s;animation-duration:2s}
.splash-speed span:nth-child(4){top:38%;width:100px;left:-100px;animation-delay:1.1s;animation-duration:1.4s}
.splash-speed span:nth-child(5){top:72%;width:70px;left:-70px;animation-delay:.5s;animation-duration:1.7s}
@keyframes speedLine{from{transform:translateX(0);opacity:0}10%{opacity:1}90%{opacity:1}to{transform:translateX(calc(100vw + 150px));opacity:0}}

/* â”€â”€ TAB BAR â”€â”€ */
.tab-bar{position:fixed;bottom:0;left:0;right:0;z-index:800;background:rgba(15,15,15,.98);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-top:1px solid var(--border);padding:6px 0 calc(6px + var(--safe-bot));display:flex;justify-content:space-around;align-items:center}
.tab-item{display:flex;flex-direction:column;align-items:center;gap:2px;padding:4px 12px;border:none;background:none;cursor:pointer;-webkit-tap-highlight-color:transparent;transition:all .2s}
.tab-icon{font-size:20px;line-height:1;transition:transform .2s cubic-bezier(.16,1,.3,1);filter:grayscale(1) brightness(.6)}
.tab-label{font-size:9px;font-weight:600;color:#555;letter-spacing:.5px;text-transform:uppercase;transition:color .2s}
.tab-item.active .tab-icon{transform:scale(1.1);filter:none}
.tab-item.active .tab-label{color:#fff;font-weight:700}
.tab-item.active::after{content:'';display:block;width:16px;height:2px;border-radius:0;background:var(--accent);margin-top:2px}

/* â”€â”€ PAGE CONTAINER â”€â”€ */
.page{padding:calc(var(--safe-top) + 16px) 16px 0;padding-bottom:calc(80px + var(--safe-bot));min-height:100vh}

/* â”€â”€ SECTION CARDS â”€â”€ */
.card{background:var(--card);border-radius:var(--r);padding:16px;border:1px solid var(--border);margin-bottom:12px;animation:cardIn .3s ease both}
@keyframes cardIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.card-title{font-size:12px;font-weight:700;color:var(--sub);margin-bottom:14px;display:flex;align-items:center;gap:6px;letter-spacing:.5px;text-transform:uppercase}

/* â”€â”€ DASHBOARD: COUNTDOWN â”€â”€ */
.countdown-card{background:var(--card);border-radius:var(--r);color:#fff;position:relative;overflow:hidden;border:1px solid var(--border);margin-bottom:12px;animation:cardIn .3s ease both}
.countdown-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--accent)}

/* Semaphore */
.semaphore{padding:14px 10px 10px;background:linear-gradient(180deg,#0d0d0d,#141414);position:relative}
.semaphore::after{content:'';position:absolute;bottom:0;left:0;right:0;height:1px;background:var(--border)}
.sem-bar{display:flex;justify-content:center;gap:0;position:relative;padding:0 6px}
.sem-bar::before{content:'';position:absolute;top:50%;left:6px;right:6px;height:5px;background:linear-gradient(180deg,#2a2a2a,#181818);transform:translateY(-50%);z-index:0;border:1px solid #333}
.sem-col{width:42px;display:flex;flex-direction:column;align-items:center;gap:4px;position:relative;z-index:1;padding:7px 3px;background:linear-gradient(180deg,#161616,#0c0c0c);border:1px solid #2a2a2a;border-radius:3px}
.sem-col::before{content:'';position:absolute;top:-2px;left:-1px;right:-1px;height:6px;background:linear-gradient(180deg,#2a2a2a,#181818);border-radius:2px 2px 0 0;border:1px solid #333;border-bottom:none}
.sem-light{width:26px;height:26px;border-radius:50%;background:radial-gradient(circle at 40% 35%,#1a1010,#080404);border:2px solid #111;box-shadow:inset 0 2px 5px rgba(0,0,0,.9),0 0 0 1px #2a2a2a;position:relative}
.sem-light::before{content:'';position:absolute;top:3px;left:5px;width:7px;height:4px;background:radial-gradient(ellipse,rgba(255,255,255,.06),transparent);border-radius:50%;pointer-events:none}
.sem-light::after{content:'';position:absolute;inset:-1px;border-radius:50%;background:conic-gradient(from 0deg,rgba(50,50,50,.3),rgba(70,70,70,.1),rgba(50,50,50,.3),rgba(70,70,70,.1),rgba(50,50,50,.3));pointer-events:none}
.sem-col:nth-child(1) .sem-light{animation:semL1 6s infinite}
.sem-col:nth-child(2) .sem-light{animation:semL2 6s infinite}
.sem-col:nth-child(3) .sem-light{animation:semL3 6s infinite}
.sem-col:nth-child(4) .sem-light{animation:semL4 6s infinite}
.sem-col:nth-child(5) .sem-light{animation:semL5 6s infinite}
@keyframes semL1{0%,9%{background:radial-gradient(circle at 40% 35%,#1a1010,#080404);box-shadow:inset 0 2px 5px rgba(0,0,0,.9),0 0 0 1px #2a2a2a}10%,59%{background:radial-gradient(circle at 35% 30%,#ff4040,#ee1111 40%,#aa0000 70%,#660000);box-shadow:inset 0 -2px 5px rgba(0,0,0,.3),0 0 10px #ff0000,0 0 25px rgba(255,0,0,.5),0 0 50px rgba(255,0,0,.12),0 0 0 1px #ff2222}60%,100%{background:radial-gradient(circle at 40% 35%,#1a1010,#080404);box-shadow:inset 0 2px 5px rgba(0,0,0,.9),0 0 0 1px #2a2a2a}}
@keyframes semL2{0%,19%{background:radial-gradient(circle at 40% 35%,#1a1010,#080404);box-shadow:inset 0 2px 5px rgba(0,0,0,.9),0 0 0 1px #2a2a2a}20%,59%{background:radial-gradient(circle at 35% 30%,#ff4040,#ee1111 40%,#aa0000 70%,#660000);box-shadow:inset 0 -2px 5px rgba(0,0,0,.3),0 0 10px #ff0000,0 0 25px rgba(255,0,0,.5),0 0 50px rgba(255,0,0,.12),0 0 0 1px #ff2222}60%,100%{background:radial-gradient(circle at 40% 35%,#1a1010,#080404);box-shadow:inset 0 2px 5px rgba(0,0,0,.9),0 0 0 1px #2a2a2a}}
@keyframes semL3{0%,29%{background:radial-gradient(circle at 40% 35%,#1a1010,#080404);box-shadow:inset 0 2px 5px rgba(0,0,0,.9),0 0 0 1px #2a2a2a}30%,59%{background:radial-gradient(circle at 35% 30%,#ff4040,#ee1111 40%,#aa0000 70%,#660000);box-shadow:inset 0 -2px 5px rgba(0,0,0,.3),0 0 10px #ff0000,0 0 25px rgba(255,0,0,.5),0 0 50px rgba(255,0,0,.12),0 0 0 1px #ff2222}60%,100%{background:radial-gradient(circle at 40% 35%,#1a1010,#080404);box-shadow:inset 0 2px 5px rgba(0,0,0,.9),0 0 0 1px #2a2a2a}}
@keyframes semL4{0%,39%{background:radial-gradient(circle at 40% 35%,#1a1010,#080404);box-shadow:inset 0 2px 5px rgba(0,0,0,.9),0 0 0 1px #2a2a2a}40%,59%{background:radial-gradient(circle at 35% 30%,#ff4040,#ee1111 40%,#aa0000 70%,#660000);box-shadow:inset 0 -2px 5px rgba(0,0,0,.3),0 0 10px #ff0000,0 0 25px rgba(255,0,0,.5),0 0 50px rgba(255,0,0,.12),0 0 0 1px #ff2222}60%,100%{background:radial-gradient(circle at 40% 35%,#1a1010,#080404);box-shadow:inset 0 2px 5px rgba(0,0,0,.9),0 0 0 1px #2a2a2a}}
@keyframes semL5{0%,49%{background:radial-gradient(circle at 40% 35%,#1a1010,#080404);box-shadow:inset 0 2px 5px rgba(0,0,0,.9),0 0 0 1px #2a2a2a}50%,59%{background:radial-gradient(circle at 35% 30%,#ff4040,#ee1111 40%,#aa0000 70%,#660000);box-shadow:inset 0 -2px 5px rgba(0,0,0,.3),0 0 10px #ff0000,0 0 25px rgba(255,0,0,.5),0 0 50px rgba(255,0,0,.12),0 0 0 1px #ff2222}60%,100%{background:radial-gradient(circle at 40% 35%,#1a1010,#080404);box-shadow:inset 0 2px 5px rgba(0,0,0,.9),0 0 0 1px #2a2a2a}}

/* Info strip */
.cd-info{display:flex;justify-content:space-between;align-items:center;padding:12px 14px}
.cd-left{display:flex;align-items:baseline;gap:8px}
.cd-num{font-size:38px;font-weight:900;color:#fff;line-height:1;letter-spacing:-2px}
.cd-lbl{font-size:11px;color:var(--sub);text-transform:uppercase;letter-spacing:1px;font-weight:700}
.cd-right{text-align:right}
.cd-title{font-size:11px;font-weight:700;color:var(--sub);text-transform:uppercase;letter-spacing:.8px}
.cd-date{font-size:11px;color:#555;margin-top:2px}

/* â”€â”€ DASHBOARD: SUMMARY ROW â”€â”€ */
.dash-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px}
.dash-mini{background:var(--card);border-radius:var(--r);padding:14px;border:1px solid var(--border);animation:cardIn .3s ease both}
.dash-mini-label{font-size:10px;font-weight:700;color:var(--sub);text-transform:uppercase;letter-spacing:.8px;margin-bottom:6px}
.dash-mini-value{font-size:22px;font-weight:900;color:#fff;letter-spacing:-.5px}
.dash-mini-sub{font-size:11px;color:#555;font-weight:500;margin-top:2px}
.dash-mini .ck-progress{margin-top:8px}

/* â”€â”€ DASHBOARD: NEXT EVENT â”€â”€ */
.next-event{background:var(--card);border-radius:var(--r);padding:14px;border:1px solid var(--border);margin-bottom:12px;display:flex;align-items:center;gap:12px;animation:cardIn .3s ease both}
.next-event-badge{width:40px;height:40px;border-radius:var(--r);display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:800;color:#fff;flex-shrink:0}
.next-event-info{flex:1}
.next-event-label{font-size:10px;font-weight:700;color:var(--accent);text-transform:uppercase;letter-spacing:.8px}
.next-event-title{font-size:14px;font-weight:700;color:#fff;margin-top:2px}
.next-event-detail{font-size:11px;color:var(--sub);margin-top:1px}

/* â”€â”€ CALENDAR â”€â”€ */
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;text-align:center}
.cal-hdr{font-size:10px;color:#555;font-weight:700;padding:6px 0;text-transform:uppercase;letter-spacing:.5px}
.cal-day{aspect-ratio:1;display:flex;flex-direction:column;align-items:center;justify-content:center;border-radius:4px;font-size:13px;font-weight:500;color:var(--sub);cursor:pointer;position:relative;transition:all .15s ease}
.cal-day.empty{pointer-events:none}
.cal-day.trip{font-weight:700;color:#fff}
.cal-day.sel{background:var(--accent);color:#fff;transform:scale(1.08)}
.cal-day .bar{position:absolute;bottom:3px;left:12%;right:12%;height:2px;border-radius:1px}
.cal-day .split-bar{position:absolute;bottom:3px;height:2px;border-radius:1px}
.cal-day .f1-dot{position:absolute;top:3px;right:3px;width:4px;height:4px;background:var(--accent);border-radius:50%;box-shadow:0 0 4px rgba(225,6,0,.5);animation:dotPulse 2s ease-in-out infinite}
@keyframes dotPulse{0%,100%{box-shadow:0 0 4px rgba(225,6,0,.4)}50%{box-shadow:0 0 8px rgba(225,6,0,.6)}}
.cal-today{box-shadow:inset 0 0 0 1px #fff}
.cal-legend{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px;padding-top:10px;border-top:1px solid var(--border)}
.cal-legend-item{display:flex;align-items:center;gap:5px;font-size:10px;color:var(--sub);font-weight:500}
.cal-legend-item span{width:8px;height:8px;border-radius:2px;display:inline-block}
.wx-row{display:flex;gap:2px;margin-top:8px}
.wx-cell{flex:1;text-align:center;font-size:9px;color:#555;line-height:1.3;font-weight:500}

/* â”€â”€ ITINERARY: FILTERS â”€â”€ */
.filters{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;position:sticky;top:calc(var(--safe-top) + 8px);z-index:50;padding:8px 0}
.filt-btn{padding:6px 14px;border-radius:4px;border:1px solid var(--border);background:transparent;color:var(--sub);font-size:11px;font-weight:700;cursor:pointer;transition:all .15s ease;text-transform:uppercase;letter-spacing:.5px}
.filt-btn.act{background:var(--accent);color:#fff;border-color:var(--accent)}

/* â”€â”€ ITINERARY: ROUTE BAR â”€â”€ */
.route-bar{display:flex;align-items:center;gap:0;height:26px;margin-bottom:12px}
.route-seg{height:4px;border-radius:0;position:relative;opacity:.9}
.route-seg:first-child{border-radius:2px 0 0 2px}
.route-seg:last-child{border-radius:0 2px 2px 0}
.route-lbl{font-size:9px;color:var(--sub);text-align:center;margin-top:3px;white-space:nowrap;font-weight:600}
.route-arrow{font-size:9px;color:#444;margin:0 -1px;z-index:1}

/* â”€â”€ TIMELINE â”€â”€ */
.tl-wrap{position:relative;padding-left:40px;margin-left:0}
.tl-wrap::before{content:'';position:absolute;top:0;bottom:0;left:15px;width:2px;background:linear-gradient(180deg,var(--accent) 0%,#333 20%,#333 80%,var(--accent) 100%)}

/* City node */
.tl-city{position:relative;margin-top:24px;margin-bottom:12px}
.tl-city:first-child{margin-top:0}
.tl-city-node{position:absolute;left:-40px;top:50%;transform:translateY(-50%);width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;z-index:2;border:3px solid var(--bg);box-shadow:0 0 0 2px currentColor}
.tl-city-info{display:flex;align-items:center;gap:10px;padding:8px 14px;background:var(--card);border:1px solid var(--border);border-radius:var(--r)}
.tl-city-name{font-size:15px;font-weight:900;color:#fff;text-transform:uppercase;letter-spacing:1px}
.tl-city-dates{font-size:11px;color:#666;font-weight:600;margin-left:4px}
.tl-city-add{margin-left:auto;background:transparent;border:1px solid var(--border);color:#555;width:28px;height:28px;border-radius:4px;font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s}
.tl-city-add:active{background:var(--border);color:#fff}

/* Transit */
.tl-transit{position:relative;padding:8px 0;margin:4px 0}
.tl-transit-node{position:absolute;left:-36px;top:50%;transform:translateY(-50%);width:12px;height:12px;border-radius:50%;background:#333;border:2px solid var(--bg);z-index:2}
.tl-transit-text{font-size:11px;color:#555;font-weight:700;text-transform:uppercase;letter-spacing:1px;display:flex;align-items:center;gap:6px;padding-left:4px}

/* Day row */
.tl-day{position:relative;padding:6px 0 6px 4px;cursor:pointer}
.tl-day-dot{position:absolute;left:-37px;top:12px;width:8px;height:8px;border-radius:50%;z-index:2;border:2px solid var(--bg)}
.tl-day-head{display:flex;align-items:baseline;gap:8px;padding:4px 0}
.tl-day-num{font-size:13px;font-weight:900;color:#fff;min-width:20px}
.tl-day-label{font-size:12px;font-weight:600;color:#888}
.tl-day-f1{display:inline-flex;align-items:center;background:var(--accent);color:#fff;font-size:8px;font-weight:900;padding:1px 5px;border-radius:2px;letter-spacing:.5px;text-transform:uppercase;margin-left:4px;vertical-align:middle}

/* Events â€” always visible */
.tl-events{display:flex;flex-direction:column;gap:2px;padding:2px 0 8px}
.tl-ev{display:flex;align-items:flex-start;gap:8px;padding:6px 10px;background:var(--card);border-radius:4px;border:1px solid var(--border);transition:background .15s}
.tl-ev:active{background:#222}
.tl-ev-pip{width:4px;align-self:stretch;border-radius:2px;flex-shrink:0}
.tl-ev-body{flex:1;min-width:0}
.tl-ev-title{font-weight:600;color:#ddd;font-size:13px}
.tl-ev-detail{color:#555;font-size:11px;margin-top:1px}
.tl-ev-time{color:#666;font-size:10px;font-weight:700;flex-shrink:0;font-variant-numeric:tabular-nums;padding-top:2px}
.tl-ev-del{color:#333;font-size:13px;cursor:pointer;padding:2px 4px;flex-shrink:0;transition:color .15s}
.tl-ev-del:active{color:var(--accent)}
.tl-add-ev{padding:6px 10px;color:#333;font-size:11px;font-weight:700;cursor:pointer;transition:color .15s;text-transform:uppercase;letter-spacing:.5px}
.tl-add-ev:active{color:#888}

/* â”€â”€ CHECKLIST â”€â”€ */
.ck-list{margin-top:6px}
.ck-item{display:flex;align-items:center;gap:10px;padding:12px 0;border-bottom:1px solid var(--border);font-size:14px;font-weight:500;color:#fff;transition:opacity .2s}
.ck-item.done{text-decoration:line-through;opacity:.3;color:var(--sub)}
.ck-check{width:22px;height:22px;border-radius:3px;border:2px solid #444;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;transition:all .15s ease;font-size:12px}
.ck-check.checked{background:var(--accent);border-color:var(--accent);color:#fff}
.ck-progress{height:3px;background:#222;border-radius:0;overflow:hidden}
.ck-progress-fill{height:100%;background:var(--accent);border-radius:0;transition:width .3s ease}

/* â”€â”€ EXPENSES â”€â”€ */
.exp-total{font-size:36px;font-weight:900;color:#fff;margin-bottom:2px;letter-spacing:-1px}
.exp-sub{font-size:12px;color:var(--sub);margin-bottom:14px;font-weight:500}
.exp-list{max-height:none;overflow-y:auto}
.exp-item{display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border);font-size:13px}
.exp-item-left{display:flex;align-items:center;gap:10px}
.exp-item-icon{width:34px;height:34px;border-radius:4px;background:#222;display:flex;align-items:center;justify-content:center;font-size:15px}
.exp-item-amount{font-weight:900;font-size:15px;color:#fff}

/* â”€â”€ NOTES â”€â”€ */
.notes-area{width:100%;border:1px solid var(--border);border-radius:var(--r);padding:14px;font-size:14px;font-family:inherit;resize:vertical;min-height:calc(100vh - 260px);background:#111;color:#fff;transition:border-color .2s;line-height:1.6}
.notes-area:focus{outline:none;border-color:var(--accent);background:#111}

/* â”€â”€ MODAL â”€â”€ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);z-index:1000;display:flex;align-items:flex-end;justify-content:center;animation:fadeIn .2s ease}
.modal{background:#1a1a1a;border-radius:8px 8px 0 0;padding:24px 20px calc(20px + var(--safe-bot));width:100%;max-width:500px;max-height:80vh;overflow-y:auto;animation:slideUp .25s ease;border-top:3px solid var(--accent)}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal h3{font-size:16px;font-weight:900;margin-bottom:20px;text-align:center;color:#fff;text-transform:uppercase;letter-spacing:.5px}
.modal-field{margin-bottom:16px}
.modal-field label{display:block;font-size:10px;font-weight:700;color:var(--sub);margin-bottom:6px;text-transform:uppercase;letter-spacing:1px}
.modal-field input,.modal-field select,.modal-field textarea{width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:4px;font-size:14px;font-family:inherit;background:#111;color:#fff;transition:all .15s}
.modal-field input:focus,.modal-field select:focus,.modal-field textarea:focus{outline:none;border-color:var(--accent);background:#111}
.modal-field textarea{resize:vertical;min-height:60px}
.modal-chips{display:flex;gap:8px;flex-wrap:wrap}
.modal-chip{padding:8px 14px;border-radius:4px;border:1px solid var(--border);font-size:12px;font-weight:700;cursor:pointer;transition:all .15s;background:transparent;color:var(--sub)}
.modal-chip:active{transform:scale(.95)}
.modal-chip.act{color:#fff;border-color:transparent}
.modal-actions{display:flex;gap:10px;margin-top:20px}
.modal-actions button{flex:1;padding:13px;border-radius:4px;font-size:14px;font-weight:700;cursor:pointer;border:none;transition:all .15s;text-transform:uppercase;letter-spacing:.3px}
.modal-actions button:active{transform:scale(.97)}
.btn-primary{background:var(--accent);color:#fff}
.btn-secondary{background:#222;color:var(--sub)}
.btn-danger{background:rgba(225,6,0,.15);color:var(--accent);font-weight:700}

/* â”€â”€ FAB â”€â”€ */
.fab{position:fixed;bottom:calc(72px + var(--safe-bot));right:20px;width:52px;height:52px;border-radius:4px;background:var(--accent);color:#fff;border:none;font-size:24px;cursor:pointer;z-index:100;display:flex;align-items:center;justify-content:center;transition:all .15s ease}
.fab:active{transform:scale(.9)}
.fab.hidden{opacity:0;pointer-events:none;transform:scale(.5)}

/* â”€â”€ EMPTY STATE â”€â”€ */
.empty-state{text-align:center;padding:40px 20px;color:#555;font-size:13px}
.empty-state-icon{font-size:32px;margin-bottom:8px}
</style>
</head>
<body>

<!-- Splash -->
<div id="splash">
  <div class="splash-speed"><span></span><span></span><span></span><span></span><span></span></div>
  <div class="splash-flag"><div></div><div></div><div></div><div></div></div>
  <div class="splash-gp">GP de Barcelona</div>
  <div class="splash-title">Flor & Pato</div>
  <div class="splash-sub">EspaÃ±a 2026</div>
  <div class="splash-lights"><span></span><span></span><span></span><span></span><span></span></div>
  <div class="splash-circuit">Circuit de Barcelona-Catalunya</div>
  <div class="splash-car">ğŸï¸</div>
</div>

<div id="app"></div>
<div id="fab-container"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DATA_VERSION = 5;

const TRIP = [
  {date:"2026-06-05",label:"Viernes 5",city:"Vuelo",color:"#6366f1",icon:"âœˆï¸",events:[{time:"21:45",title:"Vuelo a Madrid",detail:"IB 170 â€” Salida 9:45pm",type:"flight"}]},
  {date:"2026-06-06",label:"SÃ¡bado 6",city:"Madrid",color:"#D71920",icon:"ğŸ°",events:[{time:"",title:"Llegada a Madrid",detail:"Check-in Airbnb",type:"tourism"}]},
  {date:"2026-06-07",label:"Domingo 7",city:"Madrid",color:"#D71920",icon:"ğŸ°",events:[]},
  {date:"2026-06-08",label:"Lunes 8",city:"Madrid",color:"#D71920",icon:"ğŸ°",events:[]},
  {date:"2026-06-09",label:"Martes 9",city:"Madrid",color:"#D71920",icon:"ğŸ°",events:[]},
  {date:"2026-06-10",label:"MiÃ©rcoles 10",city:"Madrid",color:"#D71920",icon:"ğŸ°",events:[]},
  {date:"2026-06-11",label:"Jueves 11",city:"Barcelona",color:"#004D98",icon:"ğŸš‚",from:"Madrid",fromColor:"#D71920",events:[{time:"",title:"Traslado Madrid â†’ Barcelona",detail:"Tren/aviÃ³n",type:"transport"},{time:"",title:"Airbnb â€” Barcelona",detail:"Check-in",type:"tourism"}]},
  {date:"2026-06-12",label:"Viernes 12",city:"Barcelona",color:"#004D98",icon:"ğŸï¸",events:[{time:"",title:"F1 â€” PrÃ¡ctica Libre",detail:"Circuit de Barcelona-Catalunya",type:"f1"}]},
  {date:"2026-06-13",label:"SÃ¡bado 13",city:"Barcelona",color:"#004D98",icon:"ğŸï¸",events:[{time:"",title:"F1 â€” ClasificaciÃ³n",detail:"Circuit de Barcelona-Catalunya",type:"f1"}]},
  {date:"2026-06-14",label:"Domingo 14",city:"Barcelona",color:"#004D98",icon:"ğŸï¸",events:[{time:"",title:"F1 â€” Carrera",detail:"Circuit de Barcelona-Catalunya",type:"f1"}]},
  {date:"2026-06-15",label:"Lunes 15",city:"Barcelona",color:"#004D98",icon:"ğŸ—ï¸",events:[]},
  {date:"2026-06-16",label:"Martes 16",city:"Barcelona",color:"#004D98",icon:"ğŸ—ï¸",events:[]},
  {date:"2026-06-17",label:"MiÃ©rcoles 17",city:"Valencia",color:"#FF6B2B",icon:"ğŸš‚",from:"Barcelona",fromColor:"#004D98",events:[{time:"",title:"Traslado Barcelona â†’ Valencia",detail:"Tren",type:"transport"},{time:"",title:"Airbnb â€” Valencia",detail:"Check-in",type:"tourism"}]},
  {date:"2026-06-18",label:"Jueves 18",city:"Valencia",color:"#FF6B2B",icon:"ğŸŠ",events:[]},
  {date:"2026-06-19",label:"Viernes 19",city:"Madrid",color:"#D71920",icon:"ğŸš‚",from:"Valencia",fromColor:"#FF6B2B",events:[{time:"",title:"Traslado Valencia â†’ Madrid",detail:"Tren",type:"transport"}]},
  {date:"2026-06-20",label:"SÃ¡bado 20",city:"Vuelo",color:"#6366f1",icon:"âœˆï¸",events:[{time:"",title:"Vuelo de regreso",detail:"Aeropuerto Barajas",type:"flight"}]}
];

const WX={
  "2026-06-05":"ğŸŒ¤ 22Â°","2026-06-06":"â˜€ï¸ 30Â°","2026-06-07":"â˜€ï¸ 31Â°","2026-06-08":"ğŸŒ¤ 29Â°",
  "2026-06-09":"â˜€ï¸ 32Â°","2026-06-10":"ğŸŒ¤ 28Â°","2026-06-11":"â˜€ï¸ 27Â°","2026-06-12":"â˜€ï¸ 28Â°",
  "2026-06-13":"ğŸŒ¤ 26Â°","2026-06-14":"â˜€ï¸ 29Â°","2026-06-15":"â˜€ï¸ 27Â°","2026-06-16":"ğŸŒ¤ 26Â°",
  "2026-06-17":"â˜€ï¸ 30Â°","2026-06-18":"â˜€ï¸ 31Â°","2026-06-19":"ğŸŒ¤ 29Â°","2026-06-20":"â˜€ï¸ 28Â°"
};

const DEFAULT_CK=[];

const MAPS={
  "Madrid":"https://maps.google.com/?q=Madrid,Spain",
  "Barcelona":"https://maps.google.com/?q=Barcelona,Spain",
  "Valencia":"https://maps.google.com/?q=Valencia,Spain",
  "Toledo":"https://maps.google.com/?q=Toledo,Spain"
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let S = {
  data: JSON.parse(JSON.stringify(TRIP)),
  sel: null,
  filt: "Todos",
  notes: {},
  ck: JSON.parse(JSON.stringify(DEFAULT_CK)),
  exp: [],
  tab: 'inicio',
  modal: null,
  on: false
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function cityIconFor(c) {
  const m = {madrid:"ğŸ°",barcelona:"ğŸ—ï¸",valencia:"ğŸŠ",vuelo:"âœˆï¸"};
  return m[c.toLowerCase()] || "ğŸ“";
}

function getCities() {
  const seen = new Set();
  return S.data.filter(d => { if (d.city==="Vuelo"||seen.has(d.city)) return false; seen.add(d.city); return true; }).map(d=>({name:d.city,color:d.color}));
}

function getFilters() {
  return ["Todos", ...getCities().map(c=>c.name)];
}

function getRoute() {
  const r = [];
  S.data.forEach(d => {
    if (r.length===0 || r[r.length-1].city !== d.city) r.push({city:d.city,color:d.color,days:1,icon:d.icon});
    else r[r.length-1].days++;
  });
  return r;
}

function isF1(d) { return d.events.some(e=>e.type==="f1"); }

function countdown() {
  const now = new Date();
  const trip = new Date("2026-06-05T00:00:00");
  const diff = trip - now;
  if (diff <= 0) return {n:0,l:"Â¡Buen viaje!"};
  const days = Math.ceil(diff / 86400000);
  return {n:days,l:days===1?"dÃ­a":"dÃ­as"};
}

function migrateData(data) {
  data.forEach(d => {
    if (d.city==="Toledo") { d.city="Madrid"; d.color="#D71920"; }
    if (!d.events) d.events=[];
  });
  return data;
}

function getNextEvent() {
  var today = new Date().toISOString().slice(0,10);
  for (var i=0;i<S.data.length;i++) {
    if (S.data[i].date >= today && S.data[i].events.length) {
      return {day:S.data[i], event:S.data[i].events[0], idx:i};
    }
  }
  return null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIREBASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let dbRef, notesRef, ckRef, expRef;

function initFB() {
  try {
    firebase.initializeApp({
      apiKey:"AIzaSyDPZPk2nsOQ3oRMG7ADhS56zEFyORTE4QQ",
      authDomain:"flor-y-pato-trip.firebaseapp.com",
      databaseURL:"https://flor-y-pato-trip-default-rtdb.firebaseio.com",
      projectId:"flor-y-pato-trip",
      storageBucket:"flor-y-pato-trip.firebasestorage.app",
      messagingSenderId:"862498607498",
      appId:"1:862498607498:web:7e2ccf24cd913e6cb7c5c3"
    });
    const db = firebase.database();
    dbRef = db.ref("trip-espana-2026");
    notesRef = db.ref("trip-notes-2026");
    ckRef = db.ref("trip-checklist-2026");
    expRef = db.ref("trip-expenses-2026");

    dbRef.on("value", snap => {
      const v = snap.val();
      if (v && v._v === DATA_VERSION) {
        S.data = migrateData(v.days);
        S.on = true; R();
      } else {
        dbRef.set({_v:DATA_VERSION,days:S.data});
        S.on = true;
      }
    });
    notesRef.on("value", snap => { S.notes = snap.val()||{}; R(); });
    ckRef.on("value", snap => { var v=snap.val(); if(v){var arr=Array.isArray(v)?v:Object.values(v);S.ck=arr.filter(function(x){return x&&typeof x==='object'&&'t' in x})}else{S.ck=JSON.parse(JSON.stringify(DEFAULT_CK))} R(); });
    expRef.on("value", snap => { var v=snap.val(); if(v){var arr=Array.isArray(v)?v:Object.values(v);S.exp=arr.filter(function(x){return x&&typeof x==='object'})}else{S.exp=[]} R(); });
  } catch(e) { console.log("FB error",e); }
}

function saveTrip() { if(dbRef) dbRef.set({_v:DATA_VERSION,days:S.data}); }
function saveNotes() { if(notesRef) notesRef.set(S.notes); }
function saveCk() { if(ckRef) ckRef.set(S.ck); }
function saveExp() { if(expRef) expRef.set(S.exp); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAB NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(tab) {
  S.tab = tab;
  S.modal = null;
  window.scrollTo(0,0);
  R();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function R() {
  var content = '';
  if (S.tab==='inicio') content = renderInicio();
  else if (S.tab==='itinerario') content = renderItinerario();
  else if (S.tab==='gastos') content = renderGastos();
  else if (S.tab==='checklist') content = renderChecklist();
  else if (S.tab==='notas') content = renderNotas();

  document.getElementById('app').innerHTML =
    '<div class="page">' + content + '</div>' +
    renderTabBar() +
    (S.modal ? renderModal() : '');

  // FAB
  var fabHTML = '';
  if (S.tab==='itinerario') fabHTML = '<button class="fab" onclick="openAddCity()">+</button>';
  else if (S.tab==='gastos') fabHTML = '<button class="fab" onclick="openAddExpModal()">+</button>';
  document.getElementById('fab-container').innerHTML = fabHTML;
}

function renderTabBar() {
  var tabs = [
    {id:'inicio',icon:'ğŸ ',label:'Inicio'},
    {id:'itinerario',icon:'ğŸ“‹',label:'Itinerario'},
    {id:'gastos',icon:'ğŸ’°',label:'Gastos'},
    {id:'checklist',icon:'âœ…',label:'Checklist'},
    {id:'notas',icon:'ğŸ“',label:'Notas'}
  ];
  return '<nav class="tab-bar">' + tabs.map(function(t){
    var act = S.tab===t.id ? ' active' : '';
    return '<button class="tab-item'+act+'" onclick="switchTab(\''+t.id+'\')">' +
      '<span class="tab-icon">'+t.icon+'</span>' +
      '<span class="tab-label">'+t.label+'</span></button>';
  }).join('') + '</nav>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAB: INICIO (Dashboard)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderInicio() {
  var cd = countdown();
  var ckArr = (S.ck&&Array.isArray(S.ck)) ? S.ck : [];
  var ckDone = ckArr.filter(function(c){return c&&c.d}).length;
  var ckTotal = ckArr.length;
  var ckPct = ckTotal ? (ckDone/ckTotal*100) : 0;
  var expArr = (S.exp&&Array.isArray(S.exp)) ? S.exp : [];
  var expTotal = expArr.reduce(function(s,e){return s+(e.amount||0)},0);
  var next = getNextEvent();

  var html = '';

  // Countdown â€” Semaphore
  html += '<div class="countdown-card">' +
    '<div class="semaphore">' +
      '<div class="sem-bar">' +
        '<div class="sem-col"><div class="sem-light"></div></div>' +
        '<div class="sem-col"><div class="sem-light"></div></div>' +
        '<div class="sem-col"><div class="sem-light"></div></div>' +
        '<div class="sem-col"><div class="sem-light"></div></div>' +
        '<div class="sem-col"><div class="sem-light"></div></div>' +
      '</div>' +
    '</div>' +
    '<div class="cd-info">' +
      '<div class="cd-left"><div class="cd-num">'+cd.n+'</div><div class="cd-lbl">'+cd.l+'</div></div>' +
      '<div class="cd-right"><div class="cd-title">GP Barcelona R07</div><div class="cd-date">Flor & Pato â€” 5â€“20 Jun 2026</div></div>' +
    '</div>' +
  '</div>';

  // Next event
  if (next) {
    html += '<div class="next-event" onclick="switchTab(\'itinerario\');setTimeout(function(){sel('+next.idx+')},100)">' +
      '<div class="next-event-badge" style="background:'+next.day.color+'">'+next.day.icon+'</div>' +
      '<div class="next-event-info">' +
        '<div class="next-event-label">PrÃ³ximo</div>' +
        '<div class="next-event-title">'+next.event.title+'</div>' +
        '<div class="next-event-detail">'+next.day.label+' Â· '+next.day.city+'</div>' +
      '</div>' +
    '</div>';
  }

  // Summary row
  html += '<div class="dash-row">' +
    '<div class="dash-mini" onclick="switchTab(\'checklist\')">' +
      '<div class="dash-mini-label">Checklist</div>' +
      '<div class="dash-mini-value">'+ckDone+'<span style="font-size:14px;color:var(--sub);font-weight:500">/'+ckTotal+'</span></div>' +
      '<div class="ck-progress"><div class="ck-progress-fill" style="width:'+ckPct+'%"></div></div>' +
    '</div>' +
    '<div class="dash-mini" onclick="switchTab(\'gastos\')">' +
      '<div class="dash-mini-label">Gastos</div>' +
      '<div class="dash-mini-value">â‚¬'+expTotal.toLocaleString('es')+'</div>' +
      '<div class="dash-mini-sub">'+S.exp.length+' registro'+(S.exp.length!==1?'s':'')+'</div>' +
    '</div>' +
  '</div>';

  // Calendar
  html += '<div class="card">' +
    '<div class="card-title">ğŸ“… Junio 2026</div>' +
    buildCalendar() +
  '</div>';

  return html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAB: ITINERARIO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderItinerario() {
  var filters = getFilters();
  var route = getRoute();
  var totalDays = S.data.length;

  var filtersHTML = filters.map(function(f){
    var act = S.filt===f ? 'act':'';
    return '<button class="filt-btn '+act+'" onclick="flt(\''+f+'\')">'+f+'</button>';
  }).join('');

  var routeHTML = route.map(function(r,i){
    var pct = (r.days/totalDays*100).toFixed(1);
    var arrow = i < route.length-1 ? '<span class="route-arrow">â€º</span>' : '';
    return '<div style="width:'+pct+'%;display:flex;flex-direction:column;align-items:center">' +
      '<div class="route-seg" style="background:'+r.color+';width:100%"></div>' +
      '<div class="route-lbl">'+(r.city==="Vuelo"?"âœˆï¸":r.icon)+'</div></div>'+arrow;
  }).join('');

  return '<div class="filters">'+filtersHTML+'</div>' +
    '<div class="route-bar">'+routeHTML+'</div>' +
    buildTimeline();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAB: GASTOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderGastos() {
  var total = S.exp.reduce(function(s,e){return s+(e.amount||0)},0);
  var catIcons = {comida:"ğŸ½ï¸",transporte:"ğŸš‡",hotel:"ğŸ¨",entradas:"ğŸŸï¸",shopping:"ğŸ›ï¸",otro:"ğŸ“Œ"};

  var html = '<div class="card">' +
    '<div class="exp-total">â‚¬'+total.toLocaleString('es')+'</div>' +
    '<div class="exp-sub">Total gastado Â· '+S.exp.length+' registro'+(S.exp.length!==1?'s':'')+'</div>';

  if (S.exp.length) {
    html += '<div class="exp-list">';
    S.exp.forEach(function(e,i) {
      html += '<div class="exp-item">' +
        '<div class="exp-item-left"><div class="exp-item-icon">'+(catIcons[e.cat]||'ğŸ“Œ')+'</div>' +
        '<div><div style="font-weight:600">'+e.desc+'</div><div style="font-size:11px;color:var(--sub)">'+(e.date||'')+'</div></div></div>' +
        '<div class="exp-item-amount">â‚¬'+e.amount+'</div></div>';
    });
    html += '</div>';
  } else {
    html += '<div class="empty-state"><div class="empty-state-icon">ğŸ’°</div>No hay gastos registrados<br>TocÃ¡ + para agregar uno</div>';
  }

  html += '</div>';
  return html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAB: CHECKLIST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderChecklist() {
  if (!S.ck||!Array.isArray(S.ck)) S.ck = JSON.parse(JSON.stringify(DEFAULT_CK));
  var done = S.ck.filter(function(c){return c.d}).length;
  var pct = S.ck.length ? (done/S.ck.length*100) : 0;

  var html = '<div class="card">' +
    '<div class="card-title">âœ… PreparaciÃ³n del viaje <span style="font-weight:400;font-size:12px;color:var(--sub);margin-left:auto">'+done+'/'+S.ck.length+'</span></div>' +
    '<div class="ck-progress"><div class="ck-progress-fill" style="width:'+pct+'%"></div></div>' +
    '<div class="ck-list">';

  S.ck.forEach(function(c,i) {
    html += '<div class="ck-item '+(c.d?'done':'')+'" onclick="toggleCkItem('+i+')" style="cursor:pointer;-webkit-tap-highlight-color:transparent">' +
      '<div class="ck-check '+(c.d?'checked':'')+'">'+(c.d?'âœ“':'')+'</div>' +
      '<span style="flex:1">'+c.t+'</span>' +
      '<span onclick="event.stopPropagation();delCkItem('+i+')" style="color:var(--accent);opacity:.4;font-size:14px;padding:4px 6px;cursor:pointer">âœ•</span></div>';
  });

  html += '</div>' +
    '<div style="margin-top:12px;display:flex;gap:8px">' +
    '<input id="ck-new" placeholder="Nueva tarea..." style="flex:1;padding:10px 12px;border:1px solid var(--border);border-radius:4px;font-size:13px;font-family:inherit;background:#111;color:#fff">' +
    '<button onclick="addCkItem()" style="padding:10px 16px;border:none;background:var(--accent);color:#fff;border-radius:4px;font-size:13px;font-weight:700;cursor:pointer">+</button></div>' +
  '</div>';
  return html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAB: NOTAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderNotas() {
  var notesVal = S.notes.general || '';
  return '<div class="card">' +
    '<div class="card-title">ğŸ“ Notas del viaje</div>' +
    '<textarea class="notes-area" placeholder="Notas generales del viaje..." onchange="saveNote(this.value)">'+notesVal+'</textarea>' +
  '</div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CALENDAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildCalendar() {
  var junDays = 30;
  var startDow = new Date(2026,5,1).getDay();
  var adjStart = startDow === 0 ? 6 : startDow - 1;
  var today = new Date().toISOString().slice(0,10);

  var tripMap = {};
  S.data.forEach(function(d) { tripMap[d.date] = d; });

  var html = '<div class="cal-grid">';
  ['L','M','X','J','V','S','D'].forEach(function(d) { html += '<div class="cal-hdr">'+d+'</div>'; });

  for (var i=0;i<adjStart;i++) html += '<div class="cal-day empty"></div>';

  for (var d=1;d<=junDays;d++) {
    var ds = '2026-06-'+String(d).padStart(2,'0');
    var td = tripMap[ds];
    var isToday = ds===today;
    var isSel = S.sel!==null && S.data[S.sel] && S.data[S.sel].date===ds;

    var cls = 'cal-day';
    if (td) cls += ' trip';
    if (isSel) cls += ' sel';
    if (isToday) cls += ' cal-today';

    var bg = '';
    if (isSel && td) bg = 'background:'+td.color+'15;';

    var bar = '';
    if (td) {
      if (td.from) {
        bar = '<div class="split-bar" style="left:10%;width:35%;background:'+td.fromColor+'"></div><div class="split-bar" style="left:55%;width:35%;background:'+td.color+'"></div>';
      } else {
        bar = '<div class="bar" style="background:'+td.color+'"></div>';
      }
    }

    var f1dot = td && isF1(td) ? '<div class="f1-dot"></div>' : '';
    var idx = td ? S.data.indexOf(td) : -1;

    html += '<div class="'+cls+'" style="'+bg+'" onclick="'+(idx>=0?'calTap('+idx+')':'')+'">' +
      '<span style="'+(isSel&&td?'color:'+td.color+';font-weight:800':'')+'">'+d+'</span>' +
      bar+f1dot+'</div>';
  }
  html += '</div>';

  // Weather
  html += '<div class="wx-row">';
  for (var i=0;i<adjStart;i++) html += '<div class="wx-cell"></div>';
  for (var d=1;d<=junDays;d++) {
    var ds = '2026-06-'+String(d).padStart(2,'0');
    html += '<div class="wx-cell">'+(WX[ds]||'')+'</div>';
  }
  html += '</div>';

  // Legend
  var cities = getCities();
  html += '<div class="cal-legend">';
  cities.forEach(function(c) { html += '<div class="cal-legend-item"><span style="background:'+c.color+'"></span>'+c.name+'</div>'; });
  html += '<div class="cal-legend-item"><div style="width:8px;height:8px;background:var(--accent);border-radius:2px;display:inline-block"></div>F1</div>';
  html += '</div>';

  return html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TIMELINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildTimeline() {
  var filtered = S.filt==="Todos" ? S.data : S.data.filter(function(d){return d.city===S.filt});
  if (!filtered.length) return '<div class="empty-state"><div class="empty-state-icon">ğŸ“‹</div>No hay dÃ­as para este filtro</div>';

  var html = '<div class="tl-wrap">';
  var lastCity = null;

  filtered.forEach(function(d) {
    var idx = S.data.indexOf(d);
    var isVuelo = d.city==="Vuelo";

    // Transit
    if (d.from && S.filt==="Todos") {
      html += '<div class="tl-transit">' +
        '<div class="tl-transit-node"></div>' +
        '<div class="tl-transit-text">ğŸš‚ '+d.from+' â†’ '+d.city+'</div>' +
      '</div>';
      lastCity = null;
    }

    // City node â€” big circle on line
    if (!isVuelo && d.city !== lastCity && S.filt==="Todos") {
      // Count days in this city
      var cityDays = filtered.filter(function(x){return x.city===d.city && x.city!=="Vuelo"}).length;
      html += '<div class="tl-city">' +
        '<div class="tl-city-node" style="background:'+d.color+';color:'+d.color+'">'+cityIconFor(d.city)+'</div>' +
        '<div class="tl-city-info">' +
          '<span class="tl-city-name" style="color:'+d.color+'">'+d.city+'</span>' +
          '<span class="tl-city-dates">'+cityDays+' dÃ­a'+(cityDays!==1?'s':'')+'</span>' +
          '<button class="tl-city-add" onclick="event.stopPropagation();openAddDay(\''+d.city+'\',\''+d.color+'\')">+</button>' +
        '</div>' +
      '</div>';
      lastCity = d.city;
    }

    var dayNum = d.date.split('-')[2].replace(/^0/,'');
    var f1badge = isF1(d) ? '<span class="tl-day-f1">F1</span>' : '';

    // Day header with dot on line
    html += '<div class="tl-day">' +
      '<div class="tl-day-dot" style="background:'+d.color+'"></div>' +
      '<div class="tl-day-head">' +
        '<div class="tl-day-num">'+dayNum+'</div>' +
        '<div class="tl-day-label">'+d.label+' '+f1badge+'</div>' +
      '</div>';

    // Events â€” always visible
    if (d.events.length) {
      html += '<div class="tl-events">';
      d.events.forEach(function(e,ei) {
        html += '<div class="tl-ev">' +
          '<div class="tl-ev-pip" style="background:'+d.color+'"></div>' +
          '<div class="tl-ev-body">' +
            '<div class="tl-ev-title">'+e.title+'</div>' +
            (e.detail ? '<div class="tl-ev-detail">'+e.detail+'</div>' : '') +
          '</div>' +
          (e.time ? '<span class="tl-ev-time">'+e.time+'</span>' : '') +
          '<span class="tl-ev-del" onclick="event.stopPropagation();del('+idx+','+ei+')">âœ•</span>' +
        '</div>';
      });
      html += '</div>';
    }

    html += '<div class="tl-add-ev" onclick="event.stopPropagation();openAddEvent('+idx+')">+ Actividad</div>';
    html += '</div>';
  });

  html += '</div>';
  return html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderModal() {
  var m = S.modal;
  if (!m) return '';
  var body = '';

  if (m.type === 'addEvent') {
    body = '<h3>Agregar Actividad</h3>' +
      '<div class="modal-field"><label>TÃ­tulo</label><input id="m-title" placeholder="Ej: Visita al museo"></div>' +
      '<div class="modal-field"><label>Hora</label><input id="m-time" type="time"></div>' +
      '<div class="modal-field"><label>Detalle</label><input id="m-detail" placeholder="DescripciÃ³n opcional"></div>' +
      '<div class="modal-actions"><button class="btn-secondary" onclick="closeModal()">Cancelar</button>' +
      '<button class="btn-primary" onclick="saveAddEvent()">Agregar</button></div>';
  }

  if (m.type === 'addDay') {
    var chips = getCities().map(function(c) {
      var isAct = m.city===c.name;
      return '<div class="modal-chip '+(isAct?'act':'')+'" style="'+(isAct?'background:'+c.color+';color:#fff':'')+'" onclick="modalPickCity(\''+c.name+'\',\''+c.color+'\')">'+c.name+'</div>';
    }).join('');
    body = '<h3>Agregar DÃ­a</h3>' +
      '<div class="modal-field"><label>Ciudad</label><div class="modal-chips">'+chips+'</div></div>' +
      '<div class="modal-field"><label>Fecha</label><input id="m-date" type="date" value="'+(m.date||'2026-06-')+'"></div>' +
      '<div class="modal-actions"><button class="btn-secondary" onclick="closeModal()">Cancelar</button>' +
      '<button class="btn-primary" onclick="saveAddDay()">Agregar</button></div>';
  }

  if (m.type === 'addCity') {
    var fromChips = getCities().map(function(c) {
      var isAct = m.from===c.name;
      return '<div class="modal-chip '+(isAct?'act':'')+'" style="'+(isAct?'background:'+c.color+';color:#fff':'')+'" onclick="modalPickFrom(\''+c.name+'\',\''+c.color+'\')">'+c.name+'</div>';
    }).join('');
    body = '<h3>Agregar Ciudad</h3>' +
      '<div class="modal-field"><label>Nombre</label><input id="m-cityname" placeholder="Ej: Sevilla"></div>' +
      '<div class="modal-field"><label>Desde</label><div class="modal-chips">'+fromChips+
      '<div class="modal-chip '+((!m.from)?'act':'')+'" onclick="modalPickFrom(\'\',\'\')">Ninguno</div></div></div>' +
      '<div class="modal-field"><label>Fecha inicio</label><input id="m-cdate" type="date" value="2026-06-"></div>' +
      '<div class="modal-field"><label>Cantidad de dÃ­as</label><input id="m-cdays" type="number" value="2" min="1" max="15"></div>' +
      '<div class="modal-actions"><button class="btn-secondary" onclick="closeModal()">Cancelar</button>' +
      '<button class="btn-primary" onclick="saveAddCity()">Agregar</button></div>';
  }

  if (m.type === 'editDay') {
    var d = S.data[m.idx];
    var editChips = getCities().map(function(c) {
      var isAct = d.city===c.name;
      return '<div class="modal-chip '+(isAct?'act':'')+'" style="'+(isAct?'background:'+c.color+';color:#fff':'')+'" onclick="editDayCity('+m.idx+',\''+c.name+'\',\''+c.color+'\')">'+c.name+'</div>';
    }).join('');
    body = '<h3>Editar DÃ­a</h3>' +
      '<div style="text-align:center;margin-bottom:12px;font-size:13px;color:var(--sub)">'+d.label+' â€” '+d.city+'</div>' +
      '<div class="modal-field"><label>Ciudad</label><div class="modal-chips">'+editChips+'</div></div>' +
      '<div class="modal-actions"><button class="btn-danger" onclick="delDay('+m.idx+')">Eliminar dÃ­a</button>' +
      '<button class="btn-secondary" onclick="closeModal()">Cerrar</button></div>';
  }

  if (m.type === 'addExp') {
    body = '<h3>Agregar Gasto</h3>' +
      '<div class="modal-field"><label>DescripciÃ³n</label><input id="m-exp-desc" placeholder="Ej: Cena en Madrid"></div>' +
      '<div class="modal-field"><label>Monto (â‚¬)</label><input id="m-exp-amt" type="number" placeholder="0" step="0.01"></div>' +
      '<div class="modal-field"><label>CategorÃ­a</label>' +
      '<div class="modal-chips">' +
        '<div class="modal-chip '+(m.cat==='comida'?'act':'')+'" style="'+(m.cat==='comida'?'background:var(--text);color:#fff':'')+'" onclick="S.modal.cat=\'comida\';R()">ğŸ½ï¸ Comida</div>' +
        '<div class="modal-chip '+(m.cat==='transporte'?'act':'')+'" style="'+(m.cat==='transporte'?'background:var(--text);color:#fff':'')+'" onclick="S.modal.cat=\'transporte\';R()">ğŸš‡ Transporte</div>' +
        '<div class="modal-chip '+(m.cat==='hotel'?'act':'')+'" style="'+(m.cat==='hotel'?'background:var(--text);color:#fff':'')+'" onclick="S.modal.cat=\'hotel\';R()">ğŸ¨ Hotel</div>' +
        '<div class="modal-chip '+(m.cat==='entradas'?'act':'')+'" style="'+(m.cat==='entradas'?'background:var(--text);color:#fff':'')+'" onclick="S.modal.cat=\'entradas\';R()">ğŸŸï¸ Entradas</div>' +
        '<div class="modal-chip '+(m.cat==='shopping'?'act':'')+'" style="'+(m.cat==='shopping'?'background:var(--text);color:#fff':'')+'" onclick="S.modal.cat=\'shopping\';R()">ğŸ›ï¸ Shopping</div>' +
        '<div class="modal-chip '+(m.cat==='otro'?'act':'')+'" style="'+(m.cat==='otro'?'background:var(--text);color:#fff':'')+'" onclick="S.modal.cat=\'otro\';R()">ğŸ“Œ Otro</div>' +
      '</div></div>' +
      '<div class="modal-actions"><button class="btn-secondary" onclick="closeModal()">Cancelar</button>' +
      '<button class="btn-primary" onclick="saveAddExp()">Agregar</button></div>';
  }

  return '<div class="modal-overlay" onclick="closeModal()">' +
    '<div class="modal" onclick="event.stopPropagation()">'+body+'</div></div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function sel(i) { S.sel = S.sel===i ? null : i; R(); }
function flt(f) { S.filt = f; S.sel = null; R(); }

function calTap(i) {
  S.sel = i;
  switchTab('itinerario');
}

function del(di, ei) {
  if (!confirm('Â¿Eliminar esta actividad?')) return;
  S.data[di].events.splice(ei,1);
  saveTrip(); R();
}

function openAddEvent(idx) { S.modal = {type:'addEvent', idx:idx}; R(); }

function saveAddEvent() {
  var title = document.getElementById('m-title').value.trim();
  if (!title) return;
  var time = document.getElementById('m-time').value || '';
  var detail = document.getElementById('m-detail').value.trim();
  S.data[S.modal.idx].events.push({time:time, title:title, detail:detail, type:'tourism'});
  S.modal = null; saveTrip(); R();
}

function openAddDay(city, color) { S.modal = {type:'addDay', city:city, color:color, date:''}; R(); }
function modalPickCity(name, color) { S.modal.city = name; S.modal.color = color; R(); }

function saveAddDay() {
  var date = document.getElementById('m-date').value;
  if (!date || !S.modal.city) return;
  var dayNum = parseInt(date.split('-')[2]);
  var dayNames = ['Domingo','Lunes','Martes','MiÃ©rcoles','Jueves','Viernes','SÃ¡bado'];
  var dow = new Date(date).getDay();
  var label = dayNames[dow]+' '+dayNum;
  var newDay = {date:date, label:label, city:S.modal.city, color:S.modal.color, icon:cityIconFor(S.modal.city), events:[]};
  var inserted = false;
  for (var i=0;i<S.data.length;i++) {
    if (S.data[i].date > date) { S.data.splice(i,0,newDay); inserted=true; break; }
  }
  if (!inserted) S.data.push(newDay);
  S.modal = null; saveTrip(); R();
}

function openAddCity() { S.modal = {type:'addCity', from:'', fromColor:''}; R(); }
function modalPickFrom(name, color) { S.modal.from = name; S.modal.fromColor = color; R(); }

function saveAddCity() {
  var name = document.getElementById('m-cityname').value.trim();
  var date = document.getElementById('m-cdate').value;
  var days = parseInt(document.getElementById('m-cdays').value) || 1;
  if (!name || !date) return;
  var colors = ['#e11d48','#7c3aed','#0891b2','#059669','#d97706','#be123c','#4f46e5'];
  var color = colors[getCities().length % colors.length];
  var dayNames = ['Domingo','Lunes','Martes','MiÃ©rcoles','Jueves','Viernes','SÃ¡bado'];
  for (var i=0;i<days;i++) {
    var dd = new Date(date);
    dd.setDate(dd.getDate()+i);
    var ds = dd.toISOString().slice(0,10);
    var dow = dd.getDay();
    var dayNum = dd.getDate();
    var label = dayNames[dow]+' '+dayNum;
    var newDay = {date:ds, label:label, city:name, color:color, icon:cityIconFor(name), events:[]};
    if (i===0 && S.modal.from) { newDay.from = S.modal.from; newDay.fromColor = S.modal.fromColor; }
    var inserted = false;
    for (var j=0;j<S.data.length;j++) {
      if (S.data[j].date > ds) { S.data.splice(j,0,newDay); inserted=true; break; }
    }
    if (!inserted) S.data.push(newDay);
  }
  S.modal = null; saveTrip(); R();
}

function editDayCity(idx, city, color) {
  S.data[idx].city = city; S.data[idx].color = color; S.data[idx].icon = cityIconFor(city);
  saveTrip(); R();
}

function openEditDay(idx) { S.modal = {type:'editDay', idx:idx}; R(); }

function delDay(idx) {
  if (!confirm('Â¿Eliminar este dÃ­a completo?')) return;
  S.data.splice(idx, 1); S.modal = null; S.sel = null; saveTrip(); R();
}

function closeModal() { S.modal = null; R(); }

// Checklist
function toggleCkItem(i) {
  if(!S.ck||!Array.isArray(S.ck)) S.ck=JSON.parse(JSON.stringify(DEFAULT_CK));
  if(!S.ck[i]) return;
  S.ck[i].d = !S.ck[i].d; saveCk(); R();
}
function delCkItem(i) {
  if(!S.ck||!Array.isArray(S.ck)||!confirm('Â¿Eliminar tarea?')) return;
  S.ck.splice(i,1); saveCk(); R();
}
function addCkItem() {
  var inp = document.getElementById('ck-new');
  if (!inp || !inp.value.trim()) return;
  if(!S.ck||!Array.isArray(S.ck)) S.ck=[];
  S.ck.push({t:inp.value.trim(),d:false}); saveCk(); R();
}
function focusCkInput() {
  var inp = document.getElementById('ck-new');
  if (inp) inp.focus();
}

// Expenses
function openAddExpModal() { S.modal = {type:'addExp', cat:'comida'}; R(); }
function saveAddExp() {
  var desc = document.getElementById('m-exp-desc');
  var amt = document.getElementById('m-exp-amt');
  if (!desc||!desc.value.trim()||!amt||!amt.value) return;
  S.exp.push({desc:desc.value.trim(),amount:parseFloat(amt.value),cat:S.modal.cat,date:new Date().toLocaleDateString('es')});
  S.modal = null; saveExp(); R();
}

// Notes
function saveNote(v) { S.notes.general = v; saveNotes(); }

// Long press for edit day
var longTimer;
document.addEventListener('touchstart', function(e) {
  var dayEl = e.target.closest('.tl-day');
  if (!dayEl) return;
  longTimer = setTimeout(function() {
    var match = dayEl.getAttribute('onclick');
    if (match) {
      var m = match.match(/sel\((\d+)\)/);
      if (m) openEditDay(parseInt(m[1]));
    }
  }, 600);
});
document.addEventListener('touchend', function() { clearTimeout(longTimer); });
document.addEventListener('touchmove', function() { clearTimeout(longTimer); });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function tryInitFB() {
  if (typeof firebase !== 'undefined' && firebase.initializeApp) {
    initFB();
  } else {
    setTimeout(tryInitFB, 200);
  }
}
tryInitFB();
R();

setTimeout(function() {
  document.getElementById('splash').classList.add('hide');
  setTimeout(function() { document.getElementById('splash').style.display='none'; }, 600);
}, 1500);

setInterval(function() { R(); }, 60000);
</script>
</body>
</html>
