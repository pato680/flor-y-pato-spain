<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="España 2026">
<meta name="theme-color" content="#ffffff">
<title>España 2026 - Viaje</title>
<link rel="apple-touch-icon" href="icon-180.png">
<link rel="icon" type="image/png" href="icon-180.png">
<link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiRXNwYcOxYSAyMDI2Iiwic2hvcnRfbmFtZSI6IkVzcGHDsWEiLCJzdGFydF91cmwiOiIuIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiI2ZmZmZmZiIsInRoZW1lX2NvbG9yIjoiI2ZmZmZmZiJ9">

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

<style>
  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  :root {
    --safe-top: env(safe-area-inset-top, 20px);
    --safe-bottom: env(safe-area-inset-bottom, 0px);
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', system-ui, sans-serif;
    background: #f2f2f7;
    color: #1c1c1e;
    min-height: 100vh;
    min-height: 100dvh;
    -webkit-font-smoothing: antialiased;
  }

  /* Sync bar */
  .sync-bar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 200;
    text-align: center;
    padding: 3px 0;
    font-size: 11px;
    font-weight: 600;
  }
  .sync-bar.online { background: #34c759; color: #fff; }
  .sync-bar.offline { background: #ff9500; color: #fff; }

  /* Header */
  .header {
    padding: calc(var(--safe-top) + 20px) 20px 12px;
    background: #fff;
    border-bottom: 0.5px solid #d1d1d6;
  }
  .header-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .header h1 {
    font-size: 34px;
    font-weight: 700;
    letter-spacing: -0.5px;
    color: #1c1c1e;
  }
  .header .subtitle {
    color: #8e8e93;
    font-size: 15px;
    margin-top: 2px;
  }
  .share-btn {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: #007aff;
    color: #fff;
    border: none;
    font-size: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
  }

  /* City pills */
  .city-pills {
    display: flex;
    gap: 8px;
    margin-top: 12px;
    flex-wrap: wrap;
  }
  .city-pill {
    font-size: 12px;
    font-weight: 600;
    padding: 4px 12px;
    border-radius: 14px;
    color: #fff;
  }

  /* Calendar */
  .calendar-section {
    padding: 16px 16px 8px;
  }
  .calendar-card {
    background: #fff;
    border-radius: 16px;
    padding: 16px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.04);
  }
  .cal-header {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 14px;
  }
  .cal-header h2 {
    font-size: 17px;
    font-weight: 600;
    color: #1c1c1e;
  }
  .cal-weekdays {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    text-align: center;
    margin-bottom: 6px;
  }
  .cal-weekday {
    font-size: 11px;
    font-weight: 600;
    color: #8e8e93;
    text-transform: uppercase;
  }
  .cal-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
  }
  .cal-day {
    aspect-ratio: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.15s;
    position: relative;
    font-size: 15px;
    font-weight: 500;
  }
  .cal-day.empty { cursor: default; }
  .cal-day.inactive {
    color: #c7c7cc;
    cursor: default;
  }
  .cal-day.trip {
    color: #fff;
    font-weight: 600;
  }
  .cal-day.trip:active {
    transform: scale(0.92);
  }
  .cal-day.selected {
    ring: 3px solid #007aff;
    box-shadow: 0 0 0 3px #007aff;
    transform: scale(1.08);
  }
  .cal-day .cal-dot {
    width: 4px;
    height: 4px;
    border-radius: 50%;
    background: rgba(255,255,255,0.7);
    margin-top: 2px;
  }
  .cal-day.inactive .cal-dot { display: none; }

  /* Day detail */
  .day-detail {
    padding: 0 16px 120px;
  }
  .detail-card {
    background: #fff;
    border-radius: 16px;
    margin-top: 12px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    overflow: hidden;
    animation: fadeUp 0.25s ease;
  }
  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(12px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .detail-header {
    padding: 16px 16px 12px;
    border-bottom: 0.5px solid #e5e5ea;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .detail-header h3 {
    font-size: 20px;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .detail-city-badge {
    font-size: 12px;
    font-weight: 600;
    padding: 3px 10px;
    border-radius: 10px;
    color: #fff;
  }
  .detail-date {
    font-size: 13px;
    color: #8e8e93;
    font-weight: 500;
  }

  /* Events */
  .events-list {
    padding: 8px 0;
  }
  .event-item {
    display: flex;
    align-items: flex-start;
    padding: 10px 16px;
    gap: 12px;
    transition: background 0.15s;
  }
  .event-item:active { background: #f2f2f7; }
  .event-icon-circle {
    width: 36px;
    height: 36px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    flex-shrink: 0;
  }
  .event-icon-circle.flight { background: #eef2ff; }
  .event-icon-circle.transport { background: #f1f5f9; }
  .event-icon-circle.tourism { background: #ecfdf5; }
  .event-icon-circle.food { background: #fff7ed; }
  .event-icon-circle.f1 { background: #fef2f2; }

  .event-info { flex: 1; min-width: 0; }
  .event-info .event-title {
    font-size: 15px;
    font-weight: 600;
    color: #1c1c1e;
  }
  .event-info .event-detail {
    font-size: 13px;
    color: #8e8e93;
    margin-top: 1px;
  }
  .event-info .event-time-label {
    font-size: 12px;
    color: #007aff;
    font-weight: 600;
    margin-bottom: 2px;
  }
  .event-delete-btn {
    background: none;
    border: none;
    color: #ff3b30;
    font-size: 18px;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 8px;
    flex-shrink: 0;
    opacity: 0.6;
  }
  .event-delete-btn:active { opacity: 1; background: #fff0f0; }

  .separator {
    height: 0.5px;
    background: #e5e5ea;
    margin-left: 64px;
  }

  /* Add event */
  .add-event-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 12px 16px;
    color: #007aff;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    border: none;
    background: none;
    width: 100%;
  }
  .add-event-btn:active { background: #f2f2f7; }

  .add-form {
    padding: 12px 16px 16px;
    border-top: 0.5px solid #e5e5ea;
    animation: fadeUp 0.2s ease;
  }
  .form-row { display: flex; gap: 8px; margin-bottom: 8px; }
  .form-input {
    background: #f2f2f7;
    border: none;
    border-radius: 10px;
    padding: 10px 12px;
    font-size: 15px;
    font-family: inherit;
    color: #1c1c1e;
    outline: none;
    width: 100%;
  }
  .form-input:focus { box-shadow: 0 0 0 2px #007aff40; }
  .form-input.time-input { width: 80px; flex-shrink: 0; }
  .form-select {
    background: #f2f2f7;
    border: none;
    border-radius: 10px;
    padding: 10px 12px;
    font-size: 15px;
    font-family: inherit;
    color: #1c1c1e;
    outline: none;
  }
  .form-actions { display: flex; gap: 8px; margin-top: 4px; }
  .btn-primary {
    background: #007aff;
    color: #fff;
    border: none;
    padding: 10px 20px;
    border-radius: 10px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    flex: 1;
  }
  .btn-secondary {
    background: #e5e5ea;
    color: #1c1c1e;
    border: none;
    padding: 10px 20px;
    border-radius: 10px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
  }

  /* No selection hint */
  .select-hint {
    text-align: center;
    padding: 40px 20px;
    color: #8e8e93;
    font-size: 15px;
  }
  .select-hint .hint-icon {
    font-size: 40px;
    margin-bottom: 8px;
    display: block;
  }

  /* Modal */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.4);
    z-index: 300;
    display: flex;
    align-items: flex-end;
    justify-content: center;
    animation: fadeIn 0.2s;
  }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  .modal-sheet {
    background: #fff;
    border-radius: 16px 16px 0 0;
    padding: 24px 20px calc(var(--safe-bottom) + 24px);
    width: 100%;
    max-width: 420px;
    animation: slideUp 0.3s ease;
  }
  @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
  .modal-sheet h2 { font-size: 20px; font-weight: 700; margin-bottom: 6px; }
  .modal-sheet p { color: #8e8e93; font-size: 14px; margin-bottom: 16px; line-height: 1.5; }
  .share-url-box {
    background: #f2f2f7;
    border-radius: 12px;
    padding: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 16px;
  }
  .share-url-box span {
    flex: 1;
    color: #007aff;
    font-size: 13px;
    font-family: ui-monospace, monospace;
    word-break: break-all;
  }
  .copy-btn {
    background: #007aff;
    color: #fff;
    border: none;
    padding: 8px 14px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 700;
    cursor: pointer;
    flex-shrink: 0;
  }
  .close-modal-btn {
    background: #f2f2f7;
    color: #007aff;
    border: none;
    padding: 14px;
    border-radius: 12px;
    width: 100%;
    font-size: 17px;
    font-weight: 600;
    cursor: pointer;
  }

  .bottom-spacer { height: calc(var(--safe-bottom) + 20px); }
</style>
</head>
<body>

<div id="app"></div>

<script>
// ==========================================
// TRIP DATA
// ==========================================
const TRIP_DATA = [
  { date:"2026-06-05", label:"Viernes 5", city:"Vuelo", color:"#6366f1", icon:"\u2708\uFE0F",
    events:[{time:"21:45",title:"Vuelo a Madrid",detail:"IB 170 — Salida 9:45pm",type:"flight"}]},
  { date:"2026-06-06", label:"Sábado 6", city:"Madrid", color:"#ef4444", icon:"\uD83C\uDFF0",
    events:[{time:"\uD83C\uDF05",title:"Llegada a Madrid",detail:"Check-in y descanso",type:"transport"},
            {time:"\uD83C\uDF06",title:"Paseo por el centro",detail:"Puerta del Sol, Plaza Mayor",type:"tourism"}]},
  { date:"2026-06-07", label:"Domingo 7", city:"Madrid", color:"#ef4444", icon:"\uD83C\uDFF0",
    events:[{time:"\uD83C\uDF05",title:"Museo del Prado",detail:"Reservar entrada online",type:"tourism"},
            {time:"\uD83C\uDF06",title:"Parque del Retiro",detail:"Paseo y Palacio de Cristal",type:"tourism"}]},
  { date:"2026-06-08", label:"Lunes 8", city:"Madrid", color:"#ef4444", icon:"\uD83C\uDFF0",
    events:[{time:"\uD83C\uDF05",title:"Palacio Real",detail:"Visita guiada",type:"tourism"},
            {time:"\uD83C\uDF06",title:"Barrio de La Latina",detail:"Tapas y paseo",type:"food"}]},
  { date:"2026-06-09", label:"Martes 9", city:"Toledo", color:"#f59e0b", icon:"\u2694\uFE0F",
    events:[{time:"\uD83C\uDF05",title:"Excursión a Toledo",detail:"Tren AVE desde Madrid (~30 min)",type:"transport"},
            {time:"\uD83D\uDD50",title:"Casco histórico",detail:"Catedral, Alcázar, calles medievales",type:"tourism"}]},
  { date:"2026-06-10", label:"Miércoles 10", city:"Toledo", color:"#f59e0b", icon:"\u2694\uFE0F",
    events:[{time:"\uD83C\uDF05",title:"Toledo día 2",detail:"Sinagoga, Museo del Greco, miradores",type:"tourism"},
            {time:"\uD83C\uDF06",title:"Regreso a Madrid",detail:"Tren de vuelta",type:"transport"}]},
  { date:"2026-06-11", label:"Jueves 11", city:"Barcelona", color:"#3b82f6", icon:"\uD83C\uDF0A",
    events:[{time:"\uD83C\uDF05",title:"Viaje a Barcelona",detail:"Traslado y check-in Airbnb",type:"transport"},
            {time:"\uD83C\uDF06",title:"Las Ramblas",detail:"Barrio Gótico, La Boquería",type:"tourism"}]},
  { date:"2026-06-12", label:"Viernes 12", city:"Barcelona", color:"#3b82f6", icon:"\uD83C\uDFCE\uFE0F",
    events:[{time:"\uD83C\uDFC1",title:"F1 — Práctica Libre",detail:"Circuit de Barcelona-Catalunya",type:"f1"}]},
  { date:"2026-06-13", label:"Sábado 13", city:"Barcelona", color:"#3b82f6", icon:"\uD83C\uDFCE\uFE0F",
    events:[{time:"\uD83C\uDFC1",title:"F1 — Clasificación",detail:"Circuit de Barcelona-Catalunya",type:"f1"}]},
  { date:"2026-06-14", label:"Domingo 14", city:"Barcelona", color:"#3b82f6", icon:"\uD83C\uDFCE\uFE0F",
    events:[{time:"\uD83C\uDFC1",title:"F1 — Carrera",detail:"Circuit de Barcelona-Catalunya",type:"f1"}]},
  { date:"2026-06-15", label:"Lunes 15", city:"Barcelona", color:"#3b82f6", icon:"\uD83C\uDF0A",
    events:[{time:"\uD83C\uDF05",title:"Sagrada Familia",detail:"Reservar entrada online",type:"tourism"},
            {time:"\uD83C\uDF06",title:"Park Güell",detail:"Zona monumental de Gaudí",type:"tourism"}]},
  { date:"2026-06-16", label:"Martes 16", city:"Barcelona", color:"#3b82f6", icon:"\uD83C\uDF0A",
    events:[{time:"\uD83C\uDF05",title:"Barceloneta",detail:"Playa y paseo marítimo",type:"tourism"},
            {time:"\uD83C\uDF06",title:"Casa Batlló / La Pedrera",detail:"Arquitectura de Gaudí",type:"tourism"}]},
  { date:"2026-06-17", label:"Miércoles 17", city:"Valencia", color:"#10b981", icon:"\uD83C\uDF4A",
    events:[{time:"\uD83C\uDF05",title:"Viaje a Valencia",detail:"Traslado desde Barcelona",type:"transport"},
            {time:"\uD83C\uDF06",title:"Ciudad de las Artes y las Ciencias",detail:"Oceanogràfic, Hemisfèric",type:"tourism"}]},
  { date:"2026-06-18", label:"Jueves 18", city:"Valencia", color:"#10b981", icon:"\uD83C\uDF4A",
    events:[{time:"\uD83C\uDF05",title:"Centro histórico",detail:"Catedral, Lonja de la Seda, Mercado Central",type:"tourism"},
            {time:"\uD83C\uDF06",title:"Playa de la Malvarrosa",detail:"Paella frente al mar",type:"food"}]},
  { date:"2026-06-19", label:"Viernes 19", city:"Madrid", color:"#ef4444", icon:"\uD83C\uDFF0",
    events:[{time:"\uD83C\uDF05",title:"Regreso a Madrid",detail:"Traslado desde Valencia",type:"transport"},
            {time:"\uD83C\uDF06",title:"Últimas compras",detail:"Gran Vía, Malasaña, cena de despedida",type:"tourism"}]},
  { date:"2026-06-20", label:"Sábado 20", city:"Vuelo", color:"#6366f1", icon:"\u2708\uFE0F",
    events:[{time:"06:50",title:"Vuelo a Montevideo",detail:"IB 169 — Salida 6:50am",type:"flight"}]}
];

const CITY_COLORS = { Madrid:"#ef4444", Toledo:"#f59e0b", Barcelona:"#3b82f6", Valencia:"#10b981", Vuelo:"#6366f1" };
const EVENT_ICONS = { flight:"\u2708\uFE0F", transport:"\uD83D\uDE8C", tourism:"\uD83D\uDCCD", food:"\uD83C\uDF7D\uFE0F", f1:"\uD83C\uDFCE\uFE0F" };

// ==========================================
// STATE
// ==========================================
let state = {
  tripData: JSON.parse(JSON.stringify(TRIP_DATA)),
  selectedDate: null,
  showAddForm: false,
  showModal: false,
  isOnline: false
};

let db = null;
let dbRef = null;

// ==========================================
// FIREBASE CONFIG (Flor y Pato Trip)
// ==========================================
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyDPZPk2nsOQ3oRMG7ADhS56zEFyORTE4QQ",
  authDomain: "flor-y-pato-trip.firebaseapp.com",
  databaseURL: "https://flor-y-pato-trip-default-rtdb.firebaseio.com",
  projectId: "flor-y-pato-trip",
  storageBucket: "flor-y-pato-trip.firebasestorage.app",
  messagingSenderId: "862498607498",
  appId: "1:862498607498:web:7e2ccf24cd913e6cb7c5c3"
};

function initFirebase(config) {
  try {
    const app = firebase.initializeApp(config);
    db = firebase.database();
    dbRef = db.ref('trip-espana-2026');

    dbRef.on('value', (snapshot) => {
      const data = snapshot.val();
      if (data && Array.isArray(data)) {
        state.tripData = data;
        state.isOnline = true;
        render();
      }
    });

    db.ref('.info/connected').on('value', (snap) => {
      state.isOnline = snap.val() === true;
      render();
    });

    dbRef.once('value', (snapshot) => {
      if (!snapshot.val()) dbRef.set(TRIP_DATA);
    });

    return true;
  } catch(e) {
    console.error('Firebase init error:', e);
    return false;
  }
}

function saveToFirebase() {
  if (dbRef) dbRef.set(state.tripData);
}

// ==========================================
// CALENDAR HELPERS
// ==========================================
function getTripDates() {
  const map = {};
  state.tripData.forEach(d => { map[d.date] = d; });
  return map;
}

function renderCalendar() {
  const tripDates = getTripDates();
  // June 2026: starts on Monday (day 1)
  const daysInMonth = 30;
  const firstDayOfWeek = 1; // Monday = 1 (0=Sun)
  // Our week starts Monday
  const startOffset = firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1;

  let cells = '';

  // Empty cells before day 1
  for (let i = 0; i < startOffset; i++) {
    cells += '<div class="cal-day empty"></div>';
  }

  for (let day = 1; day <= daysInMonth; day++) {
    const dateStr = `2026-06-${String(day).padStart(2, '0')}`;
    const tripDay = tripDates[dateStr];
    const isSelected = state.selectedDate === dateStr;
    const hasEvents = tripDay && tripDay.events.length > 0;

    if (tripDay) {
      const color = tripDay.color;
      cells += `<div class="cal-day trip ${isSelected ? 'selected' : ''}"
        style="background:${color}${isSelected ? '' : 'dd'}"
        onclick="selectDate('${dateStr}')">
        ${day}
        ${hasEvents ? '<div class="cal-dot"></div>' : ''}
      </div>`;
    } else {
      cells += `<div class="cal-day inactive">${day}</div>`;
    }
  }

  return cells;
}

// ==========================================
// MAIN RENDER
// ==========================================
function render() {
  const tripDates = getTripDates();
  const selectedDay = state.selectedDate ? tripDates[state.selectedDate] : null;

  const cityCounts = {};
  state.tripData.forEach(d => {
    if (d.city !== "Vuelo") cityCounts[d.city] = (cityCounts[d.city] || 0) + 1;
  });

  let html = '';

  // Sync bar
  if (db) {
    html += `<div class="sync-bar ${state.isOnline ? 'online' : 'offline'}">
      ${state.isOnline ? '\u2713 Sincronizado' : 'Sin conexión'}
    </div>`;
  }

  // Header
  html += `
    <div class="header" style="${db ? 'padding-top: calc(var(--safe-top) + 32px)' : ''}">
      <div class="header-top">
        <div>
          <h1>España 2026</h1>
          <div class="subtitle">5 — 20 de Junio</div>
        </div>
        ${db ? '<button class="share-btn" onclick="showShareModal()">\uD83D\uDD17</button>' : ''}
      </div>
      <div class="city-pills">
        ${Object.entries(cityCounts).map(([city, count]) =>
          `<span class="city-pill" style="background:${CITY_COLORS[city]}">${city} · ${count}d</span>`
        ).join('')}
      </div>
    </div>
  `;

  // Calendar
  html += `
    <div class="calendar-section">
      <div class="calendar-card">
        <div class="cal-header">
          <h2>Junio 2026</h2>
        </div>
        <div class="cal-weekdays">
          <span class="cal-weekday">Lun</span>
          <span class="cal-weekday">Mar</span>
          <span class="cal-weekday">Mié</span>
          <span class="cal-weekday">Jue</span>
          <span class="cal-weekday">Vie</span>
          <span class="cal-weekday">Sáb</span>
          <span class="cal-weekday">Dom</span>
        </div>
        <div class="cal-grid">
          ${renderCalendar()}
        </div>
      </div>
    </div>
  `;

  // Day Detail
  html += '<div class="day-detail">';

  if (selectedDay) {
    html += `
      <div class="detail-card">
        <div class="detail-header">
          <h3>
            <span>${selectedDay.icon}</span>
            <span>${selectedDay.label}</span>
            <span class="detail-city-badge" style="background:${selectedDay.color}">${selectedDay.city}</span>
          </h3>
        </div>
        <div class="events-list">
          ${selectedDay.events.map((ev, j) => `
            ${j > 0 ? '<div class="separator"></div>' : ''}
            <div class="event-item">
              <div class="event-icon-circle ${ev.type}">
                ${EVENT_ICONS[ev.type] || '\uD83D\uDCCD'}
              </div>
              <div class="event-info">
                <div class="event-time-label">${ev.time}</div>
                <div class="event-title">${ev.title}</div>
                <div class="event-detail">${ev.detail}</div>
              </div>
              <button class="event-delete-btn" onclick="deleteEvent('${selectedDay.date}', ${j})">\u00d7</button>
            </div>
          `).join('')}
        </div>

        ${state.showAddForm ? `
          <div class="add-form">
            <div class="form-row">
              <input class="form-input time-input" id="new-time" placeholder="Hora">
              <input class="form-input" id="new-title" placeholder="Título de la actividad">
            </div>
            <div class="form-row">
              <input class="form-input" id="new-detail" placeholder="Detalle o notas">
            </div>
            <div class="form-row">
              <select class="form-select" id="new-type">
                <option value="tourism">Turismo</option>
                <option value="transport">Transporte</option>
                <option value="food">Comida</option>
                <option value="f1">F1</option>
                <option value="flight">Vuelo</option>
              </select>
            </div>
            <div class="form-actions">
              <button class="btn-primary" onclick="addEvent('${selectedDay.date}')">Agregar</button>
              <button class="btn-secondary" onclick="closeAddForm()">Cancelar</button>
            </div>
          </div>
        ` : `
          <button class="add-event-btn" onclick="openAddForm()">
            + Agregar actividad
          </button>
        `}
      </div>
    `;
  } else {
    html += `
      <div class="select-hint">
        <span class="hint-icon">\uD83D\uDCC5</span>
        Tocá un día del calendario<br>para ver las actividades
      </div>
    `;
  }

  html += '</div>';

  // Modal
  if (state.showModal) {
    const url = window.location.href;
    html += `
      <div class="modal-overlay" onclick="closeModal()">
        <div class="modal-sheet" onclick="event.stopPropagation()">
          <h2>\uD83D\uDD17 Compartir viaje</h2>
          <p>Compartí este link con tu compañero de viaje. Los cambios se sincronizan en tiempo real.</p>
          <div class="share-url-box">
            <span>${url}</span>
            <button class="copy-btn" onclick="copyLink()">Copiar</button>
          </div>
          <button class="close-modal-btn" onclick="closeModal()">Cerrar</button>
        </div>
      </div>
    `;
  }

  html += '<div class="bottom-spacer"></div>';
  document.getElementById('app').innerHTML = html;
}

// ==========================================
// ACTIONS
// ==========================================
function selectDate(date) {
  state.selectedDate = state.selectedDate === date ? null : date;
  state.showAddForm = false;
  render();
  if (state.selectedDate) {
    setTimeout(() => {
      const el = document.querySelector('.detail-card');
      if (el) el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }, 50);
  }
}

function deleteEvent(date, idx) {
  const di = state.tripData.findIndex(d => d.date === date);
  if (di >= 0) {
    state.tripData[di].events.splice(idx, 1);
    saveToFirebase();
    render();
  }
}

function openAddForm() { state.showAddForm = true; render(); }
function closeAddForm() { state.showAddForm = false; render(); }

function addEvent(date) {
  const time = document.getElementById('new-time').value || '\uD83D\uDD50';
  const title = document.getElementById('new-title').value;
  const detail = document.getElementById('new-detail').value || '';
  const type = document.getElementById('new-type').value;
  if (!title) return;

  const di = state.tripData.findIndex(d => d.date === date);
  if (di >= 0) {
    state.tripData[di].events.push({ time, title, detail, type });
    state.showAddForm = false;
    saveToFirebase();
    render();
  }
}

function showShareModal() { state.showModal = true; render(); }
function closeModal() { state.showModal = false; render(); }

function copyLink() {
  navigator.clipboard.writeText(window.location.href).then(() => {
    const btn = document.querySelector('.copy-btn');
    if (btn) { btn.textContent = '\u2713 Copiado'; setTimeout(() => { btn.textContent = 'Copiar'; }, 1500); }
  });
}

// ==========================================
// INIT
// ==========================================
(function init() {
  const ok = initFirebase(FIREBASE_CONFIG);
  if (!ok) state.isOnline = false;
  render();
})();
</script>
</body>
</html>