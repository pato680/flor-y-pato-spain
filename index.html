<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Espa√±a 2026">
<meta name="theme-color" content="#1B3C8C">
<title>Espa√±a 2026</title>
<link rel="apple-touch-icon" href="icon-180.png">
<link rel="icon" type="image/png" href="icon-180.png">
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
  *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  :root{
    --safe-top:env(safe-area-inset-top,20px);--safe-bottom:env(safe-area-inset-bottom,0px);
    --red:#D71920;--red-soft:rgba(215,25,32,0.08);
    --blue:#1B3C8C;--blue-mid:#e8edf6;--blue-light:#3b5998;
    --white:#fff;--bg:#f0f2f6;--card:#fff;--card-hover:#f5f6f8;
    --text:#1a1d26;--dim:#6b7280;--border:rgba(0,0,0,0.07);
    --r:16px;--accent-gradient:linear-gradient(135deg,#D71920,#E8364F);
    --f1-gradient:linear-gradient(135deg,#E8364F,#ff6b35);
  }
  body{font-family:'Inter',-apple-system,system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100dvh;overflow-x:hidden;-webkit-font-smoothing:antialiased}

  /* SYNC */
  .sync{position:fixed;top:calc(var(--safe-top)+6px);left:50%;transform:translateX(-50%);z-index:200;padding:5px 14px;border-radius:20px;font-size:11px;font-weight:700;letter-spacing:.4px;backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);animation:fadeDown .5s cubic-bezier(.16,1,.3,1)}
  @keyframes fadeDown{from{opacity:0;transform:translateX(-50%) translateY(-12px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
  .sync.on{background:rgba(215,25,32,.1);color:var(--red);border:1px solid rgba(215,25,32,.15)}
  .sync.off{background:rgba(107,114,128,.1);color:var(--dim);border:1px solid rgba(107,114,128,.12)}

  /* HERO */
  .hero{padding:calc(var(--safe-top)+48px) 20px 24px;position:relative;overflow:hidden;background:var(--blue)}
  .hero-top{position:relative;z-index:1;display:flex;align-items:center;justify-content:space-between}
  .hero h1{font-size:28px;font-weight:900;letter-spacing:-.5px;color:#fff;line-height:1.1}
  .hero h1 .yr{background:var(--accent-gradient);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
  .hero .sub{font-size:13px;color:rgba(255,255,255,.6);font-weight:500;margin-top:6px}
  .share-btn{width:42px;height:42px;border-radius:14px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.15);color:#fff;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s}
  .share-btn:active{transform:scale(.9);background:rgba(255,255,255,.25)}

  /* COUNTDOWN */
  .countdown{position:relative;z-index:1;margin-top:16px;display:flex;align-items:center;gap:12px;background:rgba(255,255,255,.1);border-radius:14px;padding:14px 16px;border:1px solid rgba(255,255,255,.1)}
  .cd-num{font-size:36px;font-weight:900;color:#fff;line-height:1;min-width:56px;text-align:center}
  .cd-info{flex:1}
  .cd-label{font-size:13px;font-weight:700;color:rgba(255,255,255,.9)}
  .cd-sub{font-size:11px;color:rgba(255,255,255,.5);margin-top:2px}
  .cd-live{display:inline-flex;align-items:center;gap:4px;font-size:10px;font-weight:800;color:#4ade80;letter-spacing:.5px;text-transform:uppercase}
  .cd-live::before{content:'';width:6px;height:6px;border-radius:50%;background:#4ade80;animation:livePulse 1.5s ease infinite}
  @keyframes livePulse{0%,100%{opacity:1}50%{opacity:.3}}

  /* ROUTE BAR */
  .route-wrap{position:relative;z-index:1;margin-top:16px}
  .route-label{display:flex;justify-content:space-between;margin-bottom:6px}
  .route-label span{font-size:11px;font-weight:700;color:rgba(255,255,255,.6);text-transform:uppercase;letter-spacing:1px}
  .route-bar{display:flex;gap:2px;border-radius:10px;overflow:hidden;height:28px;background:rgba(0,0,0,.15)}
  .route-seg{height:100%;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:800;color:rgba(255,255,255,.9);letter-spacing:.3px;transition:flex .4s ease;position:relative;overflow:hidden}
  .route-seg .dates{font-size:8px;font-weight:600;color:rgba(255,255,255,.6);display:block;line-height:1}
  .route-seg .city-name{display:block;line-height:1.2}

  /* CITY CHIPS */
  .city-legend{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;position:relative;z-index:1}
  .city-chip{display:flex;align-items:center;gap:5px;font-size:11px;font-weight:600;color:rgba(255,255,255,.6);cursor:pointer;padding:5px 12px;border-radius:10px;transition:all .2s;border:1px solid transparent}
  .city-chip:active{transform:scale(.95)}
  .city-chip.on{color:#fff;background:rgba(255,255,255,.15);border-color:rgba(255,255,255,.2)}
  .city-chip .cdot{width:8px;height:8px;border-radius:50%}

  /* WEATHER */
  .weather-bar{padding:8px 12px 0;display:flex;gap:6px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none}
  .weather-bar::-webkit-scrollbar{display:none}
  .wx{background:var(--card);border-radius:12px;padding:8px 10px;display:flex;flex-direction:column;align-items:center;gap:2px;min-width:58px;box-shadow:0 1px 6px rgba(0,0,0,.04);border:1px solid var(--border)}
  .wx-d{font-size:9px;font-weight:800;color:var(--dim);text-transform:uppercase;letter-spacing:.3px}
  .wx-i{font-size:18px}
  .wx-t{font-size:11px;font-weight:800;color:var(--text)}
  .wx-r{font-size:8px;color:var(--dim);font-weight:600}

  /* CALENDAR */
  .cal-section{padding:0 12px 8px}
  .cal{background:var(--card);border-radius:var(--r);box-shadow:0 2px 12px rgba(0,0,0,.06);overflow:hidden}
  .cal-head{display:flex;align-items:center;justify-content:center;gap:8px;padding:14px 16px 10px}
  .cal-month{font-size:15px;font-weight:800;color:var(--text);letter-spacing:-.2px}
  .cal-dot{width:5px;height:5px;border-radius:50%;background:var(--red)}
  .cal-wk-header{display:grid;grid-template-columns:32px repeat(7,1fr);text-align:center;padding:0 4px 6px;border-bottom:1px solid var(--border)}
  .cal-wk-header span{font-size:10px;font-weight:800;color:var(--dim);text-transform:uppercase;letter-spacing:.8px}
  .cal-week{display:grid;grid-template-columns:32px repeat(7,1fr);min-height:72px;border-bottom:1px solid var(--border)}
  .cal-week:last-child{border-bottom:none}
  .cal-wn{display:flex;align-items:flex-start;justify-content:center;padding-top:8px;font-size:9px;font-weight:700;color:var(--dim);border-right:1px solid var(--border)}
  .cal-day{padding:3px 1px;cursor:pointer;transition:background .15s;border-right:1px solid var(--border);display:flex;flex-direction:column;min-height:72px}
  .cal-day:nth-child(8){border-right:none}
  .cal-day:active{background:var(--card-hover)}
  .cal-day.today{background:rgba(27,60,140,.06)}
  .cal-day.sel{background:rgba(215,25,32,.06)}
  .cal-day-num{font-size:11px;font-weight:700;text-align:center;padding:1px 0 2px;color:var(--dim)}
  .cal-day.has .cal-day-num{color:var(--text);font-weight:800}
  .cal-day.today .cal-day-num{background:var(--blue);color:#fff;border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center;margin:0 auto 2px}
  .cal-day.sel .cal-day-num{background:var(--red);color:#fff;border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center;margin:0 auto 2px}
  .cal-day.empty .cal-day-num{color:#c5c9d2}
  .cal-pills{display:flex;flex-direction:column;gap:1px;padding:0 1px;overflow:hidden;flex:1}
  .cal-pill{font-size:7px;font-weight:700;color:#fff;padding:1px 2px;border-radius:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;line-height:1.3}
  .cal-pill-more{font-size:7px;font-weight:700;color:var(--dim);text-align:center}

  /* TABS */
  .tab-bar{display:flex;gap:4px;padding:12px 16px 4px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none}
  .tab-bar::-webkit-scrollbar{display:none}
  .tab-btn{padding:8px 16px;border-radius:10px;font-size:12px;font-weight:700;border:1.5px solid var(--border);background:var(--card);color:var(--dim);cursor:pointer;white-space:nowrap;font-family:inherit;transition:all .2s}
  .tab-btn:active{transform:scale(.96)}
  .tab-btn.on{background:var(--blue);color:#fff;border-color:var(--blue)}

  /* SECTION TITLE */
  .sec-title{padding:16px 16px 8px;font-size:13px;font-weight:800;color:var(--dim);text-transform:uppercase;letter-spacing:1px}

  /* TIMELINE */
  .timeline{padding:0 16px 20px;position:relative}
  .timeline::before{content:'';position:absolute;left:31px;top:0;bottom:20px;width:2px;background:linear-gradient(180deg,var(--border),rgba(215,25,32,.2),var(--border))}
  .tl-day{position:relative;padding-left:48px;margin-bottom:4px}
  .tl-day:last-child{margin-bottom:0}
  .tl-node{position:absolute;left:22px;top:18px;width:20px;height:20px;border-radius:50%;border:2.5px solid var(--card);z-index:2;display:flex;align-items:center;justify-content:center}
  .tl-node-inner{width:8px;height:8px;border-radius:50%;transition:all .3s}
  .tl-day.active .tl-node{border-color:var(--red);box-shadow:0 0 12px rgba(215,25,32,.25)}
  .tl-day.active .tl-node-inner{width:10px;height:10px}
  .tl-day.is-today .tl-node{border-color:var(--blue);box-shadow:0 0 12px rgba(27,60,140,.3)}
  .tl-header{padding:14px 16px;display:flex;align-items:center;gap:12px;cursor:pointer;border-radius:var(--r);transition:background .2s;-webkit-user-select:none;user-select:none}
  .tl-header:active{background:var(--card)}
  .tl-day.active .tl-header{background:var(--card)}
  .tl-emoji{font-size:22px}
  .tl-date-info{flex:1}
  .tl-date{font-size:15px;font-weight:800;color:var(--text);letter-spacing:-.2px}
  .tl-city{display:inline-flex;align-items:center;gap:4px;font-size:11px;font-weight:700;padding:2px 8px;border-radius:6px;color:#fff;margin-top:3px}
  .tl-count{font-size:11px;font-weight:700;color:var(--dim);background:var(--card);padding:4px 10px;border-radius:8px}
  .tl-day.active .tl-count{background:var(--bg)}
  .tl-events{max-height:0;overflow:hidden;transition:max-height .4s cubic-bezier(.16,1,.3,1);padding-left:4px}
  .tl-day.active .tl-events{max-height:1200px}
  .tl-events-inner{padding:0 0 12px}

  /* F1 BANNER */
  .f1-banner{background:var(--f1-gradient);margin:0 12px 8px;border-radius:var(--r);padding:16px;color:#fff;position:relative;overflow:hidden}
  .f1-banner::after{content:'üèÅ';position:absolute;right:12px;top:50%;transform:translateY(-50%);font-size:40px;opacity:.25}
  .f1-banner-title{font-size:18px;font-weight:900;letter-spacing:-.3px}
  .f1-banner-sub{font-size:12px;font-weight:600;opacity:.85;margin-top:4px}
  .f1-badge{display:inline-flex;align-items:center;gap:4px;background:rgba(0,0,0,.2);padding:4px 10px;border-radius:8px;font-size:10px;font-weight:800;margin-top:8px;letter-spacing:.5px}
  .tl-day.f1-day .tl-header{background:linear-gradient(135deg,rgba(232,54,79,.06),rgba(255,107,53,.04));border:1px solid rgba(232,54,79,.1)}
  .tl-day.f1-day.active .tl-header{background:linear-gradient(135deg,rgba(232,54,79,.1),rgba(255,107,53,.06));border-color:rgba(232,54,79,.2)}

  /* EVENTS */
  .ev{display:flex;align-items:flex-start;padding:10px 16px;gap:12px;border-radius:12px;margin-bottom:2px;transition:background .15s}
  .ev:active{background:var(--card-hover)}
  .ev-ic{width:38px;height:38px;border-radius:11px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
  .ev-ic.flight{background:rgba(99,102,241,.1)}.ev-ic.transport{background:rgba(107,114,128,.08)}.ev-ic.tourism{background:rgba(215,25,32,.08)}.ev-ic.food{background:rgba(234,179,8,.1)}.ev-ic.f1{background:linear-gradient(135deg,rgba(215,25,32,.1),rgba(232,54,79,.06))}
  .ev-nfo{flex:1;min-width:0}
  .ev-t{font-size:10px;font-weight:700;color:var(--red);letter-spacing:.5px;text-transform:uppercase}
  .ev-n{font-size:14px;font-weight:700;color:var(--text);margin-top:1px}
  .ev-d{font-size:12px;color:var(--dim);margin-top:2px}
  .ev-map{display:inline-flex;align-items:center;gap:3px;font-size:11px;font-weight:600;color:var(--blue);margin-top:4px;text-decoration:none;padding:2px 8px;border-radius:6px;background:rgba(27,60,140,.06)}
  .ev-map:active{background:rgba(27,60,140,.12)}
  .ev-x{background:none;border:none;color:var(--dim);font-size:16px;cursor:pointer;padding:4px 6px;border-radius:8px;opacity:.2;flex-shrink:0;transition:all .15s}
  .ev-x:active{opacity:1;color:var(--red);background:rgba(215,25,32,.08)}
  .ev-sep{height:1px;background:var(--border);margin:0 18px 0 68px}

  /* NOTES */
  .notes-area{padding:8px 16px 4px}
  .note-input{width:100%;background:var(--bg);border:1.5px solid var(--border);border-radius:10px;padding:10px 12px;font-size:13px;font-family:inherit;color:var(--text);outline:none;resize:none;min-height:36px;max-height:100px;transition:border-color .2s}
  .note-input:focus{border-color:var(--blue)}
  .note-input::placeholder{color:var(--dim)}
  .note-saved{font-size:10px;color:#4ade80;font-weight:600;margin-top:3px;opacity:0;transition:opacity .2s}
  .note-saved.show{opacity:1}

  /* ADD */
  .add-b{display:flex;align-items:center;justify-content:center;gap:5px;padding:12px;color:var(--red);font-size:13px;font-weight:700;cursor:pointer;border:none;background:none;width:100%;font-family:inherit;transition:background .15s;border-top:1px solid var(--border)}
  .add-b:active{background:rgba(215,25,32,.04)}
  .add-f{padding:14px 16px 16px;border-top:1px solid var(--border);animation:slideUp .2s ease}
  .fr{display:flex;gap:6px;margin-bottom:6px}
  .fi{background:var(--bg);border:1.5px solid var(--border);border-radius:10px;padding:10px 12px;font-size:14px;font-family:inherit;color:var(--text);outline:none;width:100%;transition:border-color .2s,box-shadow .2s}
  .fi:focus{border-color:var(--blue);box-shadow:0 0 0 3px rgba(27,60,140,.1)}
  .fi::placeholder{color:var(--dim)}.fi.tm{width:72px;flex-shrink:0}
  .fs{background:var(--bg);border:1.5px solid var(--border);border-radius:10px;padding:10px 12px;font-size:14px;font-family:inherit;color:var(--text);outline:none}
  .fa{display:flex;gap:6px;margin-top:4px}
  .btn-add{background:var(--accent-gradient);color:#fff;border:none;padding:11px 18px;border-radius:10px;font-size:14px;font-weight:700;cursor:pointer;flex:1;font-family:inherit;box-shadow:0 4px 14px rgba(215,25,32,.2);transition:transform .15s}
  .btn-add:active{transform:scale(.97)}
  .btn-cancel{background:var(--card);color:var(--dim);border:1.5px solid var(--border);padding:11px 18px;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;font-family:inherit}

  /* CHECKLIST */
  .checklist-section{padding:0 12px 12px}
  .checklist{background:var(--card);border-radius:var(--r);box-shadow:0 2px 12px rgba(0,0,0,.06);overflow:hidden}
  .ck-head{padding:16px 16px 12px;display:flex;align-items:center;justify-content:space-between}
  .ck-title{font-size:16px;font-weight:800;color:var(--text)}
  .ck-prog{font-size:11px;font-weight:700;color:var(--dim)}
  .ck-bar{height:4px;background:var(--bg);margin:0 16px 12px;border-radius:2px;overflow:hidden}
  .ck-bar-fill{height:100%;background:var(--accent-gradient);border-radius:2px;transition:width .3s ease}
  .ck-item{display:flex;align-items:center;gap:12px;padding:12px 16px;border-top:1px solid var(--border);cursor:pointer;transition:background .15s;-webkit-user-select:none;user-select:none}
  .ck-item:active{background:var(--card-hover)}
  .ck-box{width:22px;height:22px;border-radius:7px;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .2s;font-size:12px;color:transparent}
  .ck-item.done .ck-box{background:var(--accent-gradient);border-color:var(--red);color:#fff}
  .ck-item.done .ck-text{text-decoration:line-through;color:var(--dim)}
  .ck-text{font-size:14px;font-weight:600;color:var(--text);flex:1}
  .ck-cat{font-size:9px;font-weight:800;color:var(--dim);padding:2px 6px;border-radius:4px;background:var(--bg);text-transform:uppercase;letter-spacing:.5px}
  .ck-add-wrap{padding:10px 16px;border-top:1px solid var(--border);display:flex;gap:6px}
  .ck-add-input{flex:1;background:var(--bg);border:1.5px solid var(--border);border-radius:10px;padding:9px 12px;font-size:13px;font-family:inherit;color:var(--text);outline:none}
  .ck-add-input:focus{border-color:var(--blue)}
  .ck-add-btn{background:var(--accent-gradient);color:#fff;border:none;padding:9px 14px;border-radius:10px;font-size:13px;font-weight:700;cursor:pointer;font-family:inherit}

  /* EXPENSES */
  .exp-section{padding:0 12px 12px}
  .exp-card{background:var(--card);border-radius:var(--r);box-shadow:0 2px 12px rgba(0,0,0,.06);overflow:hidden}
  .exp-head{padding:16px 16px 12px;display:flex;align-items:center;justify-content:space-between}
  .exp-title{font-size:16px;font-weight:800;color:var(--text)}
  .exp-total{font-size:20px;font-weight:900;color:var(--red)}
  .exp-cities{display:flex;gap:6px;padding:0 16px 12px;overflow-x:auto;scrollbar-width:none}
  .exp-cities::-webkit-scrollbar{display:none}
  .exp-city{padding:6px 12px;border-radius:8px;background:var(--bg);font-size:11px;font-weight:700;color:var(--dim);text-align:center;min-width:70px}
  .exp-city-name{font-size:10px;font-weight:600;color:var(--dim)}
  .exp-city-amt{font-size:14px;font-weight:800;color:var(--text);margin-top:2px}
  .exp-list{max-height:200px;overflow-y:auto}
  .exp-item{display:flex;align-items:center;gap:12px;padding:10px 16px;border-top:1px solid var(--border)}
  .exp-item-ic{font-size:16px}
  .exp-item-nfo{flex:1}
  .exp-item-n{font-size:13px;font-weight:700;color:var(--text)}
  .exp-item-d{font-size:11px;color:var(--dim)}
  .exp-item-amt{font-size:14px;font-weight:800;color:var(--text)}
  .exp-item-x{background:none;border:none;color:var(--dim);font-size:14px;cursor:pointer;opacity:.3;padding:4px}
  .exp-item-x:active{opacity:1;color:var(--red)}
  .exp-add-wrap{padding:10px 16px;border-top:1px solid var(--border)}
  .exp-add-row{display:flex;gap:6px;margin-bottom:6px}
  .exp-cur{font-size:13px;font-weight:700;color:var(--dim);padding:9px 0;min-width:16px}

  /* MODAL */
  .mbg{position:fixed;inset:0;background:rgba(0,0,0,.4);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);z-index:300;display:flex;align-items:flex-end;justify-content:center;animation:fadein .2s}
  @keyframes fadein{from{opacity:0}to{opacity:1}}
  .msh{background:var(--card);border-radius:24px 24px 0 0;padding:24px 20px calc(var(--safe-bottom)+24px);width:100%;max-width:420px;animation:sheetUp .3s cubic-bezier(.16,1,.3,1)}
  @keyframes sheetUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
  .msh h2{font-size:20px;font-weight:800;color:var(--text);margin-bottom:4px}
  .msh p{color:var(--dim);font-size:13px;margin-bottom:14px;line-height:1.5}
  .sbox{background:var(--bg);border-radius:12px;padding:12px;display:flex;align-items:center;gap:8px;margin-bottom:14px}
  .sbox span{flex:1;color:var(--red);font-size:11px;font-family:ui-monospace,monospace;word-break:break-all}
  .cpb{background:var(--accent-gradient);color:#fff;border:none;padding:7px 14px;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;flex-shrink:0}
  .clb{background:var(--bg);color:var(--dim);border:none;padding:12px;border-radius:12px;width:100%;font-size:15px;font-weight:600;cursor:pointer;font-family:inherit}
  @keyframes slideUp{from{opacity:0;transform:translateY(24px)}to{opacity:1;transform:translateY(0)}}

  /* BOTTOM SPACING */
  .bottom-space{height:100px}

  /* SPLASH */
  .splash{position:fixed;inset:0;z-index:9999;background:linear-gradient(135deg,#1B3C8C 0%,#2952b0 100%);display:flex;flex-direction:column;align-items:center;justify-content:center;transition:opacity .5s ease,transform .5s ease;overflow:hidden}
  .splash.hide{opacity:0;transform:scale(1.05);pointer-events:none}
  .splash::before,.splash::after{content:'';position:absolute;left:0;right:0;height:2px;background:repeating-linear-gradient(90deg,rgba(255,255,255,.08) 0px,rgba(255,255,255,.08) 20px,transparent 20px,transparent 40px)}
  .splash::before{top:38%}.splash::after{bottom:38%}
  .speed-lines{position:absolute;inset:0;overflow:hidden}
  .speed-line{position:absolute;height:1px;background:linear-gradient(90deg,transparent,rgba(232,54,79,.4),transparent);animation:speedLine .8s linear infinite}
  @keyframes speedLine{0%{transform:translateX(-100%)}100%{transform:translateX(200vw)}}
  .f1-car-wrap{position:relative;z-index:2;animation:carEntry 1.2s cubic-bezier(.16,1,.3,1) forwards}
  @keyframes carEntry{0%{transform:translateX(-120vw) scale(.8);opacity:0}40%{opacity:1}70%{transform:translateX(0) scale(1)}85%{transform:translateX(10px) scale(1)}100%{transform:translateX(0) scale(1);opacity:1}}
  .f1-car{font-size:72px;filter:drop-shadow(0 0 30px rgba(232,54,79,.5));animation:carBounce .6s ease-in-out infinite alternate;animation-delay:1.2s}
  @keyframes carBounce{0%{transform:translateY(0)}100%{transform:translateY(-3px)}}
  .smoke{position:absolute;bottom:-10px;left:-60px;width:80px;height:30px;border-radius:50%;background:radial-gradient(ellipse,rgba(255,255,255,.2),transparent);animation:smokeAnim 1s ease-out forwards;animation-delay:.8s;opacity:0}
  @keyframes smokeAnim{0%{opacity:0;transform:scale(.5) translateX(0)}50%{opacity:.6}100%{opacity:0;transform:scale(2) translateX(-40px)}}
  .splash-title{position:relative;z-index:2;margin-top:28px;text-align:center;animation:titleReveal .6s cubic-bezier(.16,1,.3,1) forwards;animation-delay:.7s;opacity:0;transform:translateY(20px)}
  @keyframes titleReveal{to{opacity:1;transform:translateY(0)}}
  .splash-title h2{font-size:32px;font-weight:900;color:#fff;letter-spacing:-1px;text-shadow:0 2px 20px rgba(0,0,0,.3)}
  .splash-title h2 .red{color:var(--red)}
  .splash-title .year{font-size:14px;font-weight:600;color:rgba(255,255,255,.5);letter-spacing:6px;margin-top:6px;text-transform:uppercase}
  .checkered{position:absolute;bottom:0;left:0;right:0;height:24px;display:flex;flex-wrap:wrap;animation:checkReveal .4s ease forwards;animation-delay:1s;opacity:0}
  @keyframes checkReveal{to{opacity:1}}
  .checkered span{width:12px;height:12px;display:inline-block}
  .splash-dots{position:relative;z-index:2;margin-top:20px;display:flex;gap:6px;animation:titleReveal .5s ease forwards;animation-delay:1s;opacity:0}
  .splash-dots span{width:6px;height:6px;border-radius:50%;background:var(--red);animation:dotPulse 1s ease infinite}
  .splash-dots span:nth-child(2){animation-delay:.2s}
  .splash-dots span:nth-child(3){animation-delay:.4s}
  @keyframes dotPulse{0%,80%,100%{opacity:.3;transform:scale(.8)}40%{opacity:1;transform:scale(1.2)}}
</style>
</head>
<body>
<div id="splash" class="splash">
  <div class="speed-lines">
    <div class="speed-line" style="top:20%;width:40%;animation-delay:.1s;animation-duration:.7s"></div>
    <div class="speed-line" style="top:35%;width:60%;animation-delay:.3s;animation-duration:.6s"></div>
    <div class="speed-line" style="top:50%;width:35%;animation-delay:0s;animation-duration:.8s"></div>
    <div class="speed-line" style="top:65%;width:50%;animation-delay:.2s;animation-duration:.65s"></div>
    <div class="speed-line" style="top:80%;width:45%;animation-delay:.4s;animation-duration:.75s"></div>
  </div>
  <div class="f1-car-wrap"><div class="f1-car">üèéÔ∏è</div><div class="smoke"></div></div>
  <div class="splash-title"><h2>Espa√±a <span class="red">F1</span></h2><div class="year">Junio 2026</div></div>
  <div class="splash-dots"><span></span><span></span><span></span></div>
  <div class="checkered" id="checkered"></div>
</div>
<div id="app"></div>
<script>
const TRIP=[
  {date:"2026-06-05",label:"Viernes 5",city:"Vuelo",color:"#6366f1",icon:"‚úàÔ∏è",events:[{time:"21:45",title:"Vuelo a Madrid",detail:"IB 170 ‚Äî Salida 9:45pm",type:"flight"}]},
  {date:"2026-06-06",label:"S√°bado 6",city:"Madrid",color:"#D71920",icon:"üè∞",events:[{time:"",title:"Madrid",detail:"Llegada y check-in",type:"tourism"}]},
  {date:"2026-06-07",label:"Domingo 7",city:"Madrid",color:"#D71920",icon:"üè∞",events:[{time:"",title:"Madrid",detail:"",type:"tourism"}]},
  {date:"2026-06-08",label:"Lunes 8",city:"Madrid",color:"#D71920",icon:"üè∞",events:[{time:"",title:"Madrid",detail:"",type:"tourism"}]},
  {date:"2026-06-09",label:"Martes 9",city:"Madrid",color:"#D71920",icon:"‚öîÔ∏è",events:[{time:"",title:"Toledo ‚Äî Excursi√≥n",detail:"Day trip desde Madrid",type:"tourism"}]},
  {date:"2026-06-10",label:"Mi√©rcoles 10",city:"Madrid",color:"#D71920",icon:"üè∞",events:[{time:"",title:"Madrid",detail:"",type:"tourism"}]},
  {date:"2026-06-11",label:"Jueves 11",city:"Barcelona",color:"#3b5998",icon:"üåä",events:[{time:"",title:"Airbnb ‚Äî Barcelona",detail:"Check-in Airbnb",type:"tourism"}]},
  {date:"2026-06-12",label:"Viernes 12",city:"Barcelona",color:"#3b5998",icon:"üèéÔ∏è",events:[{time:"",title:"Airbnb ‚Äî Barcelona",detail:"",type:"tourism"},{time:"üèÅ",title:"F1 ‚Äî Pr√°ctica Libre",detail:"Circuit de Barcelona-Catalunya",type:"f1"}]},
  {date:"2026-06-13",label:"S√°bado 13",city:"Barcelona",color:"#3b5998",icon:"üèéÔ∏è",events:[{time:"",title:"Airbnb ‚Äî Barcelona",detail:"",type:"tourism"},{time:"üèÅ",title:"F1 ‚Äî Clasificaci√≥n",detail:"Circuit de Barcelona-Catalunya",type:"f1"}]},
  {date:"2026-06-14",label:"Domingo 14",city:"Barcelona",color:"#3b5998",icon:"üèéÔ∏è",events:[{time:"",title:"Airbnb ‚Äî Barcelona",detail:"",type:"tourism"},{time:"üèÅ",title:"F1 ‚Äî Carrera",detail:"Circuit de Barcelona-Catalunya",type:"f1"}]},
  {date:"2026-06-15",label:"Lunes 15",city:"Barcelona",color:"#3b5998",icon:"üåä",events:[{time:"",title:"Airbnb ‚Äî Barcelona",detail:"",type:"tourism"}]},
  {date:"2026-06-16",label:"Martes 16",city:"Barcelona",color:"#3b5998",icon:"üåä",events:[{time:"",title:"Airbnb ‚Äî Barcelona",detail:"",type:"tourism"}]},
  {date:"2026-06-17",label:"Mi√©rcoles 17",city:"Valencia",color:"#2a9d8f",icon:"üçä",events:[{time:"",title:"Valencia",detail:"Traslado desde Barcelona",type:"tourism"}]},
  {date:"2026-06-18",label:"Jueves 18",city:"Valencia",color:"#2a9d8f",icon:"üçä",events:[{time:"",title:"Valencia",detail:"",type:"tourism"}]},
  {date:"2026-06-19",label:"Viernes 19",city:"Madrid",color:"#D71920",icon:"üè∞",events:[{time:"",title:"Madrid",detail:"Regreso para vuelta",type:"tourism"}]},
  {date:"2026-06-20",label:"S√°bado 20",city:"Vuelo",color:"#6366f1",icon:"‚úàÔ∏è",events:[{time:"06:50",title:"Vuelo a Montevideo",detail:"IB 169 ‚Äî Salida 6:50am",type:"flight"}]}
];

// Google Maps search URLs for locations
const MAPS={
  "Vuelo a Madrid":"https://maps.google.com/?q=Aeropuerto+Barajas+Madrid",
  "Madrid":"https://maps.google.com/?q=Madrid+centro",
  "Toledo ‚Äî Excursi√≥n":"https://maps.google.com/?q=Toledo+Espa√±a",
  "Airbnb ‚Äî Barcelona":"https://maps.google.com/?q=Barcelona+centro",
  "F1 ‚Äî Pr√°ctica Libre":"https://maps.google.com/?q=Circuit+de+Barcelona-Catalunya",
  "F1 ‚Äî Clasificaci√≥n":"https://maps.google.com/?q=Circuit+de+Barcelona-Catalunya",
  "F1 ‚Äî Carrera":"https://maps.google.com/?q=Circuit+de+Barcelona-Catalunya",
  "Valencia":"https://maps.google.com/?q=Valencia+centro",
  "Vuelo a Montevideo":"https://maps.google.com/?q=Aeropuerto+Barajas+Madrid"
};

const CC={Madrid:"#D71920",Barcelona:"#3b5998",Valencia:"#2a9d8f",Vuelo:"#6366f1"};
const EI={flight:"‚úàÔ∏è",transport:"üöå",tourism:"üìç",food:"üçΩÔ∏è",f1:"üèéÔ∏è"};
const CTS=["Todos","Madrid","Barcelona","Valencia"];
const F1_DATES=["2026-06-12","2026-06-13","2026-06-14"];

const ROUTE=[
  {city:"Vuelo",dates:"5 Jun",days:1},
  {city:"Madrid",dates:"6‚Äì10",days:5},
  {city:"Barcelona",dates:"11‚Äì16",days:6},
  {city:"Valencia",dates:"17‚Äì18",days:2},
  {city:"Madrid",dates:"19",days:1},
  {city:"Vuelo",dates:"20 Jun",days:1}
];

// Default checklist
const DEFAULT_CK=[
  {text:"Pasaportes",done:false,cat:"docs"},
  {text:"Seguro de viaje",done:false,cat:"docs"},
  {text:"Reserva vuelos impresas",done:false,cat:"docs"},
  {text:"Entradas F1",done:false,cat:"f1"},
  {text:"Reserva Airbnb Barcelona",done:false,cat:"aloj"},
  {text:"Hotel Madrid",done:false,cat:"aloj"},
  {text:"Adaptador enchufe",done:false,cat:"equip"},
  {text:"Protector solar",done:false,cat:"equip"},
  {text:"Cargador port√°til",done:false,cat:"equip"},
  {text:"Tarjeta de cr√©dito internacional",done:false,cat:"docs"}
];

let S={data:JSON.parse(JSON.stringify(TRIP)),sel:null,add:false,modal:false,on:false,filt:"Todos",tab:"timeline",notes:{},checklist:null,expenses:[],expAdd:false,weather:null};
let db=null,ref=null,notesRef=null,ckRef=null,expRef=null;

const FC={apiKey:"AIzaSyDPZPk2nsOQ3oRMG7ADhS56zEFyORTE4QQ",authDomain:"flor-y-pato-trip.firebaseapp.com",databaseURL:"https://flor-y-pato-trip-default-rtdb.firebaseio.com",projectId:"flor-y-pato-trip",storageBucket:"flor-y-pato-trip.firebasestorage.app",messagingSenderId:"862498607498",appId:"1:862498607498:web:7e2ccf24cd913e6cb7c5c3"};

function initFB(){
  try{
    firebase.initializeApp(FC);db=firebase.database();
    ref=db.ref('trip-espana-2026');
    notesRef=db.ref('trip-notes-2026');
    ckRef=db.ref('trip-checklist-2026');
    expRef=db.ref('trip-expenses-2026');
    ref.on('value',s=>{const d=s.val();if(d&&Array.isArray(d)){S.data=d;S.on=true;R()}});
    db.ref('.info/connected').on('value',s=>{S.on=s.val()===true;R()});
    ref.once('value',s=>{if(!s.val())ref.set(TRIP)});
    notesRef.on('value',s=>{S.notes=s.val()||{};R()});
    ckRef.on('value',s=>{S.checklist=s.val()||DEFAULT_CK;R()});
    ckRef.once('value',s=>{if(!s.val())ckRef.set(DEFAULT_CK)});
    expRef.on('value',s=>{S.expenses=s.val()||[];R()});
    return true;
  }catch(e){return false}
}
function save(){if(ref)ref.set(S.data)}
function saveNotes(){if(notesRef)notesRef.set(S.notes)}
function saveCK(){if(ckRef)ckRef.set(S.checklist)}
function saveExp(){if(expRef)expRef.set(S.expenses)}
function tm(){const m={};S.data.forEach(d=>{m[d.date]=d});return m}

// Countdown helper
function getCountdown(){
  const start=new Date('2026-06-05T00:00:00');
  const end=new Date('2026-06-20T23:59:59');
  const now=new Date();
  if(now<start){
    const diff=Math.ceil((start-now)/(1000*60*60*24));
    return {type:'before',days:diff,text:`Faltan ${diff} d√≠a${diff===1?'':'s'}`,sub:'para el viaje'};
  } else if(now<=end){
    const dayNum=Math.floor((now-start)/(1000*60*60*24))+1;
    return {type:'during',days:dayNum,text:`D√≠a ${dayNum}`,sub:'del viaje',live:true};
  } else {
    return {type:'after',days:0,text:'Viaje completado',sub:'Espa√±a 2026'};
  }
}

function getTodayStr(){
  const n=new Date();
  const y=n.getFullYear(),m=String(n.getMonth()+1).padStart(2,'0'),d=String(n.getDate()).padStart(2,'0');
  return `${y}-${m}-${d}`;
}

// Weather
function fetchWeather(){
  const cities=[
    {name:"Madrid",lat:40.4168,lon:-3.7038,dates:["2026-06-06","2026-06-07","2026-06-08","2026-06-09","2026-06-10","2026-06-19"]},
    {name:"Barcelona",lat:41.3874,lon:2.1686,dates:["2026-06-11","2026-06-12","2026-06-13","2026-06-14","2026-06-15","2026-06-16"]},
    {name:"Valencia",lat:39.4699,lon:-0.3763,dates:["2026-06-17","2026-06-18"]}
  ];
  // Use Open-Meteo climate API (free, no key) for historical averages
  // Since trip is in the future, we use seasonal forecast / climate normals
  // For now, show estimated June averages
  S.weather={
    "2026-06-05":{icon:"‚úàÔ∏è",hi:"-",lo:"-",rain:""},
    "2026-06-06":{icon:"‚òÄÔ∏è",hi:"31¬∞",lo:"18¬∞",rain:"10%"},
    "2026-06-07":{icon:"‚òÄÔ∏è",hi:"32¬∞",lo:"18¬∞",rain:"8%"},
    "2026-06-08":{icon:"üå§Ô∏è",hi:"30¬∞",lo:"17¬∞",rain:"15%"},
    "2026-06-09":{icon:"‚òÄÔ∏è",hi:"33¬∞",lo:"19¬∞",rain:"5%"},
    "2026-06-10":{icon:"‚òÄÔ∏è",hi:"31¬∞",lo:"18¬∞",rain:"10%"},
    "2026-06-11":{icon:"üå§Ô∏è",hi:"27¬∞",lo:"20¬∞",rain:"12%"},
    "2026-06-12":{icon:"‚òÄÔ∏è",hi:"28¬∞",lo:"20¬∞",rain:"8%"},
    "2026-06-13":{icon:"‚òÄÔ∏è",hi:"29¬∞",lo:"21¬∞",rain:"6%"},
    "2026-06-14":{icon:"üå§Ô∏è",hi:"28¬∞",lo:"20¬∞",rain:"10%"},
    "2026-06-15":{icon:"‚òÄÔ∏è",hi:"29¬∞",lo:"21¬∞",rain:"8%"},
    "2026-06-16":{icon:"‚òÄÔ∏è",hi:"28¬∞",lo:"20¬∞",rain:"10%"},
    "2026-06-17":{icon:"‚òÄÔ∏è",hi:"30¬∞",lo:"21¬∞",rain:"7%"},
    "2026-06-18":{icon:"‚òÄÔ∏è",hi:"31¬∞",lo:"21¬∞",rain:"5%"},
    "2026-06-19":{icon:"‚òÄÔ∏è",hi:"32¬∞",lo:"18¬∞",rain:"8%"},
    "2026-06-20":{icon:"‚úàÔ∏è",hi:"-",lo:"-",rain:""}
  };
  R();
}

function calWeeks(){
  const t=tm();
  const today=getTodayStr();
  const weeks=[[1,2,3,4,5,6,7],[8,9,10,11,12,13,14],[15,16,17,18,19,20,21],[22,23,24,25,26,27,28],[29,30,null,null,null,null,null]];
  const wLabels=['S23','S24','S25','S26','S27'];
  let h='';
  weeks.forEach((wk,wi)=>{
    h+=`<div class="cal-week"><div class="cal-wn">${wLabels[wi]}</div>`;
    wk.forEach(d=>{
      if(!d){h+=`<div class="cal-day empty"><div class="cal-day-num"></div></div>`;return;}
      const ds=`2026-06-${String(d).padStart(2,'0')}`,td=t[ds],sl=S.sel===ds;
      const isToday=ds===today;
      const sh=td&&(S.filt==="Todos"||td.city===S.filt);
      const cls=['cal-day'];
      if(td)cls.push('has');
      if(isToday)cls.push('today');
      if(sl&&!isToday)cls.push('sel');
      if(td&&!sh)cls.push('dim');
      h+=`<div class="${cls.join(' ')}" onclick="${td?`sel('${ds}')`:''}">`;
      h+=`<div class="cal-day-num">${d}</div>`;
      if(td&&sh){
        h+=`<div class="cal-pills">`;
        const maxPills=3;
        td.events.slice(0,maxPills).forEach(e=>{
          const bg=e.type==='f1'?'#E8364F':td.color;
          h+=`<div class="cal-pill" style="background:${bg}">${e.title}</div>`;
        });
        if(td.events.length>maxPills) h+=`<div class="cal-pill-more">+${td.events.length-maxPills}</div>`;
        h+=`</div>`;
      }
      h+=`</div>`;
    });
    h+=`</div>`;
  });
  return h;
}

function eventsHTML(day){
  let h='';
  day.events.forEach((e,j)=>{
    if(j) h+='<div class="ev-sep"></div>';
    const mapUrl=MAPS[e.title]||null;
    h+=`<div class="ev">
      <div class="ev-ic ${e.type}">${EI[e.type]||'üìç'}</div>
      <div class="ev-nfo">${e.time?`<div class="ev-t">${e.time}</div>`:''}
        <div class="ev-n">${e.title}</div>${e.detail?`<div class="ev-d">${e.detail}</div>`:''}
        ${mapUrl?`<a class="ev-map" href="${mapUrl}" target="_blank" onclick="event.stopPropagation()">üìç Ver en Maps</a>`:''}
      </div>
      <button class="ev-x" onclick="event.stopPropagation();del('${day.date}',${j})">√ó</button>
    </div>`;
  });
  return h;
}

function notesHTML(date){
  const val=S.notes[date]||'';
  return `<div class="notes-area">
    <textarea class="note-input" placeholder="Notas del d√≠a..." oninput="saveNote('${date}',this.value)" onfocus="this.style.minHeight='60px'" onblur="this.style.minHeight='36px'">${val}</textarea>
  </div>`;
}

function addFormHTML(date){
  return S.add?`<div class="add-f">
    <div class="fr"><input class="fi tm" id="nt" placeholder="Hora"><input class="fi" id="nn" placeholder="T√≠tulo"></div>
    <div class="fr"><input class="fi" id="nd" placeholder="Detalle"></div>
    <div class="fr"><select class="fs" id="ny"><option value="tourism">Turismo</option><option value="transport">Transporte</option><option value="food">Comida</option><option value="f1">F1</option><option value="flight">Vuelo</option></select></div>
    <div class="fa"><button class="btn-add" onclick="addE('${date}')">Agregar</button><button class="btn-cancel" onclick="S.add=false;R()">Cancelar</button></div>
  </div>`:`<button class="add-b" onclick="event.stopPropagation();S.add=true;R()">+ Agregar actividad</button>`;
}

function checklistHTML(){
  if(!S.checklist)return '';
  const done=S.checklist.filter(i=>i.done).length;
  const total=S.checklist.length;
  const pct=total?Math.round((done/total)*100):0;
  const catNames={docs:"Docs",f1:"F1",aloj:"Aloj",equip:"Equip",otro:"Otro"};
  let h=`<div class="checklist-section"><div class="checklist">
    <div class="ck-head"><div class="ck-title">üß≥ Checklist</div><div class="ck-prog">${done}/${total}</div></div>
    <div class="ck-bar"><div class="ck-bar-fill" style="width:${pct}%"></div></div>`;
  S.checklist.forEach((item,i)=>{
    h+=`<div class="ck-item ${item.done?'done':''}" onclick="toggleCK(${i})">
      <div class="ck-box">${item.done?'‚úì':''}</div>
      <div class="ck-text">${item.text}</div>
      <div class="ck-cat">${catNames[item.cat]||item.cat||'Otro'}</div>
    </div>`;
  });
  h+=`<div class="ck-add-wrap">
    <input class="ck-add-input" id="ckInput" placeholder="Agregar item..." onkeydown="if(event.key==='Enter')addCK()">
    <button class="ck-add-btn" onclick="addCK()">+</button>
  </div>`;
  h+=`</div></div>`;
  return h;
}

function expensesHTML(){
  const exps=S.expenses||[];
  const total=exps.reduce((s,e)=>s+Number(e.amount||0),0);
  // Group by city
  const byCity={};
  exps.forEach(e=>{byCity[e.city]=(byCity[e.city]||0)+Number(e.amount||0)});
  const catIcons={comida:"üçΩÔ∏è",transporte:"üöå",alojamiento:"üè®",entradas:"üéüÔ∏è",compras:"üõçÔ∏è",otro:"üí∞"};

  let h=`<div class="exp-section"><div class="exp-card">
    <div class="exp-head"><div class="exp-title">üí∞ Gastos</div><div class="exp-total">‚Ç¨${total.toFixed(0)}</div></div>`;
  if(Object.keys(byCity).length){
    h+=`<div class="exp-cities">`;
    Object.entries(byCity).forEach(([c,a])=>{
      h+=`<div class="exp-city"><div class="exp-city-name">${c}</div><div class="exp-city-amt">‚Ç¨${a.toFixed(0)}</div></div>`;
    });
    h+=`</div>`;
  }
  if(exps.length){
    h+=`<div class="exp-list">`;
    exps.slice().reverse().forEach((e,ri)=>{
      const i=exps.length-1-ri;
      h+=`<div class="exp-item">
        <div class="exp-item-ic">${catIcons[e.cat]||'üí∞'}</div>
        <div class="exp-item-nfo"><div class="exp-item-n">${e.desc}</div><div class="exp-item-d">${e.city} ¬∑ ${e.date||''}</div></div>
        <div class="exp-item-amt">‚Ç¨${Number(e.amount).toFixed(0)}</div>
        <button class="exp-item-x" onclick="delExp(${i})">√ó</button>
      </div>`;
    });
    h+=`</div>`;
  }
  h+=`<div class="exp-add-wrap">
    <div class="exp-add-row">
      <input class="fi" id="expDesc" placeholder="Descripci√≥n" style="flex:2">
      <div style="display:flex;align-items:center;gap:2px;flex:1"><span class="exp-cur">‚Ç¨</span><input class="fi" id="expAmt" placeholder="0" type="number" style="flex:1"></div>
    </div>
    <div class="exp-add-row">
      <select class="fs" id="expCity" style="flex:1"><option>Madrid</option><option>Barcelona</option><option>Valencia</option></select>
      <select class="fs" id="expCat" style="flex:1"><option value="comida">Comida</option><option value="transporte">Transporte</option><option value="alojamiento">Alojamiento</option><option value="entradas">Entradas</option><option value="compras">Compras</option><option value="otro">Otro</option></select>
      <button class="btn-add" onclick="addExp()" style="flex:0;padding:9px 16px">+</button>
    </div>
  </div>`;
  h+=`</div></div>`;
  return h;
}

function weatherBarHTML(){
  if(!S.weather)return '';
  const fd=S.filt==="Todos"?S.data:S.data.filter(d=>d.city===S.filt);
  let h='<div class="weather-bar">';
  fd.forEach(day=>{
    const w=S.weather[day.date];
    if(!w)return;
    const dn=day.date.slice(8);
    h+=`<div class="wx"><div class="wx-d">${dn}</div><div class="wx-i">${w.icon}</div><div class="wx-t">${w.hi}</div>${w.rain?`<div class="wx-r">üíß${w.rain}</div>`:''}</div>`;
  });
  h+='</div>';
  return h;
}

function R(){
  const t=tm();
  const today=getTodayStr();
  const cd=getCountdown();
  let h='';

  if(db)h+=`<div class="sync ${S.on?'on':'off'}">${S.on?'‚óè Sincronizado':'‚óã Offline'}</div>`;

  // Hero
  h+=`<div class="hero">
    <div class="hero-top">
      <div><h1>Espa√±a <span class="yr">2026</span></h1><div class="sub">5 ‚Äî 20 de Junio ¬∑ 16 d√≠as</div></div>
      ${db?'<button class="share-btn" onclick="sM()">üîó</button>':''}
    </div>
    <div class="countdown">
      <div class="cd-num">${cd.type==='before'?cd.days:cd.type==='during'?cd.days:'‚úì'}</div>
      <div class="cd-info">
        <div class="cd-label">${cd.text}</div>
        <div class="cd-sub">${cd.live?`<span class="cd-live">En viaje</span>`:cd.sub}</div>
      </div>
    </div>
    <div class="route-wrap">
      <div class="route-label"><span>Ruta</span></div>
      <div class="route-bar">${ROUTE.map(r=>
        `<div class="route-seg" style="flex:${r.days};background:${CC[r.city]}"><span class="city-name">${r.city==='Vuelo'?'‚úàÔ∏è':r.city}</span><span class="dates">${r.dates}</span></div>`
      ).join('')}</div>
    </div>
    <div class="city-legend">${CTS.map(c=>{
      const isOn=S.filt===c;
      if(c==="Todos") return `<div class="city-chip ${isOn?'on':''}" onclick="flt('${c}')">‚ö° Todos</div>`;
      return `<div class="city-chip ${isOn?'on':''}" onclick="flt('${c}')"><span class="cdot" style="background:${CC[c]}"></span>${c}</div>`;
    }).join('')}</div>
  </div>`;

  // Weather bar
  h+=weatherBarHTML();

  // CALENDAR
  h+=`<div class="cal-section"><div class="cal">
    <div class="cal-head"><div class="cal-dot"></div><div class="cal-month">Junio 2026</div><div class="cal-dot"></div></div>
    <div class="cal-wk-header"><span></span>${['L','M','X','J','V','S','D'].map(d=>`<span>${d}</span>`).join('')}</div>
    ${calWeeks()}
  </div></div>`;

  // Tabs
  h+=`<div class="tab-bar">
    <button class="tab-btn ${S.tab==='timeline'?'on':''}" onclick="setTab('timeline')">üìÖ Timeline</button>
    <button class="tab-btn ${S.tab==='checklist'?'on':''}" onclick="setTab('checklist')">üß≥ Checklist</button>
    <button class="tab-btn ${S.tab==='expenses'?'on':''}" onclick="setTab('expenses')">üí∞ Gastos</button>
  </div>`;

  // Tab content
  if(S.tab==='timeline'){
    // F1 Banner (show if Barcelona filter or Todos)
    if(S.filt==='Todos'||S.filt==='Barcelona'){
      const f1cd=getCountdown();
      const f1start=new Date('2026-06-12');
      const now=new Date();
      const f1diff=Math.ceil((f1start-now)/(1000*60*60*24));
      let f1sub=f1diff>0?`Faltan ${f1diff} d√≠as`:'';
      if(f1diff===0) f1sub='¬°Hoy!';
      if(f1diff<0) f1sub='Completado';
      h+=`<div class="f1-banner">
        <div class="f1-banner-title">üèéÔ∏è GP de Espa√±a</div>
        <div class="f1-banner-sub">Circuit de Barcelona-Catalunya ¬∑ Jun 12‚Äì14</div>
        ${f1sub?`<div class="f1-badge">üèÅ ${f1sub}</div>`:''}
      </div>`;
    }

    h+=`<div class="sec-title">Timeline</div>`;
    h+='<div class="timeline">';
    const fd=S.filt==="Todos"?S.data:S.data.filter(d=>d.city===S.filt);
    fd.forEach(day=>{
      const isActive=S.sel===day.date;
      const isF1=F1_DATES.includes(day.date);
      const isToday=day.date===today;
      const cls=['tl-day'];
      if(isActive)cls.push('active');
      if(isF1)cls.push('f1-day');
      if(isToday)cls.push('is-today');
      h+=`<div class="${cls.join(' ')}" id="day-${day.date}">
        <div class="tl-node"><div class="tl-node-inner" style="background:${isF1?'#E8364F':day.color}"></div></div>
        <div class="tl-header" onclick="sel('${day.date}')">
          <span class="tl-emoji">${day.icon}</span>
          <div class="tl-date-info">
            <div class="tl-date">${day.label}${isToday?' ¬∑ <span style="color:var(--blue);font-size:12px">HOY</span>':''}</div>
            <span class="tl-city" style="background:${isF1?'linear-gradient(135deg,#E8364F,#ff6b35)':day.color}">${day.city}${isF1?' ¬∑ F1':''}</span>
          </div>
          <span class="tl-count">${day.events.length}</span>
        </div>
        <div class="tl-events"><div class="tl-events-inner">`;
      h+=eventsHTML(day);
      if(isActive){
        h+=notesHTML(day.date);
        h+=addFormHTML(day.date);
      }
      h+=`</div></div></div>`;
    });
    h+='</div>';
  } else if(S.tab==='checklist'){
    h+=checklistHTML();
  } else if(S.tab==='expenses'){
    h+=expensesHTML();
  }

  h+='<div class="bottom-space"></div>';

  // Modal
  if(S.modal){const u=location.href;
    h+=`<div class="mbg" onclick="cM()"><div class="msh" onclick="event.stopPropagation()">
      <h2>üîó Compartir</h2><p>Mand√°le este link a tu compa√±ero de viaje. Los cambios se sincronizan al instante.</p>
      <div class="sbox"><span>${u}</span><button class="cpb" onclick="cpL()">Copiar</button></div>
      <button class="clb" onclick="cM()">Cerrar</button>
    </div></div>`;
  }
  document.getElementById('app').innerHTML=h;
}

function setTab(t){S.tab=t;R()}
function sel(d){S.sel=S.sel===d?null:d;S.add=false;R();if(S.sel)setTimeout(()=>{const e=document.getElementById('day-'+d);if(e)e.scrollIntoView({behavior:'smooth',block:'nearest'})},60)}
function flt(c){S.filt=c;S.sel=null;R()}
function del(d,i){const x=S.data.findIndex(t=>t.date===d);if(x>=0){S.data[x].events.splice(i,1);save();R()}}
function addE(d){const t=document.getElementById('nt').value||'',n=document.getElementById('nn').value,de=document.getElementById('nd').value||'',ty=document.getElementById('ny').value;if(!n)return;const x=S.data.findIndex(t=>t.date===d);if(x>=0){S.data[x].events.push({time:t,title:n,detail:de,type:ty});S.add=false;save();R()}}
function sM(){S.modal=true;R()}
function cM(){S.modal=false;R()}
function cpL(){navigator.clipboard.writeText(location.href).then(()=>{const b=document.querySelector('.cpb');if(b){b.textContent='‚úì';setTimeout(()=>b.textContent='Copiar',1500)}})}

// Notes
let noteTimer=null;
function saveNote(date,val){
  S.notes[date]=val;
  clearTimeout(noteTimer);
  noteTimer=setTimeout(()=>saveNotes(),800);
}

// Checklist
function toggleCK(i){if(S.checklist&&S.checklist[i]!==undefined){S.checklist[i].done=!S.checklist[i].done;saveCK();R()}}
function addCK(){const inp=document.getElementById('ckInput');if(!inp||!inp.value.trim())return;S.checklist=S.checklist||[];S.checklist.push({text:inp.value.trim(),done:false,cat:"otro"});saveCK();R()}

// Expenses
function addExp(){
  const desc=document.getElementById('expDesc'),amt=document.getElementById('expAmt'),city=document.getElementById('expCity'),cat=document.getElementById('expCat');
  if(!desc||!desc.value.trim()||!amt||!amt.value)return;
  S.expenses=S.expenses||[];
  const today=getTodayStr();
  S.expenses.push({desc:desc.value.trim(),amount:Number(amt.value),city:city.value,cat:cat.value,date:today});
  saveExp();R();
}
function delExp(i){S.expenses.splice(i,1);saveExp();R()}

// Auto-scroll to today on load
function autoScroll(){
  const today=getTodayStr();
  const tripDates=S.data.map(d=>d.date);
  let target=null;
  if(tripDates.includes(today)){
    target=today;
  } else {
    // Find closest future date
    const future=tripDates.filter(d=>d>=today);
    if(future.length) target=future[0];
  }
  if(target){
    S.sel=target;
    R();
    setTimeout(()=>{const el=document.getElementById('day-'+target);if(el)el.scrollIntoView({behavior:'smooth',block:'center'})},300);
  }
}

(function(){
  const ch=document.getElementById('checkered');
  if(ch){const cols=Math.ceil(window.innerWidth/12);for(let r=0;r<2;r++)for(let c=0;c<cols;c++){const s=document.createElement('span');s.style.background=(r+c)%2===0?'#fff':'#222';ch.appendChild(s)}}
  initFB();
  fetchWeather();
  R();
  setTimeout(()=>{
    const sp=document.getElementById('splash');
    if(sp){sp.classList.add('hide');setTimeout(()=>{sp.remove();autoScroll()},600)}
  },2600);
})();
</script>
</body>
</html>
