<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Espa√±a 2026">
<meta name="theme-color" content="#0b1120">
<title>Espa√±a 2026</title>
<link rel="apple-touch-icon" href="icon-180.png">
<link rel="icon" type="image/png" href="icon-180.png">

<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
  * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

  :root {
    --safe-top: env(safe-area-inset-top, 20px);
    --safe-bottom: env(safe-area-inset-bottom, 0px);
    --red: #E8364F; --red-soft: #ffeef0;
    --blue: #1a2744; --blue-mid: #243356; --blue-light: #3b5998;
    --white: #ffffff;
    --bg: #0b1120; --card: #131c31; --card-hover: #1a2744;
    --text: #e8ecf4; --dim: #7b8ba5; --border: rgba(255,255,255,0.06);
    --r: 16px;
    --accent-gradient: linear-gradient(135deg, #E8364F, #ff6b81);
  }

  body {
    font-family: 'Inter', -apple-system, system-ui, sans-serif;
    background: var(--bg); color: var(--text);
    min-height: 100dvh; overflow-x: hidden;
    -webkit-font-smoothing: antialiased;
  }

  /* ====== SYNC PILL ====== */
  .sync {
    position: fixed; top: calc(var(--safe-top) + 6px); left: 50%; transform: translateX(-50%);
    z-index: 200; padding: 5px 14px; border-radius: 20px;
    font-size: 11px; font-weight: 700; letter-spacing: 0.4px;
    backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
    animation: fadeDown 0.5s cubic-bezier(0.16,1,0.3,1);
  }
  @keyframes fadeDown { from{opacity:0;transform:translateX(-50%) translateY(-12px)} to{opacity:1;transform:translateX(-50%) translateY(0)} }
  .sync.on { background: rgba(232,54,79,0.15); color: var(--red); border: 1px solid rgba(232,54,79,0.2); }
  .sync.off { background: rgba(123,139,165,0.15); color: var(--dim); border: 1px solid rgba(123,139,165,0.15); }

  /* ====== HERO HEADER ====== */
  .hero {
    padding: calc(var(--safe-top) + 48px) 20px 28px;
    position: relative; overflow: hidden;
    background: linear-gradient(180deg, #111b30 0%, var(--bg) 100%);
  }
  .hero::before {
    content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
    background: radial-gradient(circle at 30% 40%, rgba(232,54,79,0.08) 0%, transparent 50%),
                radial-gradient(circle at 70% 60%, rgba(59,89,152,0.06) 0%, transparent 50%);
    animation: heroPulse 8s ease-in-out infinite alternate;
  }
  @keyframes heroPulse { 0%{transform:scale(1)} 100%{transform:scale(1.1)} }

  .hero-inner { position: relative; z-index: 1; display: flex; align-items: center; justify-content: space-between; }
  .hero h1 { font-size: 28px; font-weight: 900; letter-spacing: -0.5px; color: #fff; line-height: 1.1; }
  .hero h1 .yr { background: var(--accent-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
  .hero .sub { font-size: 13px; color: var(--dim); font-weight: 500; margin-top: 6px; }

  .share-btn {
    width: 42px; height: 42px; border-radius: 14px;
    border: 1px solid var(--border); background: var(--card);
    color: var(--text); font-size: 16px; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.15s;
  }
  .share-btn:active { transform: scale(0.9); background: var(--card-hover); }

  /* Progress bar */
  .progress-wrap { position: relative; z-index: 1; margin-top: 20px; }
  .progress-label { display: flex; justify-content: space-between; margin-bottom: 8px; }
  .progress-label span { font-size: 11px; font-weight: 700; color: var(--dim); text-transform: uppercase; letter-spacing: 1px; }
  .progress-bar { display: flex; gap: 3px; border-radius: 10px; overflow: hidden; height: 6px; background: var(--card); }
  .progress-seg { height: 100%; transition: flex 0.4s ease; border-radius: 3px; }

  /* City legend */
  .city-legend { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 12px; position: relative; z-index: 1; }
  .city-chip {
    display: flex; align-items: center; gap: 5px; font-size: 11px; font-weight: 600;
    color: var(--dim); cursor: pointer; padding: 4px 10px; border-radius: 8px;
    transition: all 0.2s; border: 1px solid transparent;
  }
  .city-chip:active { transform: scale(0.95); }
  .city-chip.on { color: var(--text); background: var(--card); border-color: var(--border); }
  .city-chip .cdot { width: 8px; height: 8px; border-radius: 50%; }

  /* ====== TIMELINE ====== */
  .timeline { padding: 0 16px 120px; position: relative; }
  .timeline::before {
    content: ''; position: absolute; left: 31px; top: 0; bottom: 120px;
    width: 2px; background: linear-gradient(180deg, var(--border), rgba(232,54,79,0.2), var(--border));
  }

  /* Day group */
  .tl-day { position: relative; padding-left: 48px; margin-bottom: 4px; }
  .tl-day:last-child { margin-bottom: 0; }

  .tl-node {
    position: absolute; left: 22px; top: 18px;
    width: 20px; height: 20px; border-radius: 50%;
    border: 2.5px solid var(--card); z-index: 2;
    display: flex; align-items: center; justify-content: center;
  }
  .tl-node-inner {
    width: 8px; height: 8px; border-radius: 50%;
    transition: all 0.3s;
  }
  .tl-day.active .tl-node { border-color: var(--red); box-shadow: 0 0 12px rgba(232,54,79,0.3); }
  .tl-day.active .tl-node-inner { width: 10px; height: 10px; }

  /* Day header */
  .tl-header {
    padding: 14px 16px; display: flex; align-items: center; gap: 12px;
    cursor: pointer; border-radius: var(--r); transition: background 0.2s;
    -webkit-user-select: none; user-select: none;
  }
  .tl-header:active { background: var(--card); }
  .tl-day.active .tl-header { background: var(--card); }

  .tl-emoji { font-size: 22px; }
  .tl-date-info { flex: 1; }
  .tl-date { font-size: 15px; font-weight: 800; color: var(--text); letter-spacing: -0.2px; }
  .tl-city {
    display: inline-flex; align-items: center; gap: 4px;
    font-size: 11px; font-weight: 700; padding: 2px 8px;
    border-radius: 6px; color: #fff; margin-top: 3px;
  }
  .tl-count {
    font-size: 11px; font-weight: 700; color: var(--dim);
    background: var(--card); padding: 4px 10px; border-radius: 8px;
  }
  .tl-day.active .tl-count { background: var(--blue-mid); }

  /* Events container */
  .tl-events {
    max-height: 0; overflow: hidden; transition: max-height 0.4s cubic-bezier(0.16,1,0.3,1);
    padding-left: 4px;
  }
  .tl-day.active .tl-events { max-height: 800px; }
  .tl-events-inner { padding: 0 0 12px; }

  .ev {
    display: flex; align-items: flex-start; padding: 10px 16px; gap: 12px;
    border-radius: 12px; margin-bottom: 2px; transition: background 0.15s;
  }
  .ev:active { background: var(--card-hover); }
  .ev-ic {
    width: 38px; height: 38px; border-radius: 11px;
    display: flex; align-items: center; justify-content: center;
    font-size: 16px; flex-shrink: 0;
  }
  .ev-ic.flight { background: rgba(99,102,241,0.15); }
  .ev-ic.transport { background: rgba(123,139,165,0.1); }
  .ev-ic.tourism { background: rgba(232,54,79,0.1); }
  .ev-ic.food { background: rgba(251,191,36,0.12); }
  .ev-ic.f1 { background: linear-gradient(135deg, rgba(232,54,79,0.15), rgba(255,107,129,0.1)); }
  .ev-nfo { flex: 1; min-width: 0; }
  .ev-t { font-size: 10px; font-weight: 700; color: var(--red); letter-spacing: 0.5px; text-transform: uppercase; }
  .ev-n { font-size: 14px; font-weight: 700; color: var(--text); margin-top: 1px; }
  .ev-d { font-size: 12px; color: var(--dim); margin-top: 2px; }
  .ev-x {
    background: none; border: none; color: var(--dim); font-size: 16px;
    cursor: pointer; padding: 4px 6px; border-radius: 8px; opacity: 0.2;
    flex-shrink: 0; transition: all 0.15s;
  }
  .ev-x:active { opacity: 1; color: var(--red); background: rgba(232,54,79,0.1); }

  /* Add event */
  .add-b {
    display: flex; align-items: center; justify-content: center; gap: 5px;
    padding: 12px; color: var(--red); font-size: 13px; font-weight: 700;
    cursor: pointer; border: none; background: none; width: 100%;
    font-family: inherit; transition: background 0.15s;
    border-top: 1px solid var(--border); border-radius: 0 0 var(--r) var(--r);
  }
  .add-b:active { background: rgba(232,54,79,0.05); }
  .add-f {
    padding: 14px 16px 16px; border-top: 1px solid var(--border);
    animation: slideUp 0.2s ease;
  }
  .fr { display: flex; gap: 6px; margin-bottom: 6px; }
  .fi {
    background: var(--blue-mid); border: 1.5px solid var(--border);
    border-radius: 10px; padding: 10px 12px; font-size: 14px;
    font-family: inherit; color: var(--text); outline: none; width: 100%;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  .fi:focus { border-color: var(--red); box-shadow: 0 0 0 3px rgba(232,54,79,0.1); }
  .fi::placeholder { color: var(--dim); }
  .fi.tm { width: 72px; flex-shrink: 0; }
  .fs {
    background: var(--blue-mid); border: 1.5px solid var(--border);
    border-radius: 10px; padding: 10px 12px; font-size: 14px;
    font-family: inherit; color: var(--text); outline: none;
  }
  .fa { display: flex; gap: 6px; margin-top: 4px; }
  .btn-add {
    background: var(--accent-gradient); color: #fff; border: none;
    padding: 11px 18px; border-radius: 10px; font-size: 14px;
    font-weight: 700; cursor: pointer; flex: 1; font-family: inherit;
    box-shadow: 0 4px 14px rgba(232,54,79,0.25);
    transition: transform 0.15s;
  }
  .btn-add:active { transform: scale(0.97); }
  .btn-cancel {
    background: var(--card); color: var(--dim); border: 1.5px solid var(--border);
    padding: 11px 18px; border-radius: 10px; font-size: 14px;
    font-weight: 600; cursor: pointer; font-family: inherit;
  }

  /* Hint */
  .hint { text-align: center; padding: 40px 20px; color: var(--dim); }
  .hint-i { font-size: 48px; display: block; margin-bottom: 10px; }
  .hint-t { font-size: 14px; font-weight: 500; line-height: 1.5; }

  /* Modal */
  .mbg {
    position: fixed; inset: 0; background: rgba(0,0,0,0.6);
    backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
    z-index: 300; display: flex; align-items: flex-end;
    justify-content: center; animation: fadein .2s;
  }
  @keyframes fadein { from{opacity:0} to{opacity:1} }
  .msh {
    background: var(--card); border-radius: 24px 24px 0 0;
    padding: 24px 20px calc(var(--safe-bottom) + 24px);
    width: 100%; max-width: 420px;
    animation: sheetUp .3s cubic-bezier(0.16,1,0.3,1);
  }
  @keyframes sheetUp { from{transform:translateY(100%)} to{transform:translateY(0)} }
  .msh h2 { font-size: 20px; font-weight: 800; color: var(--text); margin-bottom: 4px; }
  .msh p { color: var(--dim); font-size: 13px; margin-bottom: 14px; line-height: 1.5; }
  .sbox {
    background: var(--blue-mid); border-radius: 12px; padding: 12px;
    display: flex; align-items: center; gap: 8px; margin-bottom: 14px;
  }
  .sbox span { flex: 1; color: var(--red); font-size: 11px; font-family: ui-monospace, monospace; word-break: break-all; }
  .cpb {
    background: var(--accent-gradient); color: #fff; border: none;
    padding: 7px 14px; border-radius: 8px; font-size: 12px;
    font-weight: 700; cursor: pointer; flex-shrink: 0;
  }
  .clb {
    background: var(--blue-mid); color: var(--dim); border: none;
    padding: 12px; border-radius: 12px; width: 100%;
    font-size: 15px; font-weight: 600; cursor: pointer; font-family: inherit;
  }

  @keyframes slideUp { from{opacity:0;transform:translateY(24px)} to{opacity:1;transform:translateY(0)} }

  /* ===== F1 Splash Animation ===== */
  .splash {
    position: fixed; inset: 0; z-index: 9999;
    background: linear-gradient(135deg, #0b1120 0%, #1a2744 100%);
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    transition: opacity 0.5s ease, transform 0.5s ease;
    overflow: hidden;
  }
  .splash.hide { opacity: 0; transform: scale(1.05); pointer-events: none; }
  .splash::before, .splash::after {
    content: ''; position: absolute; left: 0; right: 0; height: 2px;
    background: repeating-linear-gradient(90deg, rgba(255,255,255,0.05) 0px, rgba(255,255,255,0.05) 20px, transparent 20px, transparent 40px);
  }
  .splash::before { top: 38%; }
  .splash::after { bottom: 38%; }
  .speed-lines { position: absolute; inset: 0; overflow: hidden; }
  .speed-line {
    position: absolute; height: 1px; background: linear-gradient(90deg, transparent, rgba(232,54,79,0.4), transparent);
    animation: speedLine 0.8s linear infinite;
  }
  @keyframes speedLine { 0%{transform:translateX(-100%)} 100%{transform:translateX(200vw)} }
  .f1-car-wrap {
    position: relative; z-index: 2;
    animation: carEntry 1.2s cubic-bezier(0.16,1,0.3,1) forwards;
  }
  @keyframes carEntry {
    0%{transform:translateX(-120vw) scale(0.8);opacity:0} 40%{opacity:1}
    70%{transform:translateX(0) scale(1)} 85%{transform:translateX(10px) scale(1)}
    100%{transform:translateX(0) scale(1);opacity:1}
  }
  .f1-car { font-size: 72px; filter: drop-shadow(0 0 30px rgba(232,54,79,0.5)); animation: carBounce 0.6s ease-in-out infinite alternate; animation-delay: 1.2s; }
  @keyframes carBounce { 0%{transform:translateY(0)} 100%{transform:translateY(-3px)} }
  .smoke {
    position: absolute; bottom: -10px; left: -60px;
    width: 80px; height: 30px; border-radius: 50%;
    background: radial-gradient(ellipse, rgba(255,255,255,0.2), transparent);
    animation: smokeAnim 1s ease-out forwards; animation-delay: 0.8s; opacity: 0;
  }
  @keyframes smokeAnim { 0%{opacity:0;transform:scale(0.5) translateX(0)} 50%{opacity:0.6} 100%{opacity:0;transform:scale(2) translateX(-40px)} }
  .splash-title {
    position: relative; z-index: 2; margin-top: 28px; text-align: center;
    animation: titleReveal 0.6s cubic-bezier(0.16,1,0.3,1) forwards;
    animation-delay: 0.7s; opacity: 0; transform: translateY(20px);
  }
  @keyframes titleReveal { to{opacity:1;transform:translateY(0)} }
  .splash-title h2 { font-size: 32px; font-weight: 900; color: #fff; letter-spacing: -1px; text-shadow: 0 2px 20px rgba(0,0,0,0.3); }
  .splash-title h2 .red { color: var(--red); }
  .splash-title .year { font-size: 14px; font-weight: 600; color: rgba(255,255,255,0.4); letter-spacing: 6px; margin-top: 6px; text-transform: uppercase; }
  .checkered {
    position: absolute; bottom: 0; left: 0; right: 0; height: 24px;
    display: flex; flex-wrap: wrap;
    animation: checkReveal 0.4s ease forwards; animation-delay: 1s; opacity: 0;
  }
  @keyframes checkReveal { to{opacity:1} }
  .checkered span { width: 12px; height: 12px; display: inline-block; }
  .splash-dots {
    position: relative; z-index: 2; margin-top: 20px;
    display: flex; gap: 6px;
    animation: titleReveal 0.5s ease forwards; animation-delay: 1s; opacity: 0;
  }
  .splash-dots span { width: 6px; height: 6px; border-radius: 50%; background: var(--red); animation: dotPulse 1s ease infinite; }
  .splash-dots span:nth-child(2) { animation-delay: 0.2s; }
  .splash-dots span:nth-child(3) { animation-delay: 0.4s; }
  @keyframes dotPulse { 0%,80%,100%{opacity:0.3;transform:scale(0.8)} 40%{opacity:1;transform:scale(1.2)} }
</style>
</head>
<body>
<div id="splash" class="splash">
  <div class="speed-lines">
    <div class="speed-line" style="top:20%;width:40%;animation-delay:0.1s;animation-duration:0.7s"></div>
    <div class="speed-line" style="top:35%;width:60%;animation-delay:0.3s;animation-duration:0.6s"></div>
    <div class="speed-line" style="top:50%;width:35%;animation-delay:0s;animation-duration:0.8s"></div>
    <div class="speed-line" style="top:65%;width:50%;animation-delay:0.2s;animation-duration:0.65s"></div>
    <div class="speed-line" style="top:80%;width:45%;animation-delay:0.4s;animation-duration:0.75s"></div>
  </div>
  <div class="f1-car-wrap">
    <div class="f1-car">üèéÔ∏è</div>
    <div class="smoke"></div>
  </div>
  <div class="splash-title">
    <h2>Espa√±a <span class="red">F1</span></h2>
    <div class="year">Junio 2026</div>
  </div>
  <div class="splash-dots"><span></span><span></span><span></span></div>
  <div class="checkered" id="checkered"></div>
</div>
<div id="app"></div>
<script>
const TRIP=[
  {date:"2026-06-05",label:"Viernes 5",city:"Vuelo",color:"#6366f1",icon:"‚úàÔ∏è",events:[{time:"21:45",title:"Vuelo a Madrid",detail:"IB 170 ‚Äî Salida 9:45pm",type:"flight"}]},
  {date:"2026-06-06",label:"S√°bado 6",city:"Madrid",color:"#E8364F",icon:"üè∞",events:[{time:"üåÖ",title:"Llegada a Madrid",detail:"Check-in y descanso",type:"transport"},{time:"üåÜ",title:"Paseo por el centro",detail:"Puerta del Sol, Plaza Mayor",type:"tourism"}]},
  {date:"2026-06-07",label:"Domingo 7",city:"Madrid",color:"#E8364F",icon:"üè∞",events:[{time:"üåÖ",title:"Museo del Prado",detail:"Reservar entrada online",type:"tourism"},{time:"üåÜ",title:"Parque del Retiro",detail:"Paseo y Palacio de Cristal",type:"tourism"}]},
  {date:"2026-06-08",label:"Lunes 8",city:"Madrid",color:"#E8364F",icon:"üè∞",events:[{time:"üåÖ",title:"Palacio Real",detail:"Visita guiada",type:"tourism"},{time:"üåÜ",title:"Barrio de La Latina",detail:"Tapas y paseo",type:"food"}]},
  {date:"2026-06-09",label:"Martes 9",city:"Toledo",color:"#457b9d",icon:"‚öîÔ∏è",events:[{time:"üåÖ",title:"Excursi√≥n a Toledo",detail:"Tren AVE (~30 min)",type:"transport"},{time:"üïê",title:"Casco hist√≥rico",detail:"Catedral, Alc√°zar, calles medievales",type:"tourism"}]},
  {date:"2026-06-10",label:"Mi√©rcoles 10",city:"Toledo",color:"#457b9d",icon:"‚öîÔ∏è",events:[{time:"üåÖ",title:"Toledo d√≠a 2",detail:"Sinagoga, Museo del Greco, miradores",type:"tourism"},{time:"üåÜ",title:"Regreso a Madrid",detail:"Tren de vuelta",type:"transport"}]},
  {date:"2026-06-11",label:"Jueves 11",city:"Barcelona",color:"#3b5998",icon:"üåä",events:[{time:"üåÖ",title:"Viaje a Barcelona",detail:"Traslado y check-in Airbnb",type:"transport"},{time:"üåÜ",title:"Las Ramblas",detail:"Barrio G√≥tico, La Boquer√≠a",type:"tourism"}]},
  {date:"2026-06-12",label:"Viernes 12",city:"Barcelona",color:"#3b5998",icon:"üèéÔ∏è",events:[{time:"üèÅ",title:"F1 ‚Äî Pr√°ctica Libre",detail:"Circuit de Barcelona-Catalunya",type:"f1"}]},
  {date:"2026-06-13",label:"S√°bado 13",city:"Barcelona",color:"#3b5998",icon:"üèéÔ∏è",events:[{time:"üèÅ",title:"F1 ‚Äî Clasificaci√≥n",detail:"Circuit de Barcelona-Catalunya",type:"f1"}]},
  {date:"2026-06-14",label:"Domingo 14",city:"Barcelona",color:"#3b5998",icon:"üèéÔ∏è",events:[{time:"üèÅ",title:"F1 ‚Äî Carrera",detail:"Circuit de Barcelona-Catalunya",type:"f1"}]},
  {date:"2026-06-15",label:"Lunes 15",city:"Barcelona",color:"#3b5998",icon:"üåä",events:[{time:"üåÖ",title:"Sagrada Familia",detail:"Reservar entrada online",type:"tourism"},{time:"üåÜ",title:"Park G√ºell",detail:"Zona monumental de Gaud√≠",type:"tourism"}]},
  {date:"2026-06-16",label:"Martes 16",city:"Barcelona",color:"#3b5998",icon:"üåä",events:[{time:"üåÖ",title:"Barceloneta",detail:"Playa y paseo mar√≠timo",type:"tourism"},{time:"üåÜ",title:"Casa Batll√≥ / La Pedrera",detail:"Arquitectura de Gaud√≠",type:"tourism"}]},
  {date:"2026-06-17",label:"Mi√©rcoles 17",city:"Valencia",color:"#2a9d8f",icon:"üçä",events:[{time:"üåÖ",title:"Viaje a Valencia",detail:"Traslado desde Barcelona",type:"transport"},{time:"üåÜ",title:"Ciudad de las Artes y las Ciencias",detail:"Oceanogr√†fic, Hemisf√®ric",type:"tourism"}]},
  {date:"2026-06-18",label:"Jueves 18",city:"Valencia",color:"#2a9d8f",icon:"üçä",events:[{time:"üåÖ",title:"Centro hist√≥rico",detail:"Catedral, Lonja de la Seda, Mercado Central",type:"tourism"},{time:"üåÜ",title:"Playa de la Malvarrosa",detail:"Paella frente al mar",type:"food"}]},
  {date:"2026-06-19",label:"Viernes 19",city:"Madrid",color:"#E8364F",icon:"üè∞",events:[{time:"üåÖ",title:"Regreso a Madrid",detail:"Traslado desde Valencia",type:"transport"},{time:"üåÜ",title:"√öltimas compras",detail:"Gran V√≠a, Malasa√±a, cena de despedida",type:"tourism"}]},
  {date:"2026-06-20",label:"S√°bado 20",city:"Vuelo",color:"#6366f1",icon:"‚úàÔ∏è",events:[{time:"06:50",title:"Vuelo a Montevideo",detail:"IB 169 ‚Äî Salida 6:50am",type:"flight"}]}
];
const CC={Madrid:"#E8364F",Toledo:"#457b9d",Barcelona:"#3b5998",Valencia:"#2a9d8f",Vuelo:"#6366f1"};
const EI={flight:"‚úàÔ∏è",transport:"üöå",tourism:"üìç",food:"üçΩÔ∏è",f1:"üèéÔ∏è"};
const CTS=["Todos","Madrid","Toledo","Barcelona","Valencia"];

let S={data:JSON.parse(JSON.stringify(TRIP)),sel:null,add:false,modal:false,on:false,filt:"Todos"};
let db=null,ref=null;

const FC={apiKey:"AIzaSyDPZPk2nsOQ3oRMG7ADhS56zEFyORTE4QQ",authDomain:"flor-y-pato-trip.firebaseapp.com",databaseURL:"https://flor-y-pato-trip-default-rtdb.firebaseio.com",projectId:"flor-y-pato-trip",storageBucket:"flor-y-pato-trip.firebasestorage.app",messagingSenderId:"862498607498",appId:"1:862498607498:web:7e2ccf24cd913e6cb7c5c3"};

function initFB(){try{firebase.initializeApp(FC);db=firebase.database();ref=db.ref('trip-espana-2026');ref.on('value',s=>{const d=s.val();if(d&&Array.isArray(d)){S.data=d;S.on=true;R()}});db.ref('.info/connected').on('value',s=>{S.on=s.val()===true;R()});ref.once('value',s=>{if(!s.val())ref.set(TRIP)});return true}catch(e){return false}}
function save(){if(ref)ref.set(S.data)}
function tm(){const m={};S.data.forEach(d=>{m[d.date]=d});return m}

function R(){
  const t=tm();
  const cnt={};S.data.forEach(d=>{if(d.city!=="Vuelo")cnt[d.city]=(cnt[d.city]||0)+1});
  const total=Object.values(cnt).reduce((a,b)=>a+b,0);
  let h='';

  if(db)h+=`<div class="sync ${S.on?'on':'off'}">${S.on?'‚óè Sincronizado':'‚óã Offline'}</div>`;

  // Hero header
  h+=`<div class="hero">
    <div class="hero-inner">
      <div>
        <h1>Espa√±a <span class="yr">2026</span></h1>
        <div class="sub">5 ‚Äî 20 de Junio ¬∑ 16 d√≠as</div>
      </div>
      ${db?'<button class="share-btn" onclick="sM()">üîó</button>':''}
    </div>
    <div class="progress-wrap">
      <div class="progress-label"><span>Ruta</span><span>${S.data.length} d√≠as</span></div>
      <div class="progress-bar">${Object.entries(cnt).map(([c,n])=>
        `<div class="progress-seg" style="flex:${n};background:${CC[c]}"></div>`
      ).join('')}</div>
    </div>
    <div class="city-legend">${CTS.map(c=>{
      const isOn=S.filt===c;
      if(c==="Todos") return `<div class="city-chip ${isOn?'on':''}" onclick="flt('${c}')"><span style="font-size:12px">‚ö°</span> Todos</div>`;
      return `<div class="city-chip ${isOn?'on':''}" onclick="flt('${c}')"><span class="cdot" style="background:${CC[c]}"></span>${c}</div>`;
    }).join('')}</div>
  </div>`;

  // Timeline
  h+='<div class="timeline">';

  const fd=S.filt==="Todos"?S.data:S.data.filter(d=>d.city===S.filt);

  fd.forEach(day=>{
    const isActive=S.sel===day.date;
    h+=`<div class="tl-day ${isActive?'active':''}" id="day-${day.date}">
      <div class="tl-node"><div class="tl-node-inner" style="background:${day.color}"></div></div>
      <div class="tl-header" onclick="sel('${day.date}')">
        <span class="tl-emoji">${day.icon}</span>
        <div class="tl-date-info">
          <div class="tl-date">${day.label}</div>
          <span class="tl-city" style="background:${day.color}">${day.city}</span>
        </div>
        <span class="tl-count">${day.events.length} ${day.events.length===1?'evento':'eventos'}</span>
      </div>
      <div class="tl-events"><div class="tl-events-inner">`;

    day.events.forEach((e,j)=>{
      h+=`<div class="ev">
        <div class="ev-ic ${e.type}">${EI[e.type]||'üìç'}</div>
        <div class="ev-nfo"><div class="ev-t">${e.time}</div><div class="ev-n">${e.title}</div><div class="ev-d">${e.detail}</div></div>
        <button class="ev-x" onclick="event.stopPropagation();del('${day.date}',${j})">√ó</button>
      </div>`;
    });

    // Add event button/form
    if(isActive){
      h+=S.add?`<div class="add-f">
        <div class="fr"><input class="fi tm" id="nt" placeholder="Hora"><input class="fi" id="nn" placeholder="T√≠tulo"></div>
        <div class="fr"><input class="fi" id="nd" placeholder="Detalle"></div>
        <div class="fr"><select class="fs" id="ny"><option value="tourism">Turismo</option><option value="transport">Transporte</option><option value="food">Comida</option><option value="f1">F1</option><option value="flight">Vuelo</option></select></div>
        <div class="fa"><button class="btn-add" onclick="addE('${day.date}')">Agregar</button><button class="btn-cancel" onclick="S.add=false;R()">Cancelar</button></div>
      </div>`:`<button class="add-b" onclick="event.stopPropagation();S.add=true;R()">+ Agregar actividad</button>`;
    }

    h+=`</div></div></div>`;
  });

  h+='</div>';

  // Modal
  if(S.modal){const u=location.href;
    h+=`<div class="mbg" onclick="cM()"><div class="msh" onclick="event.stopPropagation()">
      <h2>üîó Compartir</h2><p>Mand√°le este link a tu compa√±ero de viaje. Los cambios se sincronizan al instante.</p>
      <div class="sbox"><span>${u}</span><button class="cpb" onclick="cpL()">Copiar</button></div>
      <button class="clb" onclick="cM()">Cerrar</button>
    </div></div>`;
  }
  document.getElementById('app').innerHTML=h;
}

function sel(d){S.sel=S.sel===d?null:d;S.add=false;R();if(S.sel)setTimeout(()=>{const e=document.getElementById('day-'+d);if(e)e.scrollIntoView({behavior:'smooth',block:'nearest'})},60)}
function flt(c){S.filt=c;S.sel=null;R()}
function del(d,i){const x=S.data.findIndex(t=>t.date===d);if(x>=0){S.data[x].events.splice(i,1);save();R()}}
function addE(d){const t=document.getElementById('nt').value||'üïê',n=document.getElementById('nn').value,de=document.getElementById('nd').value||'',ty=document.getElementById('ny').value;if(!n)return;const x=S.data.findIndex(t=>t.date===d);if(x>=0){S.data[x].events.push({time:t,title:n,detail:de,type:ty});S.add=false;save();R()}}
function sM(){S.modal=true;R()}
function cM(){S.modal=false;R()}
function cpL(){navigator.clipboard.writeText(location.href).then(()=>{const b=document.querySelector('.cpb');if(b){b.textContent='‚úì';setTimeout(()=>b.textContent='Copiar',1500)}})}

(function(){
  const ch=document.getElementById('checkered');
  if(ch){
    const cols=Math.ceil(window.innerWidth/12);
    for(let r=0;r<2;r++)for(let c=0;c<cols;c++){
      const s=document.createElement('span');
      s.style.background=(r+c)%2===0?'#fff':'#222';
      ch.appendChild(s);
    }
  }
  initFB();R();
  setTimeout(()=>{
    const sp=document.getElementById('splash');
    if(sp){sp.classList.add('hide');setTimeout(()=>sp.remove(),600);}
  },2600);
})();
</script>
</body>
</html>
