<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Flor & Pato â€” EspaÃ±a 2026</title>
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
:root{
  --bg:#f8f9fc;--card:#fff;--text:#0f172a;--sub:#64748b;--r:20px;
  --madrid:#D71920;--barcelona:#004D98;--valencia:#FF6B2B;--vuelo:#6366f1;
  --safe-top:env(safe-area-inset-top,0px);
  --shadow-sm:0 1px 2px rgba(0,0,0,.04),0 1px 3px rgba(0,0,0,.06);
  --shadow-md:0 4px 6px -1px rgba(0,0,0,.07),0 2px 4px -2px rgba(0,0,0,.05);
  --shadow-lg:0 10px 25px -5px rgba(0,0,0,.08),0 8px 10px -6px rgba(0,0,0,.04);
  --glass:rgba(255,255,255,.7);
  --glass-border:rgba(255,255,255,.2);
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',-apple-system,BlinkMacSystemFont,'SF Pro',sans-serif;background:var(--bg);color:var(--text);-webkit-tap-highlight-color:transparent;overflow-x:hidden;-webkit-font-smoothing:antialiased;letter-spacing:-.01em}

/* â”€â”€ SPLASH â”€â”€ */
#splash{position:fixed;inset:0;z-index:9999;background:#0a0e1a;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:all 1s cubic-bezier(.4,0,.2,1)}
#splash.hide{opacity:0;pointer-events:none;transform:scale(1.08);filter:blur(8px)}
/* Carbon fiber texture */
#splash::before{content:'';position:absolute;inset:0;background:repeating-linear-gradient(45deg,transparent,transparent 2px,rgba(255,255,255,.015) 2px,rgba(255,255,255,.015) 4px);pointer-events:none}
/* Rotating ambient glow */
#splash::after{content:'';position:absolute;width:300px;height:300px;border-radius:50%;background:radial-gradient(circle,rgba(239,0,0,.08),transparent 70%);animation:ambientGlow 4s ease-in-out infinite alternate;pointer-events:none}
@keyframes ambientGlow{0%{transform:translate(-60px,-40px) scale(.8);opacity:.5}100%{transform:translate(60px,40px) scale(1.2);opacity:1}}
.splash-flag{width:72px;height:45px;border-radius:8px;overflow:hidden;margin-bottom:28px;animation:flagWave 2.5s ease-in-out infinite,flagAppear 1s cubic-bezier(.16,1,.3,1) both;box-shadow:0 8px 32px rgba(0,0,0,.4);position:relative;z-index:1}
@keyframes flagAppear{from{opacity:0;transform:scale(.3) rotate(-20deg);filter:blur(8px)}to{opacity:1;transform:scale(1) rotate(-2deg);filter:blur(0)}}
.splash-flag div{height:25%}
.splash-flag div:nth-child(1),.splash-flag div:nth-child(4){background:#c60b1e}
.splash-flag div:nth-child(2),.splash-flag div:nth-child(3){background:#ffc400}
@keyframes flagWave{0%,100%{transform:rotate(-2deg) scale(1)}50%{transform:rotate(2deg) scale(1.04)}}
.splash-title{font-size:28px;font-weight:900;color:#fff;letter-spacing:-.5px;margin-bottom:4px;animation:textReveal .7s cubic-bezier(.16,1,.3,1) .4s both;position:relative;z-index:1}
.splash-sub{font-size:12px;color:rgba(255,255,255,.3);letter-spacing:5px;text-transform:uppercase;margin-bottom:40px;font-weight:500;animation:textReveal .7s cubic-bezier(.16,1,.3,1) .6s both;position:relative;z-index:1}
@keyframes textReveal{from{opacity:0;transform:translateY(20px);filter:blur(6px)}to{opacity:1;transform:translateY(0);filter:blur(0)}}
/* F1 Lights housing */
.splash-lights{display:flex;gap:10px;margin-bottom:24px;animation:lightsAppear .5s cubic-bezier(.16,1,.3,1) .8s both;position:relative;z-index:1;background:rgba(0,0,0,.4);padding:8px 16px;border-radius:20px;border:1px solid rgba(255,255,255,.06)}
@keyframes lightsAppear{from{opacity:0;transform:scaleX(.5)}to{opacity:1;transform:scaleX(1)}}
.splash-lights span{width:16px;height:16px;border-radius:50%;background:#1a1a1a;border:1px solid #2a2a2a;box-shadow:inset 0 2px 4px rgba(0,0,0,.8),0 1px 1px rgba(255,255,255,.03)}
.splash-lights span:nth-child(1){animation:f1L1 6s 1.2s infinite}
.splash-lights span:nth-child(2){animation:f1L2 6s 1.2s infinite}
.splash-lights span:nth-child(3){animation:f1L3 6s 1.2s infinite}
.splash-lights span:nth-child(4){animation:f1L4 6s 1.2s infinite}
.splash-lights span:nth-child(5){animation:f1L5 6s 1.2s infinite}
@keyframes f1L1{0%,9%{background:#1a1a1a;box-shadow:inset 0 2px 4px rgba(0,0,0,.8)}10%,59%{background:radial-gradient(circle at 40% 35%,#ff3030,#cc0000);box-shadow:0 0 8px #ef0000,0 0 20px rgba(239,0,0,.6),0 0 40px rgba(239,0,0,.2),inset 0 -2px 4px rgba(0,0,0,.3)}60%,100%{background:#1a1a1a;box-shadow:inset 0 2px 4px rgba(0,0,0,.8)}}
@keyframes f1L2{0%,19%{background:#1a1a1a;box-shadow:inset 0 2px 4px rgba(0,0,0,.8)}20%,59%{background:radial-gradient(circle at 40% 35%,#ff3030,#cc0000);box-shadow:0 0 8px #ef0000,0 0 20px rgba(239,0,0,.6),0 0 40px rgba(239,0,0,.2),inset 0 -2px 4px rgba(0,0,0,.3)}60%,100%{background:#1a1a1a;box-shadow:inset 0 2px 4px rgba(0,0,0,.8)}}
@keyframes f1L3{0%,29%{background:#1a1a1a;box-shadow:inset 0 2px 4px rgba(0,0,0,.8)}30%,59%{background:radial-gradient(circle at 40% 35%,#ff3030,#cc0000);box-shadow:0 0 8px #ef0000,0 0 20px rgba(239,0,0,.6),0 0 40px rgba(239,0,0,.2),inset 0 -2px 4px rgba(0,0,0,.3)}60%,100%{background:#1a1a1a;box-shadow:inset 0 2px 4px rgba(0,0,0,.8)}}
@keyframes f1L4{0%,39%{background:#1a1a1a;box-shadow:inset 0 2px 4px rgba(0,0,0,.8)}40%,59%{background:radial-gradient(circle at 40% 35%,#ff3030,#cc0000);box-shadow:0 0 8px #ef0000,0 0 20px rgba(239,0,0,.6),0 0 40px rgba(239,0,0,.2),inset 0 -2px 4px rgba(0,0,0,.3)}60%,100%{background:#1a1a1a;box-shadow:inset 0 2px 4px rgba(0,0,0,.8)}}
@keyframes f1L5{0%,49%{background:#1a1a1a;box-shadow:inset 0 2px 4px rgba(0,0,0,.8)}50%,59%{background:radial-gradient(circle at 40% 35%,#ff3030,#cc0000);box-shadow:0 0 8px #ef0000,0 0 20px rgba(239,0,0,.6),0 0 40px rgba(239,0,0,.2),inset 0 -2px 4px rgba(0,0,0,.3)}60%,100%{background:#1a1a1a;box-shadow:inset 0 2px 4px rgba(0,0,0,.8)}}
.splash-circuit{font-size:10px;color:rgba(255,255,255,.2);letter-spacing:3px;text-transform:uppercase;font-weight:500;animation:textReveal .7s cubic-bezier(.16,1,.3,1) 1s both;position:relative;z-index:1}
.splash-gp{font-size:14px;color:rgba(255,255,255,.6);font-weight:700;margin-bottom:6px;letter-spacing:.5px;animation:textReveal .7s cubic-bezier(.16,1,.3,1) .25s both;position:relative;z-index:1}
/* Splash car crossing */
.splash-car{position:absolute;bottom:25%;left:-60px;font-size:28px;z-index:2;animation:splashCar 2.5s cubic-bezier(.2,.8,.3,1) 1.8s both;filter:drop-shadow(0 4px 12px rgba(0,0,0,.5))}
@keyframes splashCar{0%{transform:translateX(0) scale(.8);opacity:0}5%{opacity:1;transform:translateX(10vw) scale(.9)}40%{transform:translateX(50vw) scale(1)}100%{transform:translateX(calc(100vw + 60px)) scale(1);opacity:1}}
/* Speed lines behind car */
.splash-speed{position:absolute;width:100%;height:100%;pointer-events:none;overflow:hidden;z-index:1}
.splash-speed span{position:absolute;height:1px;background:linear-gradient(90deg,transparent,rgba(239,0,0,.4),rgba(255,200,0,.2),transparent);animation:speedLine 1.5s linear infinite}
.splash-speed span:nth-child(1){top:28%;width:80px;left:-80px;animation-delay:0s;animation-duration:1.8s}
.splash-speed span:nth-child(2){top:45%;width:120px;left:-120px;animation-delay:.3s;animation-duration:1.2s}
.splash-speed span:nth-child(3){top:62%;width:60px;left:-60px;animation-delay:.7s;animation-duration:2s}
.splash-speed span:nth-child(4){top:38%;width:100px;left:-100px;animation-delay:1.1s;animation-duration:1.4s}
.splash-speed span:nth-child(5){top:72%;width:70px;left:-70px;animation-delay:.5s;animation-duration:1.7s}
@keyframes speedLine{from{transform:translateX(0);opacity:0}10%{opacity:1}90%{opacity:1}to{transform:translateX(calc(100vw + 150px));opacity:0}}

/* â”€â”€ HERO CARD â”€â”€ */
.safe-top{padding-top:calc(var(--safe-top) + 56px)}
.hero{margin:0 16px 16px;border-radius:24px;background:linear-gradient(160deg,#0f1b3d 0%,#1a2d5e 40%,#243b6e 100%);color:#fff;padding:22px;position:relative;overflow:hidden;box-shadow:0 8px 32px rgba(15,27,61,.3),0 2px 8px rgba(0,0,0,.1);animation:heroEntry .7s cubic-bezier(.16,1,.3,1) both}
@keyframes heroEntry{from{opacity:0;transform:translateY(20px) scale(.97)}to{opacity:1;transform:translateY(0) scale(1)}}
.hero::before{content:'';position:absolute;top:-40%;right:-30%;width:80%;height:100%;background:radial-gradient(circle,rgba(99,102,241,.12),transparent 70%);pointer-events:none;animation:heroGlow 6s ease-in-out infinite alternate}
.hero::after{content:'';position:absolute;bottom:-40%;left:-20%;width:60%;height:80%;background:radial-gradient(circle,rgba(215,25,32,.08),transparent 70%);pointer-events:none;animation:heroGlow 6s ease-in-out infinite alternate-reverse}
@keyframes heroGlow{0%{opacity:.5;transform:scale(.9)}100%{opacity:1;transform:scale(1.1)}}
.hero-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:14px;position:relative;z-index:1}
.hero-title{font-size:22px;font-weight:800;letter-spacing:-.5px}
.hero-date{font-size:12px;color:rgba(255,255,255,.45);margin-top:3px;font-weight:500}
.hero-countdown{text-align:right}
.hero-countdown .num{font-size:32px;font-weight:900;background:linear-gradient(135deg,#fbbf24,#f59e0b);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;line-height:1;animation:countPulse 3s ease-in-out infinite}
@keyframes countPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
.hero-countdown .lbl{font-size:10px;color:rgba(255,255,255,.4);text-transform:uppercase;letter-spacing:1.5px;font-weight:600;margin-top:2px}

/* F1 mini banner in hero */
.f1-mini{margin-top:14px;padding:14px 14px 12px;background:rgba(0,0,0,.25);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);border-radius:16px;position:relative;overflow:hidden;border:1px solid rgba(255,255,255,.06)}
/* Carbon fiber texture on F1 */
.f1-mini::before{content:'';position:absolute;inset:0;background:repeating-linear-gradient(45deg,transparent,transparent 1px,rgba(255,255,255,.01) 1px,rgba(255,255,255,.01) 2px);pointer-events:none}
.f1-mini-title{font-size:10px;letter-spacing:2.5px;text-transform:uppercase;color:rgba(255,255,255,.4);margin-bottom:10px;font-weight:700;display:flex;align-items:center;gap:6px;position:relative;z-index:1}
/* F1 lights housing bar */
.f1-lights{display:flex;gap:6px;justify-content:center;margin-bottom:10px;background:rgba(0,0,0,.5);padding:6px 14px;border-radius:14px;border:1px solid rgba(255,255,255,.04);position:relative;z-index:1}
.f1-lights span{width:11px;height:11px;border-radius:50%;background:#1a1a1a;border:1px solid #2a2a2a;box-shadow:inset 0 2px 3px rgba(0,0,0,.8),0 1px 1px rgba(255,255,255,.02)}
.f1-lights span:nth-child(1){animation:f1L1 6s infinite}
.f1-lights span:nth-child(2){animation:f1L2 6s infinite}
.f1-lights span:nth-child(3){animation:f1L3 6s infinite}
.f1-lights span:nth-child(4){animation:f1L4 6s infinite}
.f1-lights span:nth-child(5){animation:f1L5 6s infinite}
/* Track with lane markings */
.f1-track{height:36px;position:relative;border-radius:18px;background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));overflow:hidden;border:1px solid rgba(255,255,255,.06)}
/* Center dashed line */
.f1-track::before{content:'';position:absolute;top:50%;left:0;right:0;height:1px;background:repeating-linear-gradient(90deg,rgba(255,255,255,.08) 0px,rgba(255,255,255,.08) 6px,transparent 6px,transparent 14px);pointer-events:none;transform:translateY(-50%)}
/* Moving shine */
.f1-track::after{content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent 0%,rgba(255,255,255,.04) 30%,rgba(255,255,255,.06) 50%,rgba(255,255,255,.04) 70%,transparent 100%);animation:trackShine 2.5s ease-in-out infinite;pointer-events:none}
@keyframes trackShine{0%{transform:translateX(-120%)}100%{transform:translateX(120%)}}
.f1-car{position:absolute;top:50%;transform:translateY(-50%);font-size:16px;z-index:2;filter:drop-shadow(0 2px 6px rgba(0,0,0,.4))}
/* Car 1 â€” leads, defending */
.f1-car-1{left:52%;animation:carA 5s cubic-bezier(.45,.05,.55,.95) infinite}
/* Car 2 â€” chasing, trying to overtake */
.f1-car-2{left:38%;animation:carB 5s cubic-bezier(.45,.05,.55,.95) infinite}
@keyframes carA{0%{transform:translateY(-50%) translateX(0)}10%{transform:translateY(-50%) translateX(16px)}20%{transform:translateY(-55%) translateX(8px)}35%{transform:translateY(-50%) translateX(-8px)}50%{transform:translateY(-45%) translateX(12px)}65%{transform:translateY(-50%) translateX(-4px)}80%{transform:translateY(-50%) translateX(10px)}100%{transform:translateY(-50%) translateX(0)}}
@keyframes carB{0%{transform:translateY(-50%) translateX(0)}12%{transform:translateY(-45%) translateX(20px)}28%{transform:translateY(-50%) translateX(6px)}42%{transform:translateY(-55%) translateX(22px)}55%{transform:translateY(-50%) translateX(8px)}70%{transform:translateY(-45%) translateX(18px)}85%{transform:translateY(-50%) translateX(4px)}100%{transform:translateY(-50%) translateX(0)}}

/* Route bar */
.route-bar{display:flex;align-items:center;margin-top:16px;gap:0;height:26px;position:relative;z-index:1}
.route-seg{height:5px;border-radius:3px;position:relative;opacity:.9}
.route-seg:first-child{border-radius:3px 0 0 3px}
.route-seg:last-child{border-radius:0 3px 3px 0}
.route-lbl{font-size:9px;color:rgba(255,255,255,.5);text-align:center;margin-top:3px;white-space:nowrap;font-weight:500}
.route-arrow{font-size:9px;color:rgba(255,255,255,.25);margin:0 -1px;z-index:1}

/* City filters */
.filters{display:flex;gap:8px;margin-top:16px;flex-wrap:wrap;position:relative;z-index:1}
.filt-btn{padding:5px 14px;border-radius:20px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:rgba(255,255,255,.6);font-size:12px;font-weight:600;cursor:pointer;transition:all .25s cubic-bezier(.4,0,.2,1);backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px)}
.filt-btn.act{background:#fff;color:#0f172a;border-color:#fff;box-shadow:0 2px 8px rgba(255,255,255,.15)}

/* â”€â”€ SECTIONS â”€â”€ */
.section{margin:0 16px 14px;background:var(--card);border-radius:var(--r);padding:18px;box-shadow:var(--shadow-sm);border:1px solid rgba(0,0,0,.04);animation:sectionIn .5s cubic-bezier(.16,1,.3,1) both}
@keyframes sectionIn{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
.section-title{font-size:13px;font-weight:700;color:var(--text);margin-bottom:14px;display:flex;align-items:center;gap:6px;letter-spacing:-.02em}

/* â”€â”€ CALENDAR â”€â”€ */
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;text-align:center}
.cal-hdr{font-size:10px;color:var(--sub);font-weight:600;padding:6px 0;text-transform:uppercase;letter-spacing:.5px}
.cal-day{aspect-ratio:1;display:flex;flex-direction:column;align-items:center;justify-content:center;border-radius:12px;font-size:13px;font-weight:500;cursor:pointer;position:relative;transition:all .2s cubic-bezier(.4,0,.2,1)}
.cal-day.empty{pointer-events:none}
.cal-day.trip{font-weight:700}
.cal-day.sel{transform:scale(1.12);box-shadow:var(--shadow-md)}
.cal-day .bar{position:absolute;bottom:3px;left:12%;right:12%;height:3px;border-radius:2px}
.cal-day .split-bar{position:absolute;bottom:3px;height:3px;border-radius:2px}
.cal-day .f1-dot{position:absolute;top:3px;right:3px;width:5px;height:5px;background:#ef0000;border-radius:50%;box-shadow:0 0 4px rgba(239,0,0,.4);animation:dotPulse 2s ease-in-out infinite}
@keyframes dotPulse{0%,100%{box-shadow:0 0 4px rgba(239,0,0,.4)}50%{box-shadow:0 0 8px rgba(239,0,0,.6),0 0 12px rgba(239,0,0,.2)}}
.cal-today{box-shadow:inset 0 0 0 2px var(--text)}

/* Calendar legend */
.cal-legend{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px;padding-top:10px;border-top:1px solid rgba(0,0,0,.05)}
.cal-legend-item{display:flex;align-items:center;gap:5px;font-size:10px;color:var(--sub);font-weight:500}
.cal-legend-item span{width:8px;height:8px;border-radius:3px;display:inline-block}

/* â”€â”€ TIMELINE â”€â”€ */
.tl-city-header{display:flex;align-items:center;gap:10px;padding:12px 16px;border-radius:16px;color:#fff;font-weight:700;font-size:14px;margin-bottom:8px;position:relative;overflow:hidden;box-shadow:var(--shadow-md);letter-spacing:-.02em;animation:cityHeaderIn .4s cubic-bezier(.16,1,.3,1) both}
@keyframes cityHeaderIn{from{opacity:0;transform:translateX(-12px)}to{opacity:1;transform:translateX(0)}}
.tl-city-header::before{content:'';position:absolute;top:0;left:-100%;width:60%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.12),transparent);animation:shimmer 4s ease-in-out infinite;pointer-events:none}
@keyframes shimmer{0%,100%{left:-100%}50%{left:150%}}
.tl-city-header::after{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,255,255,.15) 0%,transparent 60%);pointer-events:none}
.tl-city-header .icon{font-size:20px;filter:drop-shadow(0 1px 2px rgba(0,0,0,.2))}
.tl-city-header .add-btn{margin-left:auto;background:rgba(255,255,255,.2);backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px);border:1px solid rgba(255,255,255,.15);color:#fff;width:28px;height:28px;border-radius:50%;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;position:relative;z-index:1}
.tl-city-header .add-btn:active{transform:scale(.9);background:rgba(255,255,255,.35)}
.tl-transit{display:flex;align-items:center;gap:10px;padding:10px 16px;color:var(--sub);font-size:12px;font-weight:600;margin-bottom:8px;margin-top:4px;animation:transitIn .5s cubic-bezier(.16,1,.3,1) both}
@keyframes transitIn{from{opacity:0;transform:scaleX(.7)}to{opacity:1;transform:scaleX(1)}}
.tl-transit-line{flex:1;height:1px;background:linear-gradient(90deg,transparent,#d1d5db,transparent)}
.tl-transit-icon{font-size:18px;animation:trainBounce 2s ease-in-out infinite}
@keyframes trainBounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-2px)}}
.tl-day{background:var(--card);border-radius:16px;padding:14px;margin-bottom:8px;box-shadow:var(--shadow-sm);border:1px solid rgba(0,0,0,.04);border-left:4px solid transparent;position:relative;cursor:pointer;transition:all .2s cubic-bezier(.4,0,.2,1)}
.tl-day:active{transform:scale(.98)}
.tl-day-head{display:flex;align-items:center;gap:10px;margin-bottom:2px}
.tl-day-badge{width:36px;height:36px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:800;color:#fff;flex-shrink:0;box-shadow:0 2px 8px rgba(0,0,0,.15)}
.tl-day-info{flex:1}
.tl-day-label{font-size:14px;font-weight:700;letter-spacing:-.02em}
.tl-day-sub{font-size:11px;color:var(--sub);font-weight:500;margin-top:1px}
.tl-day-f1{display:inline-block;background:linear-gradient(135deg,#ef0000,#dc2626);color:#fff;font-size:9px;font-weight:800;padding:2px 8px;border-radius:6px;margin-left:6px;vertical-align:middle;letter-spacing:.5px;box-shadow:0 1px 4px rgba(239,0,0,.3);animation:f1Pulse 2s ease-in-out infinite}
@keyframes f1Pulse{0%,100%{box-shadow:0 1px 4px rgba(239,0,0,.3)}50%{box-shadow:0 1px 8px rgba(239,0,0,.5),0 0 16px rgba(239,0,0,.15)}}
.tl-events{padding-left:46px;margin-top:8px}
.tl-ev{padding:6px 0;display:flex;align-items:flex-start;gap:8px;font-size:12px;border-bottom:1px solid rgba(0,0,0,.04)}
.tl-ev:last-of-type{border-bottom:none}
.tl-ev-time{color:var(--sub);min-width:40px;font-weight:600;flex-shrink:0;font-size:11px;padding-top:1px}
.tl-ev-title{font-weight:600;letter-spacing:-.01em}
.tl-ev-detail{color:var(--sub);font-size:11px;margin-top:1px}
.tl-ev-del{color:#ef4444;font-size:14px;cursor:pointer;margin-left:auto;padding:2px 6px;flex-shrink:0;opacity:.4;transition:opacity .15s;border-radius:6px}
.tl-ev-del:hover{opacity:1;background:rgba(239,68,68,.08)}
.tl-day.sel-day{box-shadow:var(--shadow-lg);transform:translateY(-2px);border-color:rgba(0,0,0,.08);animation:dayExpand .25s cubic-bezier(.16,1,.3,1)}
@keyframes dayExpand{from{transform:translateY(0);box-shadow:var(--shadow-sm)}to{transform:translateY(-2px);box-shadow:var(--shadow-lg)}}
.tl-add-event{display:flex;align-items:center;gap:6px;padding:8px 12px;margin-top:6px;color:var(--sub);font-size:12px;font-weight:600;cursor:pointer;border-radius:10px;transition:all .2s;border:1px dashed rgba(0,0,0,.1)}
.tl-add-event:hover{background:rgba(0,0,0,.02);border-color:rgba(0,0,0,.15)}

/* â”€â”€ CHECKLIST â”€â”€ */
.ck-toggle{display:flex;align-items:center;justify-content:space-between;cursor:pointer;padding:4px 0}
.ck-toggle .arrow{transition:transform .25s cubic-bezier(.4,0,.2,1);font-size:12px;color:var(--sub)}
.ck-toggle .arrow.open{transform:rotate(90deg)}
.ck-list{margin-top:10px}
.ck-item{display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid rgba(0,0,0,.04);font-size:13px;font-weight:500;transition:opacity .2s}
.ck-item.done{text-decoration:line-through;opacity:.4}
.ck-check{width:22px;height:22px;border-radius:8px;border:2px solid #d1d5db;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;transition:all .2s cubic-bezier(.4,0,.2,1);font-size:12px}
.ck-check.checked{background:linear-gradient(135deg,#10b981,#059669);border-color:transparent;color:#fff;box-shadow:0 2px 6px rgba(16,185,129,.3)}
.ck-progress{height:5px;background:rgba(0,0,0,.06);border-radius:3px;margin-top:10px;overflow:hidden}
.ck-progress-fill{height:100%;background:linear-gradient(90deg,#10b981,#059669);border-radius:3px;transition:width .4s cubic-bezier(.4,0,.2,1)}

/* â”€â”€ EXPENSES â”€â”€ */
.exp-total{font-size:28px;font-weight:900;color:var(--text);margin-bottom:2px;letter-spacing:-.5px}
.exp-sub{font-size:12px;color:var(--sub);margin-bottom:14px;font-weight:500}
.exp-list{max-height:200px;overflow-y:auto}
.exp-item{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid rgba(0,0,0,.04);font-size:13px}
.exp-item-left{display:flex;align-items:center;gap:10px}
.exp-item-icon{width:32px;height:32px;border-radius:10px;background:rgba(0,0,0,.04);display:flex;align-items:center;justify-content:center;font-size:15px}
.exp-item-amount{font-weight:800;letter-spacing:-.02em}
.exp-add-row{display:flex;gap:8px;margin-top:12px}
.exp-add-row input,.exp-add-row select{flex:1;padding:10px 12px;border:1px solid rgba(0,0,0,.08);border-radius:12px;font-size:13px;background:rgba(0,0,0,.02);font-family:inherit;transition:border-color .2s}
.exp-add-row input:focus,.exp-add-row select:focus{outline:none;border-color:var(--text)}
.exp-add-row button{padding:10px 16px;border:none;background:var(--text);color:#fff;border-radius:12px;font-size:13px;font-weight:700;cursor:pointer;transition:all .15s}
.exp-add-row button:active{transform:scale(.95)}

/* â”€â”€ NOTES â”€â”€ */
.notes-area{width:100%;border:1px solid rgba(0,0,0,.08);border-radius:14px;padding:14px;font-size:13px;font-family:inherit;resize:vertical;min-height:80px;background:rgba(0,0,0,.02);transition:border-color .2s;line-height:1.5}
.notes-area:focus{outline:none;border-color:var(--text);background:#fff}

/* â”€â”€ MODAL â”€â”€ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);z-index:1000;display:flex;align-items:flex-end;justify-content:center;animation:fadeIn .25s cubic-bezier(.4,0,.2,1)}
.modal{background:#fff;border-radius:28px 28px 0 0;padding:28px 24px calc(24px + env(safe-area-inset-bottom));width:100%;max-width:500px;max-height:80vh;overflow-y:auto;animation:slideUp .3s cubic-bezier(.16,1,.3,1)}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes slideUp{from{transform:translateY(100%) scale(.95)}to{transform:translateY(0) scale(1)}}
.modal h3{font-size:18px;font-weight:800;margin-bottom:20px;text-align:center;letter-spacing:-.03em}
.modal-field{margin-bottom:16px}
.modal-field label{display:block;font-size:11px;font-weight:700;color:var(--sub);margin-bottom:6px;text-transform:uppercase;letter-spacing:.8px}
.modal-field input,.modal-field select,.modal-field textarea{width:100%;padding:12px 14px;border:1px solid rgba(0,0,0,.08);border-radius:14px;font-size:15px;font-family:inherit;background:rgba(0,0,0,.02);transition:all .2s}
.modal-field input:focus,.modal-field select:focus,.modal-field textarea:focus{outline:none;border-color:var(--text);background:#fff;box-shadow:0 0 0 3px rgba(15,23,42,.06)}
.modal-field textarea{resize:vertical;min-height:60px}
.modal-chips{display:flex;gap:8px;flex-wrap:wrap}
.modal-chip{padding:8px 16px;border-radius:24px;border:1px solid rgba(0,0,0,.08);font-size:13px;font-weight:600;cursor:pointer;transition:all .2s cubic-bezier(.4,0,.2,1);background:#fff}
.modal-chip:active{transform:scale(.95)}
.modal-chip.act{color:#fff;border-color:transparent;box-shadow:0 2px 8px rgba(0,0,0,.15)}
.modal-actions{display:flex;gap:10px;margin-top:22px}
.modal-actions button{flex:1;padding:14px;border-radius:16px;font-size:15px;font-weight:700;cursor:pointer;border:none;transition:all .2s cubic-bezier(.4,0,.2,1);letter-spacing:-.02em}
.modal-actions button:active{transform:scale(.97)}
.btn-primary{background:var(--text);color:#fff;box-shadow:0 2px 8px rgba(15,23,42,.2)}
.btn-secondary{background:rgba(0,0,0,.05);color:var(--text)}
.btn-danger{background:#fef2f2;color:#ef4444;font-weight:700}

/* â”€â”€ FAB â”€â”€ */
.fab{position:fixed;bottom:calc(28px + env(safe-area-inset-bottom));right:20px;width:56px;height:56px;border-radius:18px;background:var(--text);color:#fff;border:none;font-size:24px;cursor:pointer;box-shadow:0 8px 24px rgba(15,23,42,.25),0 2px 8px rgba(0,0,0,.1);z-index:100;display:flex;align-items:center;justify-content:center;transition:all .2s cubic-bezier(.4,0,.2,1);animation:fabEntry .5s cubic-bezier(.16,1,.3,1) .3s both}
@keyframes fabEntry{from{opacity:0;transform:scale(.5) rotate(-90deg)}to{opacity:1;transform:scale(1) rotate(0deg)}}
.fab:active{transform:scale(.9) rotate(-90deg)}

/* â”€â”€ WEATHER ROW â”€â”€ */
.wx-row{display:flex;gap:2px;margin-top:8px}
.wx-cell{flex:1;text-align:center;font-size:9px;color:var(--sub);line-height:1.3;font-weight:500}
</style>
</head>
<body>

<!-- Splash -->
<div id="splash">
  <div class="splash-speed"><span></span><span></span><span></span><span></span><span></span></div>
  <div class="splash-flag"><div></div><div></div><div></div><div></div></div>
  <div class="splash-gp">GP de Barcelona</div>
  <div class="splash-title">Flor & Pato</div>
  <div class="splash-sub">EspaÃ±a 2026</div>
  <div class="splash-lights"><span></span><span></span><span></span><span></span><span></span></div>
  <div class="splash-circuit">Circuit de Barcelona-Catalunya</div>
  <div class="splash-car">ğŸï¸</div>
</div>

<div id="app"></div>

<!-- FAB for adding city -->
<button class="fab" onclick="openAddCity()">+</button>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DATA_VERSION = 5;

const TRIP = [
  {date:"2026-06-05",label:"Viernes 5",city:"Vuelo",color:"#6366f1",icon:"âœˆï¸",events:[{time:"21:45",title:"Vuelo a Madrid",detail:"IB 170 â€” Salida 9:45pm",type:"flight"}]},
  {date:"2026-06-06",label:"SÃ¡bado 6",city:"Madrid",color:"#D71920",icon:"ğŸ°",events:[{time:"",title:"Llegada a Madrid",detail:"Check-in Airbnb",type:"tourism"},{time:"",title:"Puerta del Sol & Plaza Mayor",detail:"Paseo por el centro",type:"tourism"}]},
  {date:"2026-06-07",label:"Domingo 7",city:"Madrid",color:"#D71920",icon:"ğŸ°",events:[{time:"",title:"Museo del Prado",detail:"Reservar entrada anticipada",type:"tourism"},{time:"",title:"Parque del Retiro",detail:"Paseo y Palacio de Cristal",type:"tourism"}]},
  {date:"2026-06-08",label:"Lunes 8",city:"Madrid",color:"#D71920",icon:"ğŸ°",events:[{time:"",title:"Palacio Real",detail:"Tour por la maÃ±ana",type:"tourism"},{time:"",title:"Mercado de San Miguel",detail:"Tapas y vinos",type:"food"}]},
  {date:"2026-06-09",label:"Martes 9",city:"Madrid",color:"#D71920",icon:"âš”ï¸",events:[{time:"",title:"Toledo â€” ExcursiÃ³n",detail:"Day trip desde Madrid",type:"tourism"}]},
  {date:"2026-06-10",label:"MiÃ©rcoles 10",city:"Madrid",color:"#D71920",icon:"ğŸ°",events:[{time:"",title:"DÃ­a libre en Madrid",detail:"Compras, descanso",type:"tourism"}]},
  {date:"2026-06-11",label:"Jueves 11",city:"Barcelona",color:"#004D98",icon:"ğŸš‚",from:"Madrid",fromColor:"#D71920",events:[{time:"",title:"Traslado Madrid â†’ Barcelona",detail:"Tren/aviÃ³n",type:"transport"},{time:"",title:"Airbnb â€” Barcelona",detail:"Check-in",type:"tourism"}]},
  {date:"2026-06-12",label:"Viernes 12",city:"Barcelona",color:"#004D98",icon:"ğŸï¸",events:[{time:"",title:"F1 â€” PrÃ¡ctica Libre",detail:"Circuit de Barcelona-Catalunya",type:"f1"}]},
  {date:"2026-06-13",label:"SÃ¡bado 13",city:"Barcelona",color:"#004D98",icon:"ğŸï¸",events:[{time:"",title:"F1 â€” ClasificaciÃ³n",detail:"Circuit de Barcelona-Catalunya",type:"f1"}]},
  {date:"2026-06-14",label:"Domingo 14",city:"Barcelona",color:"#004D98",icon:"ğŸï¸",events:[{time:"",title:"F1 â€” Carrera",detail:"Circuit de Barcelona-Catalunya",type:"f1"}]},
  {date:"2026-06-15",label:"Lunes 15",city:"Barcelona",color:"#004D98",icon:"ğŸ—ï¸",events:[{time:"",title:"Sagrada Familia",detail:"Visita guiada",type:"tourism"},{time:"",title:"Park GÃ¼ell",detail:"Entrada reservada",type:"tourism"}]},
  {date:"2026-06-16",label:"Martes 16",city:"Barcelona",color:"#004D98",icon:"ğŸ—ï¸",events:[{time:"",title:"Barrio GÃ³tico & La Rambla",detail:"Paseo y shopping",type:"tourism"},{time:"",title:"La Barceloneta",detail:"Playa y mariscos",type:"food"}]},
  {date:"2026-06-17",label:"MiÃ©rcoles 17",city:"Valencia",color:"#FF6B2B",icon:"ğŸš‚",from:"Barcelona",fromColor:"#004D98",events:[{time:"",title:"Traslado Barcelona â†’ Valencia",detail:"Tren",type:"transport"},{time:"",title:"Airbnb â€” Valencia",detail:"Check-in",type:"tourism"}]},
  {date:"2026-06-18",label:"Jueves 18",city:"Valencia",color:"#FF6B2B",icon:"ğŸŠ",events:[{time:"",title:"Ciudad de las Artes y las Ciencias",detail:"OceanogrÃ¡fic + HemisfÃ©ric",type:"tourism"},{time:"",title:"Paella en la playa",detail:"La Malvarrosa",type:"food"}]},
  {date:"2026-06-19",label:"Viernes 19",city:"Madrid",color:"#D71920",icon:"ğŸš‚",from:"Valencia",fromColor:"#FF6B2B",events:[{time:"",title:"Traslado Valencia â†’ Madrid",detail:"Tren",type:"transport"},{time:"",title:"Ãšltima noche en Madrid",detail:"Cena especial",type:"food"}]},
  {date:"2026-06-20",label:"SÃ¡bado 20",city:"Vuelo",color:"#6366f1",icon:"âœˆï¸",events:[{time:"",title:"Vuelo de regreso",detail:"Aeropuerto Barajas",type:"flight"}]}
];

const WX={
  "2026-06-05":"ğŸŒ¤ 22Â°","2026-06-06":"â˜€ï¸ 30Â°","2026-06-07":"â˜€ï¸ 31Â°","2026-06-08":"ğŸŒ¤ 29Â°",
  "2026-06-09":"â˜€ï¸ 32Â°","2026-06-10":"ğŸŒ¤ 28Â°","2026-06-11":"â˜€ï¸ 27Â°","2026-06-12":"â˜€ï¸ 28Â°",
  "2026-06-13":"ğŸŒ¤ 26Â°","2026-06-14":"â˜€ï¸ 29Â°","2026-06-15":"â˜€ï¸ 27Â°","2026-06-16":"ğŸŒ¤ 26Â°",
  "2026-06-17":"â˜€ï¸ 30Â°","2026-06-18":"â˜€ï¸ 31Â°","2026-06-19":"ğŸŒ¤ 29Â°","2026-06-20":"â˜€ï¸ 28Â°"
};

const DEFAULT_CK=[
  {t:"Pasaportes vigentes",d:false},{t:"Seguro de viaje",d:false},{t:"Reservas Airbnb confirmadas",d:false},
  {t:"Entradas F1 compradas",d:false},{t:"Entradas museos reservadas",d:false},{t:"Adaptador de enchufe EU",d:false},
  {t:"Tarjeta sin comisiÃ³n internacional",d:false},{t:"Ropa para 15 dÃ­as",d:false},{t:"Cargadores y power bank",d:false},
  {t:"Descargar mapas offline",d:false},{t:"Billetes tren inter-ciudad",d:false},{t:"Aviso al banco del viaje",d:false}
];

const MAPS={
  "Madrid":"https://maps.google.com/?q=Madrid,Spain",
  "Barcelona":"https://maps.google.com/?q=Barcelona,Spain",
  "Valencia":"https://maps.google.com/?q=Valencia,Spain",
  "Toledo":"https://maps.google.com/?q=Toledo,Spain"
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let S = {
  data: JSON.parse(JSON.stringify(TRIP)),
  sel: null,
  filt: "Todos",
  notes: {},
  ck: null,
  exp: [],
  showCk: false,
  showExp: false,
  modal: null,
  on: false
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function cityIconFor(c) {
  const m = {madrid:"ğŸ°",barcelona:"ğŸ—ï¸",valencia:"ğŸŠ",vuelo:"âœˆï¸"};
  return m[c.toLowerCase()] || "ğŸ“";
}

function getCities() {
  const seen = new Set();
  return S.data.filter(d => { if (d.city==="Vuelo"||seen.has(d.city)) return false; seen.add(d.city); return true; }).map(d=>({name:d.city,color:d.color}));
}

function getFilters() {
  return ["Todos", ...getCities().map(c=>c.name)];
}

function getRoute() {
  const r = [];
  S.data.forEach(d => {
    if (r.length===0 || r[r.length-1].city !== d.city) r.push({city:d.city,color:d.color,days:1,icon:d.icon});
    else r[r.length-1].days++;
  });
  return r;
}

function isF1(d) { return d.events.some(e=>e.type==="f1"); }

function countdown() {
  const now = new Date();
  const trip = new Date("2026-06-05T00:00:00");
  const diff = trip - now;
  if (diff <= 0) return {n:0,l:"Â¡Buen viaje!"};
  const days = Math.ceil(diff / 86400000);
  return {n:days,l:days===1?"dÃ­a":"dÃ­as"};
}

function migrateData(data) {
  data.forEach(d => {
    if (d.city==="Toledo") { d.city="Madrid"; d.color="#D71920"; }
    if (!d.events) d.events=[];
  });
  return data;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIREBASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let dbRef, notesRef, ckRef, expRef;

function initFB() {
  try {
    firebase.initializeApp({
      apiKey:"AIzaSyDPZPk2nsOQ3oRMG7ADhS56zEFyORTE4QQ",
      authDomain:"flor-y-pato-trip.firebaseapp.com",
      databaseURL:"https://flor-y-pato-trip-default-rtdb.firebaseio.com",
      projectId:"flor-y-pato-trip",
      storageBucket:"flor-y-pato-trip.firebasestorage.app",
      messagingSenderId:"862498607498",
      appId:"1:862498607498:web:7e2ccf24cd913e6cb7c5c3"
    });
    const db = firebase.database();
    dbRef = db.ref("trip-espana-2026");
    notesRef = db.ref("trip-notes-2026");
    ckRef = db.ref("trip-checklist-2026");
    expRef = db.ref("trip-expenses-2026");

    dbRef.on("value", snap => {
      const v = snap.val();
      if (v && v._v === DATA_VERSION) {
        S.data = migrateData(v.days);
        S.on = true; R();
      } else {
        dbRef.set({_v:DATA_VERSION,days:S.data});
        S.on = true;
      }
    });
    notesRef.on("value", snap => { S.notes = snap.val()||{}; R(); });
    ckRef.on("value", snap => { S.ck = snap.val()||JSON.parse(JSON.stringify(DEFAULT_CK)); R(); });
    expRef.on("value", snap => { S.exp = snap.val()||[]; R(); });
  } catch(e) { console.log("FB error",e); }
}

function saveTrip() { if(dbRef) dbRef.set({_v:DATA_VERSION,days:S.data}); }
function saveNotes() { if(notesRef) notesRef.set(S.notes); }
function saveCk() { if(ckRef) ckRef.set(S.ck); }
function saveExp() { if(expRef) expRef.set(S.exp); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function R() {
  const cd = countdown();
  const route = getRoute();
  const filters = getFilters();
  const totalDays = S.data.length;

  let routeHTML = route.map((r,i) => {
    const pct = (r.days/totalDays*100).toFixed(1);
    const arrow = i < route.length-1 ? '<span class="route-arrow">â€º</span>' : '';
    return '<div style="width:'+pct+'%;display:flex;flex-direction:column;align-items:center">' +
      '<div class="route-seg" style="background:'+r.color+';width:100%"></div>' +
      '<div class="route-lbl">'+(r.city==="Vuelo"?"âœˆï¸":r.icon)+'</div></div>'+arrow;
  }).join('');

  let filtersHTML = filters.map(f => {
    const act = S.filt===f ? 'act':'';
    return '<button class="filt-btn '+act+'" onclick="flt(\''+f+'\')">'+f+'</button>';
  }).join('');

  let calHTML = buildCalendar();
  let tlHTML = buildTimeline();
  let ckHTML = buildChecklist();
  let expHTML = buildExpenses();
  let notesVal = S.notes.general || '';

  document.getElementById('app').innerHTML =
    '<div class="safe-top"></div>' +
    '<div class="hero">' +
      '<div class="hero-top">' +
        '<div><div class="hero-title">ğŸ‡ªğŸ‡¸ Flor & Pato</div><div class="hero-date">5 â€“ 20 Junio 2026</div></div>' +
        '<div class="hero-countdown"><div class="num">'+cd.n+'</div><div class="lbl">'+cd.l+'</div></div>' +
      '</div>' +
      '<div class="f1-mini">' +
        '<div class="f1-mini-title">ğŸï¸ GP de Barcelona</div>' +
        '<div class="f1-lights"><span></span><span></span><span></span><span></span><span></span></div>' +
        '<div class="f1-track"><div class="f1-car f1-car-1">ğŸï¸</div><div class="f1-car f1-car-2">ğŸï¸</div></div>' +
      '</div>' +
      '<div class="route-bar">'+routeHTML+'</div>' +
      '<div class="filters">'+filtersHTML+'</div>' +
    '</div>' +

    '<div class="section">' +
      '<div class="section-title">ğŸ“… Calendario</div>' +
      calHTML +
    '</div>' +

    '<div class="section" style="background:transparent;box-shadow:none;padding:0">' +
      '<div class="section-title" style="padding:0 4px">ğŸ“‹ Itinerario</div>' +
      tlHTML +
    '</div>' +

    '<div class="section">' +
      '<div class="ck-toggle" onclick="toggleCk()">' +
        '<div class="section-title" style="margin:0">âœ… Checklist <span style="font-weight:400;font-size:12px;color:var(--sub)">('+
          (S.ck?S.ck.filter(function(c){return c.d}).length:0)+'/'+(S.ck?S.ck.length:0)+')</span></div>' +
        '<span class="arrow '+(S.showCk?'open':'')+'">â–¶</span>' +
      '</div>' +
      (S.showCk?ckHTML:'') +
    '</div>' +

    '<div class="section">' +
      '<div class="ck-toggle" onclick="toggleExp()">' +
        '<div class="section-title" style="margin:0">ğŸ’° Gastos</div>' +
        '<span class="arrow '+(S.showExp?'open':'')+'">â–¶</span>' +
      '</div>' +
      (S.showExp?expHTML:'') +
    '</div>' +

    '<div class="section">' +
      '<div class="section-title">ğŸ“ Notas</div>' +
      '<textarea class="notes-area" placeholder="Notas generales del viaje..." onchange="saveNote(this.value)">'+notesVal+'</textarea>' +
    '</div>' +

    '<div style="height:80px"></div>' +
    (S.modal ? renderModal() : '');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CALENDAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildCalendar() {
  var junDays = 30;
  var startDow = new Date(2026,5,1).getDay();
  var adjStart = startDow === 0 ? 6 : startDow - 1;
  var today = new Date().toISOString().slice(0,10);

  var tripMap = {};
  S.data.forEach(function(d) { tripMap[d.date] = d; });

  var html = '<div class="cal-grid">';
  ['L','M','X','J','V','S','D'].forEach(function(d) { html += '<div class="cal-hdr">'+d+'</div>'; });

  for (var i=0;i<adjStart;i++) html += '<div class="cal-day empty"></div>';

  for (var d=1;d<=junDays;d++) {
    var ds = '2026-06-'+String(d).padStart(2,'0');
    var td = tripMap[ds];
    var isToday = ds===today;
    var isSel = S.sel!==null && S.data[S.sel] && S.data[S.sel].date===ds;

    var cls = 'cal-day';
    if (td) cls += ' trip';
    if (isSel) cls += ' sel';
    if (isToday) cls += ' cal-today';

    var bg = '';
    if (isSel && td) bg = 'background:'+td.color+'15;';

    var bar = '';
    if (td) {
      if (td.from) {
        bar = '<div class="split-bar" style="left:10%;width:35%;background:'+td.fromColor+'"></div><div class="split-bar" style="left:55%;width:35%;background:'+td.color+'"></div>';
      } else {
        bar = '<div class="bar" style="background:'+td.color+'"></div>';
      }
    }

    var f1dot = td && isF1(td) ? '<div class="f1-dot"></div>' : '';
    var idx = td ? S.data.indexOf(td) : -1;

    html += '<div class="'+cls+'" style="'+bg+'" onclick="'+(idx>=0?'sel('+idx+')':'')+'">' +
      '<span style="'+(isSel&&td?'color:'+td.color+';font-weight:800':'')+'">'+d+'</span>' +
      bar+f1dot+'</div>';
  }
  html += '</div>';

  // Weather
  html += '<div class="wx-row">';
  for (var i=0;i<adjStart;i++) html += '<div class="wx-cell"></div>';
  for (var d=1;d<=junDays;d++) {
    var ds = '2026-06-'+String(d).padStart(2,'0');
    html += '<div class="wx-cell">'+(WX[ds]||'')+'</div>';
  }
  html += '</div>';

  // Legend
  var cities = getCities();
  html += '<div class="cal-legend">';
  cities.forEach(function(c) { html += '<div class="cal-legend-item"><span style="background:'+c.color+'"></span>'+c.name+'</div>'; });
  html += '<div class="cal-legend-item"><div style="width:8px;height:8px;background:#dc0000;border-radius:50%;display:inline-block"></div>F1</div>';
  html += '</div>';

  return html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TIMELINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildTimeline() {
  var filtered = S.filt==="Todos" ? S.data : S.data.filter(function(d){return d.city===S.filt});
  if (!filtered.length) return '<div style="text-align:center;padding:20px;color:var(--sub);font-size:13px">No hay dÃ­as para este filtro</div>';

  var html = '';
  var lastCity = null;

  filtered.forEach(function(d) {
    var idx = S.data.indexOf(d);
    var isVuelo = d.city==="Vuelo";

    // Transit divider
    if (d.from && S.filt==="Todos") {
      html += '<div class="tl-transit">' +
        '<div class="tl-transit-line"></div><div class="tl-transit-icon">ğŸš‚</div>' +
        '<span>'+d.from+' â†’ '+d.city+'</span>' +
        '<div class="tl-transit-line"></div></div>';
      lastCity = null;
    }

    // City header
    if (!isVuelo && d.city !== lastCity && S.filt==="Todos") {
      html += '<div class="tl-city-header" style="background:'+d.color+'">' +
        '<span class="icon">'+cityIconFor(d.city)+'</span>'+d.city+
        '<button class="add-btn" onclick="event.stopPropagation();openAddDay(\''+d.city+'\',\''+d.color+'\')">+</button></div>';
      lastCity = d.city;
    }

    // Day card
    var isSel = S.sel===idx;
    var dayNum = d.date.split('-')[2].replace(/^0/,'');
    var f1badge = isF1(d) ? '<span class="tl-day-f1">F1</span>' : '';
    var transitTag = d.from ? '<span style="font-size:10px;color:var(--sub)">desde '+d.from+'</span>' : '';

    html += '<div class="tl-day '+(isSel?'sel-day':'')+'" style="border-left-color:'+d.color+'" onclick="sel('+idx+')">' +
      '<div class="tl-day-head">' +
        '<div class="tl-day-badge" style="background:'+d.color+'">'+dayNum+'</div>' +
        '<div class="tl-day-info">' +
          '<div class="tl-day-label">'+d.label+' '+f1badge+'</div>' +
          '<div class="tl-day-sub">'+d.icon+' '+(isVuelo?'Vuelo':d.city)+' '+transitTag+'</div>' +
        '</div>' +
      '</div>';

    // Events (shown if selected)
    if (isSel) {
      html += '<div class="tl-events">';
      d.events.forEach(function(e,ei) {
        html += '<div class="tl-ev">' +
          '<span class="tl-ev-time">'+(e.time||'â€”')+'</span>' +
          '<div><div class="tl-ev-title">'+e.title+'</div><div class="tl-ev-detail">'+(e.detail||'')+'</div></div>' +
          '<span class="tl-ev-del" onclick="event.stopPropagation();del('+idx+','+ei+')">âœ•</span></div>';
      });
      html += '<div class="tl-add-event" onclick="event.stopPropagation();openAddEvent('+idx+')">' +
        '<span>ï¼‹</span> Agregar actividad</div>';
      html += '</div>';
    }
    html += '</div>';
  });

  return html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHECKLIST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildChecklist() {
  if (!S.ck) return '';
  var done = S.ck.filter(function(c){return c.d}).length;
  var pct = S.ck.length ? (done/S.ck.length*100) : 0;

  var html = '<div class="ck-progress"><div class="ck-progress-fill" style="width:'+pct+'%"></div></div>';
  html += '<div class="ck-list">';
  S.ck.forEach(function(c,i) {
    html += '<div class="ck-item '+(c.d?'done':'')+'">' +
      '<div class="ck-check '+(c.d?'checked':'')+'" onclick="toggleCkItem('+i+')">'+(c.d?'âœ“':'')+'</div>' +
      '<span>'+c.t+'</span></div>';
  });
  html += '</div>';
  html += '<div style="margin-top:8px;display:flex;gap:6px">' +
    '<input id="ck-new" placeholder="Nueva tarea..." style="flex:1;padding:8px;border:1px solid #e5e7eb;border-radius:8px;font-size:12px">' +
    '<button onclick="addCkItem()" style="padding:8px 12px;border:none;background:var(--text);color:#fff;border-radius:8px;font-size:12px;cursor:pointer">+</button></div>';
  return html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPENSES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildExpenses() {
  var total = S.exp.reduce(function(s,e){return s+(e.amount||0)},0);
  var catIcons = {comida:"ğŸ½ï¸",transporte:"ğŸš‡",hotel:"ğŸ¨",entradas:"ğŸŸï¸",shopping:"ğŸ›ï¸",otro:"ğŸ“Œ"};

  var html = '<div class="exp-total">â‚¬'+total.toLocaleString('es')+'</div><div class="exp-sub">Total gastado</div>';

  if (S.exp.length) {
    html += '<div class="exp-list">';
    S.exp.forEach(function(e,i) {
      html += '<div class="exp-item">' +
        '<div class="exp-item-left"><div class="exp-item-icon">'+(catIcons[e.cat]||'ğŸ“Œ')+'</div>' +
        '<div><div style="font-weight:600">'+e.desc+'</div><div style="font-size:11px;color:var(--sub)">'+(e.date||'')+'</div></div></div>' +
        '<div class="exp-item-amount">â‚¬'+e.amount+'</div></div>';
    });
    html += '</div>';
  }

  html += '<div class="exp-add-row">' +
    '<input id="exp-desc" placeholder="DescripciÃ³n">' +
    '<input id="exp-amt" type="number" placeholder="â‚¬" style="max-width:70px">' +
    '<select id="exp-cat"><option value="comida">ğŸ½ï¸</option><option value="transporte">ğŸš‡</option>' +
    '<option value="hotel">ğŸ¨</option><option value="entradas">ğŸŸï¸</option>' +
    '<option value="shopping">ğŸ›ï¸</option><option value="otro">ğŸ“Œ</option></select>' +
    '<button onclick="addExp()">+</button></div>';
  return html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderModal() {
  var m = S.modal;
  if (!m) return '';
  var body = '';

  if (m.type === 'addEvent') {
    body = '<h3>Agregar Actividad</h3>' +
      '<div class="modal-field"><label>TÃ­tulo</label><input id="m-title" placeholder="Ej: Visita al museo"></div>' +
      '<div class="modal-field"><label>Hora</label><input id="m-time" type="time"></div>' +
      '<div class="modal-field"><label>Detalle</label><input id="m-detail" placeholder="DescripciÃ³n opcional"></div>' +
      '<div class="modal-actions"><button class="btn-secondary" onclick="closeModal()">Cancelar</button>' +
      '<button class="btn-primary" onclick="saveAddEvent()">Agregar</button></div>';
  }

  if (m.type === 'addDay') {
    var chips = getCities().map(function(c) {
      var isAct = m.city===c.name;
      return '<div class="modal-chip '+(isAct?'act':'')+'" style="'+(isAct?'background:'+c.color+';color:#fff':'')+'" onclick="modalPickCity(\''+c.name+'\',\''+c.color+'\')">'+c.name+'</div>';
    }).join('');
    body = '<h3>Agregar DÃ­a</h3>' +
      '<div class="modal-field"><label>Ciudad</label><div class="modal-chips">'+chips+'</div></div>' +
      '<div class="modal-field"><label>Fecha</label><input id="m-date" type="date" value="'+(m.date||'2026-06-')+'"></div>' +
      '<div class="modal-actions"><button class="btn-secondary" onclick="closeModal()">Cancelar</button>' +
      '<button class="btn-primary" onclick="saveAddDay()">Agregar</button></div>';
  }

  if (m.type === 'addCity') {
    var fromChips = getCities().map(function(c) {
      var isAct = m.from===c.name;
      return '<div class="modal-chip '+(isAct?'act':'')+'" style="'+(isAct?'background:'+c.color+';color:#fff':'')+'" onclick="modalPickFrom(\''+c.name+'\',\''+c.color+'\')">'+c.name+'</div>';
    }).join('');
    body = '<h3>Agregar Ciudad</h3>' +
      '<div class="modal-field"><label>Nombre</label><input id="m-cityname" placeholder="Ej: Sevilla"></div>' +
      '<div class="modal-field"><label>Desde</label><div class="modal-chips">'+fromChips+
      '<div class="modal-chip '+((!m.from)?'act':'')+'" onclick="modalPickFrom(\'\',\'\')">Ninguno</div></div></div>' +
      '<div class="modal-field"><label>Fecha inicio</label><input id="m-cdate" type="date" value="2026-06-"></div>' +
      '<div class="modal-field"><label>Cantidad de dÃ­as</label><input id="m-cdays" type="number" value="2" min="1" max="15"></div>' +
      '<div class="modal-actions"><button class="btn-secondary" onclick="closeModal()">Cancelar</button>' +
      '<button class="btn-primary" onclick="saveAddCity()">Agregar</button></div>';
  }

  if (m.type === 'editDay') {
    var d = S.data[m.idx];
    var editChips = getCities().map(function(c) {
      var isAct = d.city===c.name;
      return '<div class="modal-chip '+(isAct?'act':'')+'" style="'+(isAct?'background:'+c.color+';color:#fff':'')+'" onclick="editDayCity('+m.idx+',\''+c.name+'\',\''+c.color+'\')">'+c.name+'</div>';
    }).join('');
    body = '<h3>Editar DÃ­a</h3>' +
      '<div style="text-align:center;margin-bottom:12px;font-size:13px;color:var(--sub)">'+d.label+' â€” '+d.city+'</div>' +
      '<div class="modal-field"><label>Ciudad</label><div class="modal-chips">'+editChips+'</div></div>' +
      '<div class="modal-actions"><button class="btn-danger" onclick="delDay('+m.idx+')">Eliminar dÃ­a</button>' +
      '<button class="btn-secondary" onclick="closeModal()">Cerrar</button></div>';
  }

  return '<div class="modal-overlay" onclick="closeModal()">' +
    '<div class="modal" onclick="event.stopPropagation()">'+body+'</div></div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function sel(i) { S.sel = S.sel===i ? null : i; R(); }
function flt(f) { S.filt = f; S.sel = null; R(); }

function del(di, ei) {
  if (!confirm('Â¿Eliminar esta actividad?')) return;
  S.data[di].events.splice(ei,1);
  saveTrip(); R();
}

function openAddEvent(idx) { S.modal = {type:'addEvent', idx:idx}; R(); }

function saveAddEvent() {
  var title = document.getElementById('m-title').value.trim();
  if (!title) return;
  var time = document.getElementById('m-time').value || '';
  var detail = document.getElementById('m-detail').value.trim();
  S.data[S.modal.idx].events.push({time:time, title:title, detail:detail, type:'tourism'});
  S.modal = null; saveTrip(); R();
}

function openAddDay(city, color) { S.modal = {type:'addDay', city:city, color:color, date:''}; R(); }
function modalPickCity(name, color) { S.modal.city = name; S.modal.color = color; R(); }

function saveAddDay() {
  var date = document.getElementById('m-date').value;
  if (!date || !S.modal.city) return;
  var dayNum = parseInt(date.split('-')[2]);
  var dayNames = ['Domingo','Lunes','Martes','MiÃ©rcoles','Jueves','Viernes','SÃ¡bado'];
  var dow = new Date(date).getDay();
  var label = dayNames[dow]+' '+dayNum;
  var newDay = {date:date, label:label, city:S.modal.city, color:S.modal.color, icon:cityIconFor(S.modal.city), events:[]};
  var inserted = false;
  for (var i=0;i<S.data.length;i++) {
    if (S.data[i].date > date) { S.data.splice(i,0,newDay); inserted=true; break; }
  }
  if (!inserted) S.data.push(newDay);
  S.modal = null; saveTrip(); R();
}

function openAddCity() { S.modal = {type:'addCity', from:'', fromColor:''}; R(); }
function modalPickFrom(name, color) { S.modal.from = name; S.modal.fromColor = color; R(); }

function saveAddCity() {
  var name = document.getElementById('m-cityname').value.trim();
  var date = document.getElementById('m-cdate').value;
  var days = parseInt(document.getElementById('m-cdays').value) || 1;
  if (!name || !date) return;
  var colors = ['#e11d48','#7c3aed','#0891b2','#059669','#d97706','#be123c','#4f46e5'];
  var color = colors[getCities().length % colors.length];
  var dayNames = ['Domingo','Lunes','Martes','MiÃ©rcoles','Jueves','Viernes','SÃ¡bado'];
  for (var i=0;i<days;i++) {
    var dd = new Date(date);
    dd.setDate(dd.getDate()+i);
    var ds = dd.toISOString().slice(0,10);
    var dow = dd.getDay();
    var dayNum = dd.getDate();
    var label = dayNames[dow]+' '+dayNum;
    var newDay = {date:ds, label:label, city:name, color:color, icon:cityIconFor(name), events:[]};
    if (i===0 && S.modal.from) { newDay.from = S.modal.from; newDay.fromColor = S.modal.fromColor; }
    var inserted = false;
    for (var j=0;j<S.data.length;j++) {
      if (S.data[j].date > ds) { S.data.splice(j,0,newDay); inserted=true; break; }
    }
    if (!inserted) S.data.push(newDay);
  }
  S.modal = null; saveTrip(); R();
}

function editDayCity(idx, city, color) {
  S.data[idx].city = city; S.data[idx].color = color; S.data[idx].icon = cityIconFor(city);
  saveTrip(); R();
}

function openEditDay(idx) { S.modal = {type:'editDay', idx:idx}; R(); }

function delDay(idx) {
  if (!confirm('Â¿Eliminar este dÃ­a completo?')) return;
  S.data.splice(idx, 1); S.modal = null; S.sel = null; saveTrip(); R();
}

function closeModal() { S.modal = null; R(); }

// Checklist
function toggleCk() { S.showCk = !S.showCk; R(); }
function toggleCkItem(i) { S.ck[i].d = !S.ck[i].d; saveCk(); R(); }
function addCkItem() {
  var inp = document.getElementById('ck-new');
  if (!inp || !inp.value.trim()) return;
  S.ck.push({t:inp.value.trim(),d:false}); saveCk(); R();
}

// Expenses
function toggleExp() { S.showExp = !S.showExp; R(); }
function addExp() {
  var desc = document.getElementById('exp-desc');
  var amt = document.getElementById('exp-amt');
  var cat = document.getElementById('exp-cat');
  if (!desc||!desc.value.trim()||!amt||!amt.value) return;
  S.exp.push({desc:desc.value.trim(),amount:parseFloat(amt.value),cat:cat.value,date:new Date().toLocaleDateString('es')});
  saveExp(); R();
}

// Notes
function saveNote(v) { S.notes.general = v; saveNotes(); }

// Long press for edit day
var longTimer;
document.addEventListener('touchstart', function(e) {
  var dayEl = e.target.closest('.tl-day');
  if (!dayEl) return;
  longTimer = setTimeout(function() {
    var match = dayEl.getAttribute('onclick');
    if (match) {
      var m = match.match(/sel\((\d+)\)/);
      if (m) openEditDay(parseInt(m[1]));
    }
  }, 600);
});
document.addEventListener('touchend', function() { clearTimeout(longTimer); });
document.addEventListener('touchmove', function() { clearTimeout(longTimer); });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
initFB();
R();

setTimeout(function() {
  document.getElementById('splash').classList.add('hide');
  setTimeout(function() { document.getElementById('splash').style.display='none'; }, 600);
}, 3000);

setInterval(function() { R(); }, 60000);
</script>
</body>
</html>
